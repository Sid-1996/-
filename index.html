<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sid的鳴潮智慧素材需求計算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .card-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .card-content {
            color: #34495e;
        }
        
        .material-green { color: #27ae60; }
        .material-blue { color: #3498db; }
        .material-purple { color: #9b59b6; }
        .material-gold { color: #f39c12; }
        
        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .slider-track {
            background: linear-gradient(to right, #bdc3c7 0%, #3498db 100%);
            height: 6px;
            border-radius: 3px;
        }
        
        .input-field {
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 10px 15px;
            transition: border-color 0.3s ease;
            background: white;
        }
        
        .input-field:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .status-success {
            color: #27ae60;
            font-weight: 600;
        }
        
        .status-error {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .report-section {
            background: rgba(255, 255, 255, 0.95);
            color: #2c3e50;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header-title {
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header-subtitle {
            color: rgba(255,255,255,0.9);
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold header-title mb-2">🎮 Sid的鳴潮智慧素材需求計算器</h1>
            <p class="header-subtitle">逆向演算法優化 • 智慧合成策略 • 零浪費資源配置</p>
        </div>

        <!-- 第一區塊：設定區域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 角色技能設定 -->
            <div class="card">
                <div class="flex flex-wrap items-center justify-between mb-6">
                    <h2 class="text-2xl card-title flex items-center">
                        ⚔️ 角色技能等級
                    </h2>
                    <div class="flex gap-2 mt-2 sm:mt-0">
                        <button id="skill-level-6" class="btn-secondary text-sm px-3 py-1">
                            6等
                        </button>
                        <button id="skill-level-8" class="btn-secondary text-sm px-3 py-1">
                            8等
                        </button>
                        <button id="skill-level-10" class="btn-secondary text-sm px-3 py-1">
                            10等
                        </button>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="skill-control">
                        <label class="block text-base font-medium card-content mb-3">常態攻擊</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm card-content w-4">1</span>
                            <input type="range" id="skill1" min="1" max="10" value="1" 
                                   class="flex-1 h-3 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content w-6">10</span>
                            <span id="skill1-value" class="text-xl font-bold material-blue w-8 text-center">1</span>
                        </div>
                    </div>
                    <div class="skill-control">
                        <label class="block text-base font-medium card-content mb-3">共鳴技能</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm card-content w-4">1</span>
                            <input type="range" id="skill2" min="1" max="10" value="1" 
                                   class="flex-1 h-3 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content w-6">10</span>
                            <span id="skill2-value" class="text-xl font-bold material-blue w-8 text-center">1</span>
                        </div>
                    </div>
                    <div class="skill-control">
                        <label class="block text-base font-medium card-content mb-3">共鳴解放</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm card-content w-4">1</span>
                            <input type="range" id="skill3" min="1" max="10" value="1" 
                                   class="flex-1 h-3 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content w-6">10</span>
                            <span id="skill3-value" class="text-xl font-bold material-blue w-8 text-center">1</span>
                        </div>
                    </div>
                    <div class="skill-control">
                        <label class="block text-base font-medium card-content mb-3">變奏技能</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm card-content w-4">1</span>
                            <input type="range" id="skill4" min="1" max="10" value="1" 
                                   class="flex-1 h-3 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content w-6">10</span>
                            <span id="skill4-value" class="text-xl font-bold material-blue w-8 text-center">1</span>
                        </div>
                    </div>
                    <div class="skill-control">
                        <label class="block text-base font-medium card-content mb-3">共鳴迴路</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm card-content w-4">1</span>
                            <input type="range" id="skill5" min="1" max="10" value="1" 
                                   class="flex-1 h-3 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content w-6">10</span>
                            <span id="skill5-value" class="text-xl font-bold material-blue w-8 text-center">1</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 武器設定與目標需求 -->
            <div class="space-y-6">
                <!-- 武器等級設定 -->
                <div class="card">
                    <h2 class="text-2xl card-title flex items-center mb-6">
                        🗡️ 武器突破等級
                    </h2>
                    <div class="skill-control">
                        <label class="block text-base font-medium card-content mb-3">武器等級</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm card-content w-4">1</span>
                            <input type="range" id="weapon" min="0" max="6" value="0" step="1"
                                   class="flex-1 h-3 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content w-6">90</span>
                            <span id="weapon-value" class="text-xl font-bold material-purple w-12 text-center">1級</span>
                        </div>
                    </div>
                </div>

                <!-- 目標需求 -->
                <div class="card">
                    <h2 class="text-xl card-title flex items-center mb-4">
                        🎯 目標需求總計
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 rounded-lg p-4 text-center border-2 border-green-200">
                            <div class="text-2xl mb-2">🟢</div>
                            <div class="text-sm card-content font-medium mb-1">綠色素材</div>
                            <div id="target-green" class="text-2xl font-bold material-green">0</div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 text-center border-2 border-blue-200">
                            <div class="text-2xl mb-2">🔵</div>
                            <div class="text-sm card-content font-medium mb-1">藍色素材</div>
                            <div id="target-blue" class="text-2xl font-bold material-blue">0</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 text-center border-2 border-purple-200">
                            <div class="text-2xl mb-2">🟣</div>
                            <div class="text-sm card-content font-medium mb-1">紫色素材</div>
                            <div id="target-purple" class="text-2xl font-bold material-purple">0</div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 text-center border-2 border-yellow-200">
                            <div class="text-2xl mb-2">🟡</div>
                            <div class="text-sm card-content font-medium mb-1">金色素材</div>
                            <div id="target-gold" class="text-2xl font-bold material-gold">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 第二區塊：持有數量輸入 -->
        <div class="card mb-8">
            <h2 class="text-2xl card-title flex items-center mb-6">
                📦 當前持有數量
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="text-center">
                    <div class="bg-green-50 rounded-xl p-4 mb-4 border-2 border-green-200 hover:border-green-300 transition-colors">
                        <span class="text-3xl block mb-2">🟢</span>
                        <p class="text-base font-semibold material-green mb-2">綠色素材</p>
                    </div>
                    <input type="number" id="current-green" value="0" min="0" 
                           class="input-field w-full text-center text-lg font-semibold" placeholder="0">
                </div>
                <div class="text-center">
                    <div class="bg-blue-50 rounded-xl p-4 mb-4 border-2 border-blue-200 hover:border-blue-300 transition-colors">
                        <span class="text-3xl block mb-2">🔵</span>
                        <p class="text-base font-semibold material-blue mb-2">藍色素材</p>
                    </div>
                    <input type="number" id="current-blue" value="0" min="0" 
                           class="input-field w-full text-center text-lg font-semibold" placeholder="0">
                </div>
                <div class="text-center">
                    <div class="bg-purple-50 rounded-xl p-4 mb-4 border-2 border-purple-200 hover:border-purple-300 transition-colors">
                        <span class="text-3xl block mb-2">🟣</span>
                        <p class="text-base font-semibold material-purple mb-2">紫色素材</p>
                    </div>
                    <input type="number" id="current-purple" value="0" min="0" 
                           class="input-field w-full text-center text-lg font-semibold" placeholder="0">
                </div>
                <div class="text-center">
                    <div class="bg-yellow-50 rounded-xl p-4 mb-4 border-2 border-yellow-200 hover:border-yellow-300 transition-colors">
                        <span class="text-3xl block mb-2">🟡</span>
                        <p class="text-base font-semibold material-gold mb-2">金色素材</p>
                    </div>
                    <input type="number" id="current-gold" value="0" min="0" 
                           class="input-field w-full text-center text-lg font-semibold" placeholder="0">
                </div>
            </div>
        </div>

        <!-- 第三區塊：快捷操作按鈕 -->
        <div class="card mb-8">
            <div class="flex flex-wrap gap-4 justify-center">
                <button id="max-cultivation-btn" class="btn-primary text-lg px-8 py-4">
                    🎓 一鍵畢業需求
                </button>
                <button id="reset-default-btn" class="btn-success text-lg px-8 py-4">
                    🎯 重置預設
                </button>
                <button id="reset-all-btn" class="btn-secondary text-lg px-8 py-4">
                    🔄 重置數據
                </button>
                <button id="copy-report-btn" class="btn-warning text-lg px-8 py-4">
                    📋 複製報告
                </button>
            </div>
        </div>

        <!-- 第四區塊：分析結果 -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
            <!-- 狀態分析 -->
            <div class="card">
                <h2 class="text-xl card-title flex items-center mb-6">
                    📊 資源狀態分析
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="text-left py-4 card-content font-semibold text-base">素材</th>
                                <th class="text-center py-4 card-content font-semibold text-base">目標</th>
                                <th class="text-center py-4 card-content font-semibold text-base">持有</th>
                                <th class="text-center py-4 card-content font-semibold text-base">狀態</th>
                            </tr>
                        </thead>
                        <tbody id="status-table">
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-4 card-content text-base">🟢 綠色</td>
                                <td class="text-center py-4 card-content text-base" id="status-target-green">0</td>
                                <td class="text-center py-4 card-content text-base" id="status-current-green">0</td>
                                <td class="text-center py-4 text-base" id="status-green">-</td>
                            </tr>
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-4 card-content text-base">🔵 藍色</td>
                                <td class="text-center py-4 card-content text-base" id="status-target-blue">0</td>
                                <td class="text-center py-4 card-content text-base" id="status-current-blue">0</td>
                                <td class="text-center py-4 text-base" id="status-blue">-</td>
                            </tr>
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-4 card-content text-base">🟣 紫色</td>
                                <td class="text-center py-4 card-content text-base" id="status-target-purple">0</td>
                                <td class="text-center py-4 card-content text-base" id="status-current-purple">0</td>
                                <td class="text-center py-4 text-base" id="status-purple">-</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 card-content text-base">🟡 金色</td>
                                <td class="text-center py-4 card-content text-base" id="status-target-gold">0</td>
                                <td class="text-center py-4 card-content text-base" id="status-current-gold">0</td>
                                <td class="text-center py-4 text-base" id="status-gold">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 最佳合成策略 -->
            <div class="card">
                <h2 class="text-xl card-title flex items-center mb-6">
                    🧠 最佳合成策略
                    <span class="ml-3 px-3 py-1 bg-blue-500 text-white text-sm rounded-full animate-pulse">智慧推薦</span>
                </h2>
                <div id="strategy-display" class="space-y-3">
                    <div class="bg-gray-50 rounded-lg p-4 text-center border-2 border-dashed border-gray-300">
                        <p class="card-content text-base">輸入持有數量後自動顯示最佳策略</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Execution Result Preview -->
        <div class="mt-8">
            <div class="card">
                <h2 class="text-2xl card-title flex items-center">
                    🔄 執行後預覽
                </h2>
                <div id="execution-preview" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-green-50 rounded-lg p-4 text-center border-2 border-green-200">
                        <div class="text-2xl mb-2">🟢</div>
                        <div class="text-sm card-content font-medium">綠色素材</div>
                        <div id="preview-green" class="text-lg font-bold material-green">-</div>
                        <div id="preview-green-status" class="text-xs card-content">-</div>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 text-center border-2 border-blue-200">
                        <div class="text-2xl mb-2">🔵</div>
                        <div class="text-sm card-content font-medium">藍色素材</div>
                        <div id="preview-blue" class="text-lg font-bold material-blue">-</div>
                        <div id="preview-blue-status" class="text-xs card-content">-</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4 text-center border-2 border-purple-200">
                        <div class="text-2xl mb-2">🟣</div>
                        <div class="text-sm card-content font-medium">紫色素材</div>
                        <div id="preview-purple" class="text-lg font-bold material-purple">-</div>
                        <div id="preview-purple-status" class="text-xs card-content">-</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4 text-center border-2 border-yellow-200">
                        <div class="text-2xl mb-2">🟡</div>
                        <div class="text-sm card-content font-medium">金色素材</div>
                        <div id="preview-gold" class="text-lg font-bold material-gold">-</div>
                        <div id="preview-gold-status" class="text-xs card-content">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Section -->
        <div class="mt-8">
            <div class="report-section">
                <h2 class="text-2xl card-title flex items-center">
                    📋 智慧素材需求分析報告
                </h2>
                <div id="report-content" class="bg-gray-50 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap border-2 border-gray-200" style="color: #2c3e50;">
輸入持有數量後自動生成詳細報告...
                </div>
            </div>
        </div>

        <!-- Calculation Process Section -->
        <div class="mt-6">
            <div class="bg-gray-100 rounded-lg p-4 border border-gray-300">
                <details class="cursor-pointer">
                    <summary class="text-sm text-gray-600 font-medium hover:text-gray-800 transition-colors">
                        🔍 計算過程詳情 (點擊展開)
                    </summary>
                    <div class="mt-4 pt-4 border-t border-gray-300">
                        <div id="calculation-process" class="bg-white rounded p-3 font-mono text-xs text-gray-700 whitespace-pre-wrap border">
點擊上方按鈕或輸入數據後顯示詳細計算過程...
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Instructions -->
        <div class="mt-8 card">
            <h3 class="text-lg card-title mb-3">📖 使用說明</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">🎯 設定目標</h4>
                    <ul class="space-y-1 card-content">
                        <li>• 調整角色技能等級（1-10級）</li>
                        <li>• 設定武器突破等級（1-90級）</li>
                        <li>• 系統自動計算所需素材</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">📦 輸入持有量</h4>
                    <ul class="space-y-1 card-content">
                        <li>• 輸入各色素材當前持有數量</li>
                        <li>• 支援四級素材系統</li>
                        <li>• 綠→藍→紫→金 合成路徑</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">🧠 智慧計算</h4>
                    <ul class="space-y-1 card-content">
                        <li>• 輸入素材後自動計算最佳策略</li>
                        <li>• 保證綠色素材不被過度消耗</li>
                        <li>• 最大化資源利用效率</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">📋 報告功能</h4>
                    <ul class="space-y-1 card-content">
                        <li>• 詳細的合成策略說明</li>
                        <li>• 執行前後數量對比</li>
                        <li>• 一鍵複製完整報告</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">⚡ 刷取方式說明</h4>
                    <ul class="space-y-1 card-content">
                        <li>• 常規(40體/場): 標準凝素領域</li>
                        <li>• 安全(40體/場): 含緩衝的保險場次</li>
                        <li>• 活動雙倍(40體/場): 雙倍掉落期間</li>
                        <li>• 減負途徑(80體/場): 2倍素材掉落</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Skill upgrade requirements (level 1->2, 2->3, etc.)
        const skillRequirements = {
            1: {green: 2, blue: 0, purple: 0, gold: 0},
            2: {green: 3, blue: 0, purple: 0, gold: 0},
            3: {green: 0, blue: 2, purple: 0, gold: 0},
            4: {green: 0, blue: 3, purple: 0, gold: 0},
            5: {green: 0, blue: 0, purple: 3, gold: 0},
            6: {green: 0, blue: 0, purple: 5, gold: 0},
            7: {green: 0, blue: 0, purple: 0, gold: 2},
            8: {green: 0, blue: 0, purple: 0, gold: 3},
            9: {green: 0, blue: 0, purple: 0, gold: 6}
        };

        // Weapon breakthrough requirements (cumulative from level 1)
        const weaponRequirements = {
            1: {green: 0, blue: 0, purple: 0, gold: 0},
            40: {green: 6, blue: 0, purple: 0, gold: 0},
            50: {green: 6, blue: 8, purple: 0, gold: 0},
            60: {green: 6, blue: 8, purple: 6, gold: 0},
            70: {green: 6, blue: 8, purple: 6, gold: 8},
            80: {green: 6, blue: 8, purple: 6, gold: 20},
            90: {green: 6, blue: 8, purple: 6, gold: 20}
        };

        // Weapon level mapping for slider
        const weaponLevels = [1, 40, 50, 60, 70, 80, 90];

        // Base talent unlock requirements
        const baseTalentRequirements = {
            green: 0,
            blue: 3,
            purple: 15,
            gold: 12
        };

        // Domain drop rates data
        const domainDropRates = {
            stamina: 40,    // 每場消耗體力
            green: 6.42,    // 平均每場綠色掉落
            blue: 8.00,     // 平均每場藍色掉落
            purple: 1.59,   // 平均每場紫色掉落
            gold: 0.25      // 平均每場金色掉落
        };

        // Verification function for AI self-check
        function verifyRuns(n, requiredGold) {
            const directGold = 0.25 * n;
            const green = 6.42 * n, blue = 8 * n, purple = 1.59 * n;
            const synthBlue = Math.floor(green / 3);
            const synthPurple = Math.floor((blue + synthBlue) / 3);
            const synthGold = Math.floor((purple + synthPurple) / 3);
            return (directGold + synthGold) >= requiredGold;
        }

        // New dynamic domain calculation algorithm
        function calculateDomainRuns(shortageGold, currentMaterials) {
            // 凝素領域固定掉落率
            const DROP_RATES = {
                green: 6.42,
                blue: 8.00,
                purple: 1.59,
                gold: 0.25
            };

            // 計算最小場次（考慮直接掉落+三階合成）
            function calculateMinRuns() {
                let runs = 0;
                while (true) {
                    // 直接獲取
                    const directGold = runs * DROP_RATES.gold;
                    
                    // 合成獲取（完整三階轉換）
                    const synthGold = 
                        Math.floor((
                            (runs * DROP_RATES.purple) + 
                            Math.floor((
                                (runs * DROP_RATES.blue) + 
                                Math.floor((runs * DROP_RATES.green) / 3)
                            ) / 3)
                        ) / 3);
                    
                    if (directGold + synthGold >= shortageGold) {
                        return runs;
                    }
                    runs++;
                }
            }

            // 資源消耗驗證
            function verifyResources(runs) {
                const requiredGreen = Math.ceil(shortageGold / (DROP_RATES.gold + DROP_RATES.green/27));
                return {
                    green: runs * DROP_RATES.green <= currentMaterials.green + requiredGreen,
                    blue: runs * DROP_RATES.blue <= currentMaterials.blue + Math.floor(runs * DROP_RATES.green / 3),
                    purple: runs * DROP_RATES.purple <= currentMaterials.purple + Math.floor(runs * DROP_RATES.blue / 3)
                };
            }

            const minRuns = calculateMinRuns();
            
            // 智能緩衝機制
            let bufferRate = 0.1; // 基礎10%緩衝
            if (shortageGold > 30) {
                bufferRate = 0.15; // 大缺口15%緩衝
            } else if (shortageGold <= 20) {
                bufferRate = 0.08; // 小缺口8%緩衝
            }
            
            const safeRuns = Math.ceil(minRuns * (1 + bufferRate));
            
            // 計算效率指標
            const directGold = minRuns * DROP_RATES.gold;
            const synthGold = Math.floor((
                (minRuns * DROP_RATES.purple) + 
                Math.floor((
                    (minRuns * DROP_RATES.blue) + 
                    Math.floor((minRuns * DROP_RATES.green) / 3)
                ) / 3)
            ) / 3);
            const totalEfficiency = (directGold + synthGold) / minRuns;
            
            return {
                minRuns,
                safeRuns,
                stamina: minRuns * 40,
                resourceCheck: verifyResources(minRuns),
                efficiency: totalEfficiency,
                directGold: directGold,
                synthGold: synthGold,
                totalGold: directGold + synthGold,
                bufferRate: bufferRate
            };
        }

        // Legacy function wrapper for compatibility
        function calculateOptimalDomainRuns(required) {
            // If no gold needed, use simple calculation
            if (required.gold === 0) {
                const greenRuns = required.green > 0 ? Math.ceil(required.green / domainDropRates.green) : 0;
                const blueRuns = required.blue > 0 ? Math.ceil(required.blue / domainDropRates.blue) : 0;
                const purpleRuns = required.purple > 0 ? Math.ceil(required.purple / domainDropRates.purple) : 0;
                const runs = Math.max(greenRuns, blueRuns, purpleRuns);
                
                return {
                    runs: runs,
                    stamina: runs * domainDropRates.stamina,
                    directGold: runs * domainDropRates.gold,
                    synthesisPath: runs > 0 ? "無需金色素材合成" : "無需刷取",
                    totalGold: runs * domainDropRates.gold,
                    synthGold: 0,
                    oldMethodRuns: runs,
                    remaining: {
                        green: Math.max(0, runs * domainDropRates.green - required.green),
                        blue: Math.max(0, runs * domainDropRates.blue - required.blue),
                        purple: Math.max(0, runs * domainDropRates.purple - required.purple)
                    }
                };
            }

            // Use new dynamic algorithm for gold requirements
            const currentMaterials = {
                green: parseInt(document.getElementById('current-green').value) || 0,
                blue: parseInt(document.getElementById('current-blue').value) || 0,
                purple: parseInt(document.getElementById('current-purple').value) || 0,
                gold: parseInt(document.getElementById('current-gold').value) || 0
            };

            const domainResult = calculateDomainRuns(required.gold, currentMaterials);
            
            return {
                runs: domainResult.minRuns,
                safeRuns: domainResult.safeRuns,
                stamina: domainResult.stamina,
                directGold: domainResult.directGold,
                synthGold: domainResult.synthGold,
                totalGold: domainResult.totalGold,
                efficiency: domainResult.efficiency,
                resourceCheck: domainResult.resourceCheck,
                bufferRate: domainResult.bufferRate
            };
        }

        // Initialize sliders and buttons
        function initializeSliders() {
            const sliders = ['skill1', 'skill2', 'skill3', 'skill4', 'skill5'];
            sliders.forEach(id => {
                const slider = document.getElementById(id);
                const valueDisplay = document.getElementById(id + '-value');
                
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value;
                    calculateRequirements();
                });
            });

            // Initialize weapon slider
            const weaponSlider = document.getElementById('weapon');
            const weaponValueDisplay = document.getElementById('weapon-value');
            
            weaponSlider.addEventListener('input', function() {
                const sliderValue = parseInt(this.value);
                const weaponLevel = weaponLevels[sliderValue];
                weaponValueDisplay.textContent = weaponLevel + '級';
                window.currentWeaponLevel = weaponLevel;
                calculateRequirements();
            });

            // Initialize skill level quick buttons
            document.getElementById('skill-level-6').addEventListener('click', function() {
                setAllSkillLevels(6);
            });
            document.getElementById('skill-level-8').addEventListener('click', function() {
                setAllSkillLevels(8);
            });
            document.getElementById('skill-level-10').addEventListener('click', function() {
                setAllSkillLevels(10);
            });

            // Initialize weapon level buttons
            const weaponButtons = document.querySelectorAll('.weapon-level-btn');
            weaponButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const level = parseInt(this.dataset.level);
                    setWeaponLevel(level);
                    
                    // Update button states
                    weaponButtons.forEach(btn => {
                        btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                        btn.classList.add('bg-gray-100', 'border-gray-300');
                    });
                    this.classList.remove('bg-gray-100', 'border-gray-300');
                    this.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                });
            });

            // Initialize current holdings inputs with auto-calculation
            const inputs = ['current-green', 'current-blue', 'current-purple', 'current-gold'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    updateStatusTable();
                    // Auto-trigger calculation after a short delay
                    clearTimeout(window.autoCalculateTimeout);
                    window.autoCalculateTimeout = setTimeout(() => {
                        performCalculation();
                    }, 500);
                });
            });
        }

        // Set all skill levels to a specific value
        function setAllSkillLevels(level) {
            ['skill1', 'skill2', 'skill3', 'skill4', 'skill5'].forEach(id => {
                document.getElementById(id).value = level;
                document.getElementById(id + '-value').textContent = level;
            });
            calculateRequirements();
        }

        // Set weapon level
        function setWeaponLevel(level) {
            const sliderIndex = weaponLevels.indexOf(level);
            if (sliderIndex !== -1) {
                document.getElementById('weapon').value = sliderIndex;
                document.getElementById('weapon-value').textContent = level + '級';
                window.currentWeaponLevel = level;
                calculateRequirements();
            }
        }

        // Calculate total requirements based on current settings
        function calculateRequirements() {
            let totalReq = {
                green: baseTalentRequirements.green,
                blue: baseTalentRequirements.blue,
                purple: baseTalentRequirements.purple,
                gold: baseTalentRequirements.gold
            };

            // Add skill requirements
            for (let i = 1; i <= 5; i++) {
                const level = parseInt(document.getElementById(`skill${i}`).value);
                for (let l = 1; l < level; l++) {
                    if (skillRequirements[l]) {
                        totalReq.green += skillRequirements[l].green;
                        totalReq.blue += skillRequirements[l].blue;
                        totalReq.purple += skillRequirements[l].purple;
                        totalReq.gold += skillRequirements[l].gold;
                    }
                }
            }

            // Add weapon requirements
            const weaponLevel = window.currentWeaponLevel || 1;
            if (weaponRequirements[weaponLevel]) {
                totalReq.green += weaponRequirements[weaponLevel].green;
                totalReq.blue += weaponRequirements[weaponLevel].blue;
                totalReq.purple += weaponRequirements[weaponLevel].purple;
                totalReq.gold += weaponRequirements[weaponLevel].gold;
            }

            // Update display
            document.getElementById('target-green').textContent = totalReq.green;
            document.getElementById('target-blue').textContent = totalReq.blue;
            document.getElementById('target-purple').textContent = totalReq.purple;
            document.getElementById('target-gold').textContent = totalReq.gold;

            updateStatusTable();
            
            // 即時更新合成策略和執行預覽
            performCalculation();
            
            return totalReq;
        }

        // Update status table
        function updateStatusTable() {
            const targets = {
                green: parseInt(document.getElementById('target-green').textContent),
                blue: parseInt(document.getElementById('target-blue').textContent),
                purple: parseInt(document.getElementById('target-purple').textContent),
                gold: parseInt(document.getElementById('target-gold').textContent)
            };

            const current = {
                green: parseInt(document.getElementById('current-green').value) || 0,
                blue: parseInt(document.getElementById('current-blue').value) || 0,
                purple: parseInt(document.getElementById('current-purple').value) || 0,
                gold: parseInt(document.getElementById('current-gold').value) || 0
            };

            const colors = ['green', 'blue', 'purple', 'gold'];
            colors.forEach(color => {
                document.getElementById(`status-target-${color}`).textContent = targets[color];
                document.getElementById(`status-current-${color}`).textContent = current[color];
                
                const diff = current[color] - targets[color];
                const statusEl = document.getElementById(`status-${color}`);
                
                if (diff >= 0) {
                    statusEl.innerHTML = `<span class="status-success">✓ +${diff}</span>`;
                } else {
                    statusEl.innerHTML = `<span class="status-error">✗ ${diff}</span>`;
                }
            });
        }

        // Reverse algorithm calculation
        function calculateOptimalStrategy() {
            const targets = {
                green: parseInt(document.getElementById('target-green').textContent),
                blue: parseInt(document.getElementById('target-blue').textContent),
                purple: parseInt(document.getElementById('target-purple').textContent),
                gold: parseInt(document.getElementById('target-gold').textContent)
            };

            const current = {
                green: parseInt(document.getElementById('current-green').value) || 0,
                blue: parseInt(document.getElementById('current-blue').value) || 0,
                purple: parseInt(document.getElementById('current-purple').value) || 0,
                gold: parseInt(document.getElementById('current-gold').value) || 0
            };

            // Reverse algorithm implementation
            let strategy = [];
            let finalAmounts = {...current};

            // Step 1: Calculate gold deficit and required purple
            const goldDeficit = Math.max(0, targets.gold - current.gold);
            const purpleNeededForGold = goldDeficit * 3;

            // Step 2: Calculate total purple requirement
            const totalPurpleNeeded = targets.purple + purpleNeededForGold;
            const purpleDeficit = Math.max(0, totalPurpleNeeded - current.purple);
            const blueNeededForPurple = purpleDeficit * 3;

            // Step 3: Calculate total blue requirement
            const totalBlueNeeded = targets.blue + blueNeededForPurple;
            const blueDeficit = Math.max(0, totalBlueNeeded - current.blue);
            const greenNeededForBlue = blueDeficit * 3;

            // Step 4: Calculate available green (must preserve target amount)
            const availableGreen = Math.max(0, current.green - targets.green);

            // Step 5: Execute synthesis strategy
            // Green -> Blue synthesis
            const greenToBlueSynthesis = Math.min(Math.floor(availableGreen / 3), blueDeficit);
            if (greenToBlueSynthesis > 0) {
                strategy.push(`綠→藍合成: ${greenToBlueSynthesis} 次 (消耗 ${greenToBlueSynthesis * 3} 綠色 → 獲得 ${greenToBlueSynthesis} 藍色)`);
                finalAmounts.green -= greenToBlueSynthesis * 3;
                finalAmounts.blue += greenToBlueSynthesis;
            }

            // Blue -> Purple synthesis
            const availableBlue = finalAmounts.blue - targets.blue;
            const blueToPurpleSynthesis = Math.min(Math.floor(Math.max(0, availableBlue) / 3), purpleDeficit);
            if (blueToPurpleSynthesis > 0) {
                strategy.push(`藍→紫合成: ${blueToPurpleSynthesis} 次 (消耗 ${blueToPurpleSynthesis * 3} 藍色 → 獲得 ${blueToPurpleSynthesis} 紫色)`);
                finalAmounts.blue -= blueToPurpleSynthesis * 3;
                finalAmounts.purple += blueToPurpleSynthesis;
            }

            // Purple -> Gold synthesis
            const availablePurple = finalAmounts.purple - targets.purple;
            const purpleToGoldSynthesis = Math.min(Math.floor(Math.max(0, availablePurple) / 3), goldDeficit);
            if (purpleToGoldSynthesis > 0) {
                strategy.push(`紫→金合成: ${purpleToGoldSynthesis} 次 (消耗 ${purpleToGoldSynthesis * 3} 紫色 → 獲得 ${purpleToGoldSynthesis} 金色)`);
                finalAmounts.purple -= purpleToGoldSynthesis * 3;
                finalAmounts.gold += purpleToGoldSynthesis;
            }

            return {strategy, finalAmounts, targets, current};
        }

        // Generate calculation process details
        function generateCalculationProcess(calculation) {
            const {strategy, finalAmounts, targets, current} = calculation;
            const now = new Date().toLocaleString('zh-TW');

            let process = `🔍 計算過程詳情\n`;
            process += `計算時間: ${now}\n\n`;

            // 1. 初始狀態
            process += `📊 初始狀態:\n`;
            process += `目標需求: 綠${targets.green} 藍${targets.blue} 紫${targets.purple} 金${targets.gold}\n`;
            process += `當前持有: 綠${current.green} 藍${current.blue} 紫${current.purple} 金${current.gold}\n\n`;

            // 2. 逆向演算法計算過程
            process += `🧮 逆向演算法計算:\n`;
            
            // Step 1: Gold calculation
            const goldDeficit = Math.max(0, targets.gold - current.gold);
            process += `步驟1 - 金色素材分析:\n`;
            process += `  金色缺口 = max(0, ${targets.gold} - ${current.gold}) = ${goldDeficit}\n`;
            
            if (goldDeficit > 0) {
                const purpleNeededForGold = goldDeficit * 3;
                process += `  合成金色需要紫色 = ${goldDeficit} × 3 = ${purpleNeededForGold}\n`;
                
                // Step 2: Purple calculation
                const totalPurpleNeeded = targets.purple + purpleNeededForGold;
                const purpleDeficit = Math.max(0, totalPurpleNeeded - current.purple);
                process += `步驟2 - 紫色素材分析:\n`;
                process += `  紫色總需求 = ${targets.purple} + ${purpleNeededForGold} = ${totalPurpleNeeded}\n`;
                process += `  紫色缺口 = max(0, ${totalPurpleNeeded} - ${current.purple}) = ${purpleDeficit}\n`;
                
                if (purpleDeficit > 0) {
                    const blueNeededForPurple = purpleDeficit * 3;
                    process += `  合成紫色需要藍色 = ${purpleDeficit} × 3 = ${blueNeededForPurple}\n`;
                    
                    // Step 3: Blue calculation
                    const totalBlueNeeded = targets.blue + blueNeededForPurple;
                    const blueDeficit = Math.max(0, totalBlueNeeded - current.blue);
                    process += `步驟3 - 藍色素材分析:\n`;
                    process += `  藍色總需求 = ${targets.blue} + ${blueNeededForPurple} = ${totalBlueNeeded}\n`;
                    process += `  藍色缺口 = max(0, ${totalBlueNeeded} - ${current.blue}) = ${blueDeficit}\n`;
                    
                    if (blueDeficit > 0) {
                        const greenNeededForBlue = blueDeficit * 3;
                        const availableGreen = Math.max(0, current.green - targets.green);
                        process += `步驟4 - 綠色素材分析:\n`;
                        process += `  合成藍色需要綠色 = ${blueDeficit} × 3 = ${greenNeededForBlue}\n`;
                        process += `  可用綠色 = max(0, ${current.green} - ${targets.green}) = ${availableGreen}\n`;
                        process += `  綠色合成能力 = min(${Math.floor(availableGreen / 3)}, ${blueDeficit}) = ${Math.min(Math.floor(availableGreen / 3), blueDeficit)}\n`;
                    }
                }
            } else {
                process += `  無需金色素材，跳過後續計算\n`;
            }

            process += `\n`;

            // 3. 合成執行過程
            if (strategy.length > 0) {
                process += `⚙️ 合成執行過程:\n`;
                let tempAmounts = {...current};
                
                strategy.forEach((step, index) => {
                    process += `執行步驟 ${index + 1}: ${step}\n`;
                    
                    if (step.includes('綠→藍')) {
                        const matches = step.match(/(\d+) 次.*?(\d+) 綠色.*?(\d+) 藍色/);
                        if (matches) {
                            const times = parseInt(matches[1]);
                            const greenUsed = parseInt(matches[2]);
                            const blueGained = parseInt(matches[3]);
                            tempAmounts.green -= greenUsed;
                            tempAmounts.blue += blueGained;
                            process += `  執行後: 綠${tempAmounts.green} 藍${tempAmounts.blue}\n`;
                        }
                    } else if (step.includes('藍→紫')) {
                        const matches = step.match(/(\d+) 次.*?(\d+) 藍色.*?(\d+) 紫色/);
                        if (matches) {
                            const times = parseInt(matches[1]);
                            const blueUsed = parseInt(matches[2]);
                            const purpleGained = parseInt(matches[3]);
                            tempAmounts.blue -= blueUsed;
                            tempAmounts.purple += purpleGained;
                            process += `  執行後: 藍${tempAmounts.blue} 紫${tempAmounts.purple}\n`;
                        }
                    } else if (step.includes('紫→金')) {
                        const matches = step.match(/(\d+) 次.*?(\d+) 紫色.*?(\d+) 金色/);
                        if (matches) {
                            const times = parseInt(matches[1]);
                            const purpleUsed = parseInt(matches[2]);
                            const goldGained = parseInt(matches[3]);
                            tempAmounts.purple -= purpleUsed;
                            tempAmounts.gold += goldGained;
                            process += `  執行後: 紫${tempAmounts.purple} 金${tempAmounts.gold}\n`;
                        }
                    }
                });
            } else {
                process += `⚙️ 無需執行合成操作\n`;
            }

            process += `\n`;

            // 4. 最終結果驗證
            process += `✅ 最終結果驗證:\n`;
            process += `合成後持有: 綠${Math.floor(finalAmounts.green)} 藍${Math.floor(finalAmounts.blue)} 紫${Math.floor(finalAmounts.purple)} 金${Math.floor(finalAmounts.gold)}\n`;
            process += `目標需求: 綠${targets.green} 藍${targets.blue} 紫${targets.purple} 金${targets.gold}\n`;
            
            const finalShortages = {
                green: Math.max(0, targets.green - finalAmounts.green),
                blue: Math.max(0, targets.blue - finalAmounts.blue),
                purple: Math.max(0, targets.purple - finalAmounts.purple),
                gold: Math.max(0, targets.gold - finalAmounts.gold)
            };
            
            process += `剩餘缺口: 綠${finalShortages.green} 藍${finalShortages.blue} 紫${finalShortages.purple} 金${finalShortages.gold}\n`;

            return process;
        }

        // Generate simplified report
        function generateReport(calculation) {
            const {strategy, finalAmounts, targets, current} = calculation;
            const now = new Date().toLocaleString('zh-TW');

            // 計算素材缺口（在報告開始就計算）
            const shortages = {
                green: Math.max(0, targets.green - finalAmounts.green),
                blue: Math.max(0, targets.blue - finalAmounts.blue),
                purple: Math.max(0, targets.purple - finalAmounts.purple),
                gold: Math.max(0, targets.gold - finalAmounts.gold)
            };

            let report = `🎯 素材需求分析報告\n`;
            report += `生成時間: ${now}\n\n`;

            // 1. 資源狀態 - 簡化顯示
            report += `📊 資源狀態\n`;
            const colors = [
                {name: '🟢綠', key: 'green'},
                {name: '🔵藍', key: 'blue'}, 
                {name: '🟣紫', key: 'purple'},
                {name: '🟡金', key: 'gold'}
            ];

            let statusLine = '';
            colors.forEach(({name, key}) => {
                const diff = current[key] - targets[key];
                if (diff >= 0) {
                    statusLine += `${name}✓ `;
                } else {
                    statusLine += `${name}缺${Math.abs(diff)} `;
                }
            });
            report += statusLine + '\n\n';

            // 2. 合成策略 - 簡化顯示
            if (strategy.length === 0) {
                // 檢查是否有任何素材缺口
                const hasAnyShortage = Object.values(shortages).some(shortage => shortage > 0);
                if (hasAnyShortage) {
                    report += `🔄 無需合成\n\n`;
                } else {
                    report += `✅ 無需合成，資源已足夠\n\n`;
                }
            } else {
                report += `🔄 合成策略\n`;
                strategy.forEach((step, index) => {
                    if (step.includes('綠→藍')) {
                        const matches = step.match(/(\d+) 綠色.*?(\d+) 藍色/);
                        if (matches) report += `• 用${matches[1]}綠 → 得${matches[2]}藍\n`;
                    } else if (step.includes('藍→紫')) {
                        const matches = step.match(/(\d+) 藍色.*?(\d+) 紫色/);
                        if (matches) report += `• 用${matches[1]}藍 → 得${matches[2]}紫\n`;
                    } else if (step.includes('紫→金')) {
                        const matches = step.match(/(\d+) 紫色.*?(\d+) 金色/);
                        if (matches) report += `• 用${matches[1]}紫 → 得${matches[2]}金\n`;
                    }
                });
                report += '\n';
            }

            // 3. 凝素領域建議 - 包含減負途徑和活動建議
            if (shortages.gold === 0 && shortages.purple === 0 && shortages.blue === 0 && shortages.green === 0) {
                report += `🎉 完美！無需刷取凝素領域\n`;
            } else {
                report += `⚡ 凝素領域建議\n`;
                
                if (shortages.gold > 0) {
                    const domainResult = calculateDomainRuns(shortages.gold, current);
                    report += `缺口: ${shortages.gold}金\n`;
                    
                    // 計算活動雙倍掉落建議
                    const doubleDropRuns = Math.ceil(domainResult.minRuns / 2);
                    const dailyLimit = 3;
                    const doubleDropDays = Math.ceil(doubleDropRuns / dailyLimit);
                    
                    // 計算減負途徑建議
                    const reducedRuns = Math.ceil(domainResult.minRuns / 2);
                    
                    report += `\n📋 刷取方案:\n`;
                    report += `• 常規(40體/場): ${domainResult.minRuns}場 (${domainResult.minRuns * 40}體力) - 理論最少場次\n`;
                    report += `• 安全(40體/場): ${domainResult.safeRuns}場 (${domainResult.safeRuns * 40}體力) - 含緩衝保險\n`;
                    
                    if (doubleDropRuns <= dailyLimit) {
                        report += `• 活動雙倍(40體/場): ${doubleDropRuns}場 (${doubleDropRuns * 40}體力) - 1天內完成\n`;
                    } else {
                        const remainingRuns = domainResult.minRuns - (dailyLimit * 2 * doubleDropDays);
                        if (remainingRuns > 0) {
                            report += `• 活動雙倍(40體/場): ${dailyLimit}場×${doubleDropDays}天 + 常規${remainingRuns}場\n`;
                            report += `  總計: ${(dailyLimit * doubleDropDays * 40) + (remainingRuns * 40)}體力\n`;
                        } else {
                            report += `• 活動雙倍(40體/場): ${dailyLimit}場×${doubleDropDays}天 (${dailyLimit * doubleDropDays * 40}體力)\n`;
                        }
                    }
                    
                    report += `• 減負途徑(80體/場): ${reducedRuns}場 (${reducedRuns * 80}體力) - 2倍素材掉落\n`;
                    
                } else if (shortages.purple > 0) {
                    const runs = Math.ceil(shortages.purple / 1.59);
                    const doubleRuns = Math.ceil(runs / 2);
                    const reducedRuns = Math.ceil(runs / 2);
                    
                    report += `缺口: ${shortages.purple}紫\n`;
                    report += `• 常規(40體/場): ${runs}場 (${runs * 40}體力)\n`;
                    report += `• 活動雙倍(40體/場): ${doubleRuns}場 (${doubleRuns * 40}體力)\n`;
                    report += `• 減負途徑(80體/場): ${reducedRuns}場 (${reducedRuns * 80}體力)\n`;
                    
                } else if (shortages.blue > 0) {
                    const runs = Math.ceil(shortages.blue / 8.00);
                    const doubleRuns = Math.ceil(runs / 2);
                    const reducedRuns = Math.ceil(runs / 2);
                    
                    report += `缺口: ${shortages.blue}藍\n`;
                    report += `• 常規(40體/場): ${runs}場 (${runs * 40}體力)\n`;
                    report += `• 活動雙倍(40體/場): ${doubleRuns}場 (${doubleRuns * 40}體力)\n`;
                    report += `• 減負途徑(80體/場): ${reducedRuns}場 (${reducedRuns * 80}體力)\n`;
                    
                } else if (shortages.green > 0) {
                    const runs = Math.ceil(shortages.green / 6.42);
                    const doubleRuns = Math.ceil(runs / 2);
                    const reducedRuns = Math.ceil(runs / 2);
                    
                    report += `缺口: ${shortages.green}綠\n`;
                    report += `• 常規(40體/場): ${runs}場 (${runs * 40}體力)\n`;
                    report += `• 活動雙倍(40體/場): ${doubleRuns}場 (${doubleRuns * 40}體力)\n`;
                    report += `• 減負途徑(80體/場): ${reducedRuns}場 (${reducedRuns * 80}體力)\n`;
                }
            }

            return report;
        }

        // Update execution preview - only shows synthesis results, not domain farming
        function updateExecutionPreview(calculation) {
            const {current, targets} = calculation;
            
            // Simulate only the synthesis strategy execution
            let simulatedAmounts = {...current};
            
            // Execute the same synthesis logic as in calculateOptimalStrategy
            const goldDeficit = Math.max(0, targets.gold - current.gold);
            const purpleNeededForGold = goldDeficit * 3;
            const totalPurpleNeeded = targets.purple + purpleNeededForGold;
            const purpleDeficit = Math.max(0, totalPurpleNeeded - current.purple);
            const blueNeededForPurple = purpleDeficit * 3;
            const totalBlueNeeded = targets.blue + blueNeededForPurple;
            const blueDeficit = Math.max(0, totalBlueNeeded - current.blue);
            const availableGreen = Math.max(0, current.green - targets.green);

            // Green -> Blue synthesis
            const greenToBlueSynthesis = Math.min(Math.floor(availableGreen / 3), blueDeficit);
            if (greenToBlueSynthesis > 0) {
                simulatedAmounts.green -= greenToBlueSynthesis * 3;
                simulatedAmounts.blue += greenToBlueSynthesis;
            }

            // Blue -> Purple synthesis
            const availableBlue = simulatedAmounts.blue - targets.blue;
            const blueToPurpleSynthesis = Math.min(Math.floor(Math.max(0, availableBlue) / 3), purpleDeficit);
            if (blueToPurpleSynthesis > 0) {
                simulatedAmounts.blue -= blueToPurpleSynthesis * 3;
                simulatedAmounts.purple += blueToPurpleSynthesis;
            }

            // Purple -> Gold synthesis
            const availablePurple = simulatedAmounts.purple - targets.purple;
            const purpleToGoldSynthesis = Math.min(Math.floor(Math.max(0, availablePurple) / 3), goldDeficit);
            if (purpleToGoldSynthesis > 0) {
                simulatedAmounts.purple -= purpleToGoldSynthesis * 3;
                simulatedAmounts.gold += purpleToGoldSynthesis;
            }
            
            // Update display with synthesis-only results
            const colors = ['green', 'blue', 'purple', 'gold'];
            colors.forEach(color => {
                const final = Math.floor(simulatedAmounts[color]);
                const target = targets[color];
                const diff = final - target;
                
                document.getElementById(`preview-${color}`).textContent = final + ' 個';
                
                if (diff >= 0) {
                    document.getElementById(`preview-${color}-status`).textContent = `✓ 達標 +${diff}`;
                    document.getElementById(`preview-${color}-status`).className = 'text-xs opacity-90 text-green-600';
                } else {
                    document.getElementById(`preview-${color}-status`).textContent = `✗ 不足 ${Math.abs(diff)}`;
                    document.getElementById(`preview-${color}-status`).className = 'text-xs opacity-90 text-red-600';
                }
            });
        }

        // Perform calculation function (used by both auto-calculation and manual trigger)
        function performCalculation() {
            // 檢查是否有持有數量輸入，避免在初始化時顯示錯誤信息
            const hasInput = ['current-green', 'current-blue', 'current-purple', 'current-gold']
                .some(id => parseInt(document.getElementById(id).value) > 0);
            
            if (!hasInput) {
                // 如果沒有輸入持有數量，顯示提示信息
                document.getElementById('strategy-display').innerHTML = '<p class="text-gray-500">輸入持有數量後自動顯示最佳策略</p>';
                document.getElementById('report-content').textContent = '輸入持有數量後自動生成詳細報告...';
                
                // 重置執行預覽
                ['green', 'blue', 'purple', 'gold'].forEach(color => {
                    document.getElementById(`preview-${color}`).textContent = '-';
                    document.getElementById(`preview-${color}-status`).textContent = '-';
                    document.getElementById(`preview-${color}-status`).className = 'text-xs card-content';
                });
                return;
            }

            const calculation = calculateOptimalStrategy();
            const {strategy, current, targets} = calculation;

            // 檢查是否有嚴重素材不足的情況
            const shortages = {
                green: Math.max(0, targets.green - current.green),
                blue: Math.max(0, targets.blue - current.blue),
                purple: Math.max(0, targets.purple - current.purple),
                gold: Math.max(0, targets.gold - current.gold)
            };

            const hasSignificantShortage = shortages.gold > 10 || shortages.purple > 10 || 
                                         shortages.blue > 10 || shortages.green > 10;

            // Update strategy display
            const strategyDisplay = document.getElementById('strategy-display');
            
            // 檢查是否有任何素材不足（不只是嚴重不足）
            const hasAnyShortage = shortages.gold > 0 || shortages.purple > 0 || 
                                  shortages.blue > 0 || shortages.green > 0;

            if (strategy.length === 0) {
                strategyDisplay.innerHTML = '<p class="text-green-600 font-semibold">🎉 無需合成，當前資源已經最優配置！</p>';
            } else {
                strategyDisplay.innerHTML = strategy.map(step => 
                    `<div class="bg-blue-50 p-2 rounded border-l-4 border-blue-400">${step}</div>`
                ).join('');
            }

            // Update execution preview
            updateExecutionPreview(calculation);

            // Generate and display report
            const report = generateReport(calculation);
            document.getElementById('report-content').textContent = report;

            // Generate and display calculation process
            const process = generateCalculationProcess(calculation);
            document.getElementById('calculation-process').textContent = process;
        }

        // Event listeners
        document.getElementById('max-cultivation-btn').addEventListener('click', function() {
            this.classList.add('pulse-animation');
            setTimeout(() => this.classList.remove('pulse-animation'), 1000);

            // Set all skills to maximum level
            setAllSkillLevels(10);
            
            // Set weapon to maximum level
            setWeaponLevel(90);
            
            // Update weapon button state
            const weaponButtons = document.querySelectorAll('.weapon-level-btn');
            weaponButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-gray-100', 'border-gray-300');
            });
            const maxWeaponBtn = document.querySelector('[data-level="90"]');
            if (maxWeaponBtn) {
                maxWeaponBtn.classList.remove('bg-gray-100', 'border-gray-300');
                maxWeaponBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }
            
            // Recalculate requirements and perform calculation
            calculateRequirements();
            performCalculation();
        });

        document.getElementById('reset-default-btn').addEventListener('click', function() {
            // Reset to character + weapon full requirements
            setAllSkillLevels(10);
            setWeaponLevel(90);
            
            // Update weapon button state
            const weaponButtons = document.querySelectorAll('.weapon-level-btn');
            weaponButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-gray-100', 'border-gray-300');
            });
            const maxWeaponBtn = document.querySelector('[data-level="90"]');
            if (maxWeaponBtn) {
                maxWeaponBtn.classList.remove('bg-gray-100', 'border-gray-300');
                maxWeaponBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }
            
            calculateRequirements();
        });

        document.getElementById('reset-all-btn').addEventListener('click', function() {
            // Reset everything to initial state
            setAllSkillLevels(1);
            setWeaponLevel(1);
            
            // Update weapon button state
            const weaponButtons = document.querySelectorAll('.weapon-level-btn');
            weaponButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-gray-100', 'border-gray-300');
            });
            const firstWeaponBtn = document.querySelector('[data-level="1"]');
            if (firstWeaponBtn) {
                firstWeaponBtn.classList.remove('bg-gray-100', 'border-gray-300');
                firstWeaponBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }
            
            ['current-green', 'current-blue', 'current-purple', 'current-gold'].forEach(id => {
                document.getElementById(id).value = 0;
            });

            document.getElementById('strategy-display').innerHTML = '<p class="text-gray-500">輸入持有數量後自動顯示最佳策略</p>';
            document.getElementById('report-content').textContent = '輸入持有數量後自動生成詳細報告...';
            
            // Reset execution preview
            ['green', 'blue', 'purple', 'gold'].forEach(color => {
                document.getElementById(`preview-${color}`).textContent = '-';
                document.getElementById(`preview-${color}-status`).textContent = '-';
            });
            
            calculateRequirements();
        });

        document.getElementById('copy-report-btn').addEventListener('click', async function() {
            const reportContent = document.getElementById('report-content').textContent;
            
            try {
                await navigator.clipboard.writeText(reportContent);
                
                const originalText = this.textContent;
                this.textContent = '✅ 已複製！';
                this.classList.add('pulse-animation');
                
                setTimeout(() => {
                    this.textContent = originalText;
                    this.classList.remove('pulse-animation');
                }, 2000);
            } catch (err) {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = reportContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const originalText = this.textContent;
                this.textContent = '✅ 已複製！';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
            }
        });

        // Initialize the application
        window.currentWeaponLevel = 1;
        initializeSliders();
        calculateRequirements();
        
        // Set initial weapon button state
        const firstWeaponBtn = document.querySelector('[data-level="1"]');
        if (firstWeaponBtn) {
            firstWeaponBtn.classList.remove('bg-gray-100', 'border-gray-300');
            firstWeaponBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'971e47cb512c5701',t:'MTc1NTY1NTA1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
