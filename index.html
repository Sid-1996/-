<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧素材需求計算器</title>
    <style>
        /* 在這裡添加 CSS 樣式 */
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: white;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .title {
            text-align: center;
            color: navy;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .section {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .input-group {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }
        .input-group label {
            width: 80px;
            text-align: right;
            margin-right: 10px;
        }
        .input-group input {
            width: 80px;
            padding: 5px;
        }
        .button {
            padding: 8px 15px;
            margin-right: 10px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .green { color: green; }
        .blue { color: blue; }
        .purple { color: purple; }
        .gold { color: gold; }
        .red { color: red; }
        .gray { color: gray; }
    </style>
</head>
<body>
    <div class="title">🎮 智慧素材需求計算器 🎮</div>
    
    <!-- 目標需求設定區域 -->
    <div class="section">
        <div class="section-title">目標需求設定</div>
        <div class="input-group">
            <label for="target-green">綠色素材:</label>
            <input type="number" id="target-green" value="31" min="0">
            <label for="target-blue">藍色素材:</label>
            <input type="number" id="target-blue" value="36" min="0">
            <label for="target-purple">紫色素材:</label>
            <input type="number" id="target-purple" value="61" min="0">
            <label for="target-gold">金色素材:</label>
            <input type="number" id="target-gold" value="87" min="0">
        </div>
        <button class="button" id="set-target">設定</button>
        <button class="button" id="reset-target">重置</button>
    </div>
    
    <!-- 當前持有數量 -->
    <div class="section">
        <div class="section-title">當前持有數量</div>
        <div class="input-group">
            <label for="current-green">綠色:</label>
            <input type="number" id="current-green" value="0" min="0">
            <label for="current-blue">藍色:</label>
            <input type="number" id="current-blue" value="0" min="0">
            <label for="current-purple">紫色:</label>
            <input type="number" id="current-purple" value="0" min="0">
            <label for="current-gold">金色:</label>
            <input type="number" id="current-gold" value="0" min="0">
        </div>
    </div>
    
    <!-- 當前狀態分析 -->
    <div class="section">
        <div class="section-title">當前狀態分析</div>
        <table>
            <thead>
                <tr>
                    <th>顏色</th>
                    <th>目標</th>
                    <th>持有</th>
                    <th>還缺</th>
                    <th>基本需求</th>
                    <th>可向上合成</th>
                    <th>溢出數量</th>
                </tr>
            </thead>
            <tbody id="status-analysis">
                <!-- 這裡會由 JavaScript 動態生成 -->
            </tbody>
        </table>
    </div>
    
    <!-- 智慧合成優化分析 -->
    <div class="section">
        <div class="section-title">🧠 智慧模擬合成分析(保留需求數量，將溢出的向上模擬合成)</div>
        <table>
            <thead>
                <tr>
                    <th>顏色</th>
                    <th>模擬合成後數量</th>
                    <th>實際還缺</th>
                    <th>模擬合成次數</th>
                    <th>最終刷取建議</th>
                </tr>
            </thead>
            <tbody id="optimized-analysis">
                <!-- 這裡會由 JavaScript 動態生成 -->
            </tbody>
        </table>
    </div>
    
    <!-- 按鈕區域 -->
    <div>
        <button class="button" id="reset">重置</button>
        <button class="button" id="copy">複製完整分析</button>
        <button class="button" id="calculate">重新分析</button>
        <button class="button" id="about">說明</button>
    </div>
    
    <script>
        // 這裡添加 JavaScript 代碼
        const config = {
            defaultRequirements: {
                green: 31,
                blue: 36,
                purple: 61,
                gold: 87
            },
            requirements: {
                green: 31,
                blue: 36,
                purple: 61,
                gold: 87
            },
            colors: {
                green: "綠",
                blue: "藍",
                purple: "紫",
                gold: "金"
            },
            colorOrder: ["green", "blue", "purple", "gold"]
        };
        
        // DOM 元素
        const elements = {
            targets: {
                green: document.getElementById("target-green"),
                blue: document.getElementById("target-blue"),
                purple: document.getElementById("target-purple"),
                gold: document.getElementById("target-gold")
            },
            currents: {
                green: document.getElementById("current-green"),
                blue: document.getElementById("current-blue"),
                purple: document.getElementById("current-purple"),
                gold: document.getElementById("current-gold")
            },
            statusTable: document.getElementById("status-analysis"),
            optimizedTable: document.getElementById("optimized-analysis"),
            buttons: {
                setTarget: document.getElementById("set-target"),
                resetTarget: document.getElementById("reset-target"),
                reset: document.getElementById("reset"),
                copy: document.getElementById("copy"),
                calculate: document.getElementById("calculate"),
                about: document.getElementById("about")
            }
        };
        
        // 初始化
        function init() {
            // 綁定事件
            elements.buttons.setTarget.addEventListener("click", setTargetRequirements);
            elements.buttons.resetTarget.addEventListener("click", resetTargetToDefault);
            elements.buttons.reset.addEventListener("click", resetAll);
            elements.buttons.copy.addEventListener("click", copyResults);
            elements.buttons.calculate.addEventListener("click", updateCalculation);
            elements.buttons.about.addEventListener("click", showAbout);
            
            // 綁定輸入變化事件
            for (const color of config.colorOrder) {
                elements.currents[color].addEventListener("change", updateCalculation);
            }
            
            // 初始計算
            updateCalculation();
        }
        
        // 設定目標需求
        function setTargetRequirements() {
            for (const color of config.colorOrder) {
                const value = parseInt(elements.targets[color].value) || 0;
                config.requirements[color] = value;
            }
            updateCalculation();
        }
        
        // 重置目標需求
        function resetTargetToDefault() {
            for (const color of config.colorOrder) {
                config.requirements[color] = config.defaultRequirements[color];
                elements.targets[color].value = config.defaultRequirements[color];
            }
            updateCalculation();
        }
        
        // 重置所有
        function resetAll() {
            for (const color of config.colorOrder) {
                elements.currents[color].value = 0;
            }
            updateCalculation();
        }
        
        // 更新計算
        function updateCalculation() {
            const current = {};
            for (const color of config.colorOrder) {
                current[color] = parseInt(elements.currents[color].value) || 0;
            }
            
            updateCurrentStatus(current);
            performSmartOptimization(current);
        }
        
        // 更新當前狀態
        function updateCurrentStatus(current) {
            let html = "";
            
            for (const color of config.colorOrder) {
                const need = config.requirements[color];
                const have = current[color];
                const missing = Math.max(0, need - have);
                const excess = Math.max(0, have - need);
                const canMake = color !== "gold" ? Math.floor(have / 3) : 0;
                
                html += `
                <tr>
                    <td class="${color}">${getColorIcon(color)}${config.colors[color]}</td>
                    <td>${need}</td>
                    <td>${have}</td>
                    <td class="${missing > 0 ? "red" : "green"}">${missing}</td>
                    <td class="${missing > 0 ? "red" : "green"}">${
                        missing > 0 ? `需要刷 ${missing} 個` : "✓ 足夠"
                    }</td>
                    <td class="${canMake > 0 ? "blue" : "gray"}">${
                        color !== "gold" 
                            ? (canMake > 0 ? `可合成 ${canMake} 次` : "無法合成")
                            : "最高等級"
                    }</td>
                    <td class="${excess > 0 ? "red" : "gray"}">${
                        excess > 0 ? `溢出 ${excess}` : "0"
                    }</td>
                </tr>`;
            }
            
            elements.statusTable.innerHTML = html;
        }
        
        // 執行智慧優化
        function performSmartOptimization(current) {
            const optimized = {...current};
            const synthPath = {};
            const synthTimes = {}; // 記錄每種顏色的合成次數
            
            // 從綠色開始向上合成優化
            for (let i = 0; i < config.colorOrder.length - 1; i++) {
                const color = config.colorOrder[i];
                const nextColor = config.colorOrder[i + 1];
                const need = config.requirements[color];
                const have = optimized[color];
                
                if (have > need) {
                    const excess = have - need;
                    const times = Math.floor(excess / 3);
                    
                    if (times > 0) {
                        optimized[color] -= times * 3;
                        optimized[nextColor] += times;
                        synthPath[color] = `合成${times}次→${config.colors[nextColor]}`;
                        synthTimes[color] = times;
                    } else {
                        synthTimes[color] = 0;
                    }
                } else {
                    synthTimes[color] = 0;
                }
            }
            
            // 金色沒有合成選項
            synthTimes["gold"] = 0;
            
            // 更新優化結果顯示
            let html = "";
            
            for (const color of config.colorOrder) {
                const need = config.requirements[color];
                const optimizedAmount = optimized[color];
                const realNeed = Math.max(0, need - optimizedAmount);
                const times = synthTimes[color] || 0;
                
                let advice = "";
                if (realNeed > 0) {
                    advice = `🎯 還需刷取 ${realNeed} 個`;
                } else if (optimizedAmount > need) {
                    const surplus = optimizedAmount - need;
                    advice = `✅ 達標 (多出 ${surplus} 個)`;
                } else {
                    advice = "✅ 剛好達標";
                }
                
                html += `
                <tr>
                    <td class="${color}">${getColorIcon(color)}${config.colors[color]}</td>
                    <td class="${optimizedAmount >= need ? "green" : "red"}">${optimizedAmount}</td>
                    <td class="${realNeed > 0 ? "red" : "green"}">${realNeed}</td>
                    <td class="${times > 0 ? "blue" : "gray"}">${times > 0 ? `${times} 次` : "無合成"}</td>
                    <td class="${realNeed > 0 ? "red" : "green"}">${advice}</td>
                </tr>`;
            }
            
            elements.optimizedTable.innerHTML = html;
        }
        
        // 獲取顏色圖標
        function getColorIcon(color) {
            const icons = {
                green: "🟢",
                blue: "🔵",
                purple: "🟣",
                gold: "🟡"
            };
            return icons[color] || "";
        }
        
        // 複製結果
        function copyResults() {
            const current = {};
            const optimized = {};
            const synthTimes = {};
            
            // 獲取當前數據
            for (const color of config.colorOrder) {
                current[color] = parseInt(elements.currents[color].value) || 0;
                optimized[color] = current[color];
            }
            
            // 模擬合成過程
            for (let i = 0; i < config.colorOrder.length - 1; i++) {
                const color = config.colorOrder[i];
                const nextColor = config.colorOrder[i + 1];
                const need = config.requirements[color];
                const have = optimized[color];
                
                if (have > need) {
                    const excess = have - need;
                    const times = Math.floor(excess / 3);
                    
                    if (times > 0) {
                        optimized[color] -= times * 3;
                        optimized[nextColor] += times;
                        synthTimes[color] = times;
                    } else {
                        synthTimes[color] = 0;
                    }
                } else {
                    synthTimes[color] = 0;
                }
            }
            synthTimes["gold"] = 0;
            
            let result = "=== 智慧素材需求分析報告 ===\n\n";
            result += "📅 生成時間: " + new Date().toLocaleString() + "\n\n";
            
            // 1. 目標需求
            result += "🎯 目標需求:\n";
            for (const color of config.colorOrder) {
                result += `- ${config.colors[color]}色: ${config.requirements[color]} 個\n`;
            }
            
            // 2. 當前持有
            result += "\n📦 當前持有:\n";
            for (const color of config.colorOrder) {
                result += `- ${config.colors[color]}色: ${current[color]} 個\n`;
            }
            
            // 3. 模擬合成分析
            result += "\n🧠 模擬合成分析:\n";
            for (const color of config.colorOrder) {
                if (color !== "gold" && synthTimes[color] > 0) {
                    const nextColor = config.colorOrder[config.colorOrder.indexOf(color) + 1];
                    result += `- 將 ${config.colors[color]}色合成 ${synthTimes[color]} 次 → 獲得 ${synthTimes[color]} 個${config.colors[nextColor]}色\n`;
                }
            }
            
            // 4. 模擬後數量
            result += "\n🔄 模擬合成後數量:\n";
            for (const color of config.colorOrder) {
                const need = config.requirements[color];
                const after = optimized[color];
                const status = after >= need ? "✓ 達標" : "✗ 不足";
                result += `- ${config.colors[color]}色: ${after} 個 (${status})\n`;
            }
            
            // 5. 最終刷取建議
            result += "\n💡 最終刷取建議:\n";
            let totalNeed = 0;
            let hasNeed = false;
            
            for (const color of config.colorOrder) {
                const need = config.requirements[color];
                const after = optimized[color];
                const missing = Math.max(0, need - after);
                
                if (missing > 0) {
                    hasNeed = true;
                    totalNeed += missing;
                    result += `- 還需刷取 ${config.colors[color]}色: ${missing} 個\n`;
                }
            }
            
            if (!hasNeed) {
                result += "- 所有素材都已達標，無需額外刷取！\n";
            } else {
                result += `\n總計需要刷取: ${totalNeed} 個素材\n`;
            }
            
            // 複製到剪貼簿
            navigator.clipboard.writeText(result)
                .then(() => alert("模擬合成分析報告已複製到剪貼簿！"))
                .catch(err => {
                    console.error("複製失敗:", err);
                    // 降級方案
                    const textarea = document.createElement("textarea");
                    textarea.value = result;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textarea);
                    alert("分析報告已複製到剪貼簿！");
                });
        }
        
        // 顯示說明
        function showAbout() {
            const about = `🎮 智慧素材需求計算器 v2.2\n\n
✨ 功能特色:\n
• 可自訂各色素材的目標需求數量\n
• 智慧模擬合成系統，自動計算最佳合成策略\n
• 詳細分析模擬合成後的素材數量變化\n
• 提供精確的最終刷取建議\n\n
📋 使用說明:\n
1. 在「目標需求設定」設定您需要的各色素材數量\n
2. 在「當前持有數量」輸入您目前擁有的素材\n
3. 查看「智慧模擬合成分析」了解系統建議的合成策略\n
4. 按照「最終刷取建議」進行素材收集\n\n
🔄 模擬合成規則:\n
• 每3個低階素材可合成1個高階素材\n
• 系統會自動保留您設定的目標數量\n
• 只會將超出部分的素材用於合成\n\n
🎨 顏色標示:\n
🟢 綠色: 已達標或足夠\n
🔴 紅色: 不足或需要注意\n
🔵 藍色: 合成相關操作\n
⚪ 灰色: 無需操作`;
            
            alert(about);
        }
        
        // 啟動應用
        init();
    </script>
</body>
</html>
