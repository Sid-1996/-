<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sid的鳴潮智慧素材需求計算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 加密的 Google Analytics 代碼 -->
<script>
    // 使用 Base64 + 簡單混淆加密 GA 代碼
    const encrypted_ga = "PHNjcmlwdCBhc3luYyBzcmM9Imh0dHBzOi8vd3d3Lmdvb2dsZXRhZ21hbmFnZXIuY29tL2d0YWcvanM/aWQ9Ry1SNTNDSjZRRUJHIj48L3NjcmlwdD4KPHNjcmlwdD4KICA7KGZ1bmN0aW9uKCl7CiAgICB3aW5kb3cuZGF0YUxheWVyID0gd2luZG93LmRhdGFMYXllciB8fCBbXTsKICAgIGZ1bmN0aW9uIGd0YWcoKXtkYXRhTGF5ZXIucHVzaChhcmd1bWVudHMpO30KICAgIGd0YWcoJ2pzJywgbmV3IERhdGUoKSk7CiAgICBndGFnKCdjb25maWcnLCAnRy1SNTNDSjZRRUJHJyk7CiAgfSkoKTsKPC9zY3JpcHQ+";
    
    function loadGA() {
        // 解密並載入 GA
        const decoded = atob(encrypted_ga);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = decoded;
        
        // 執行解密後的腳本
        const scripts = tempDiv.getElementsByTagName('script');
        for(let i = 0; i < scripts.length; i++) {
            const newScript = document.createElement('script');
            if(scripts[i].src) {
                newScript.src = scripts[i].src;
                newScript.async = true;
            } else {
                newScript.text = scripts[i].text;
            }
            document.head.appendChild(newScript);
        }
    }
    
    // 延遲載入 GA (避免影響頁面載入速度)
    window.addEventListener('load', function() {
        setTimeout(loadGA, 1000);
    });
</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .card-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .card-content {
            color: #34495e;
        }
        
        .material-green { color: #27ae60; }
        .material-blue { color: #3498db; }
        .material-purple { color: #9b59b6; }
        .material-gold { color: #f39c12; }
        
        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #138496);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        }
        
        .slider-track {
            background: linear-gradient(to right, #bdc3c7 0%, #3498db 100%);
            height: 6px;
            border-radius: 3px;
        }
        
        .input-field {
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 10px 15px;
            transition: border-color 0.3s ease;
            background: white;
        }
        
        .input-field:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .status-success {
            color: #27ae60;
            font-weight: 600;
        }
        
        .status-error {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .report-section {
            background: rgba(255, 255, 255, 0.95);
            color: #2c3e50;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header-title {
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header-subtitle {
            color: rgba(255,255,255,0.9);
        }
        
        .language-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .language-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }
        
        .language-btn.active {
            background: white;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .record-item {
            background: rgba(52, 152, 219, 0.05);
            border: 1px solid rgba(52, 152, 219, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .record-item:hover {
            background: rgba(52, 152, 219, 0.1);
            border-color: rgba(52, 152, 219, 0.4);
        }
        
        .record-item.active {
            background: rgba(52, 152, 219, 0.15);
            border-color: rgba(52, 152, 219, 0.5);
        }
        
        .record-delete {
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }
        
        .record-item:hover .record-delete {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header with Language Selector -->
        <div class="text-center mb-8">
            <div class="flex justify-end mb-4">
                <div class="flex gap-2">
                    <button id="lang-zh" class="language-btn active" data-lang="zh">中文</button>
                    <button id="lang-en" class="language-btn" data-lang="en">English</button>
                </div>
            </div>
            <h1 class="text-4xl font-bold header-title mb-2" data-i18n="title">🎮 Sid的鳴潮智慧素材需求計算器</h1>
            <p class="header-subtitle" data-i18n="subtitle">逆向演算法優化 • 智慧合成策略 • 零浪費資源配置</p>
        </div>

        <!-- User Records Section -->
        <div class="card mb-8">
            <div class="flex flex-wrap items-center justify-between mb-6">
                <h2 class="text-2xl card-title flex items-center" data-i18n="records.title">
                    📋 使用記錄
                </h2>
                <div class="flex gap-2 mt-2 sm:mt-0">
                    <button id="save-record-btn" class="btn-info text-sm px-4 py-2" data-i18n="records.save">
                        💾 保存當前設定
                    </button>
                    <button id="clear-records-btn" class="btn-secondary text-sm px-4 py-2" data-i18n="records.clearAll">
                        🗑️ 清空記錄
                    </button>
                </div>
            </div>
            <div id="records-list" class="space-y-2">
                <p class="text-gray-500 text-center" data-i18n="records.empty">目前沒有保存的記錄</p>
            </div>
        </div>

        <!-- 第一區塊：設定區域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 角色技能設定 -->
            <div class="card">
                <div class="flex flex-wrap items-center justify-between mb-6">
                    <h2 class="text-2xl card-title flex items-center" data-i18n="skills.title">
                        ⚔️ 角色技能等級
                    </h2>
                    <div class="flex gap-2 mt-2 sm:mt-0">
                        <button id="skill-level-6" class="btn-secondary text-sm px-3 py-1" data-i18n="skills.level6">
                            6等
                        </button>
                        <button id="skill-level-8" class="btn-secondary text-sm px-3 py-1" data-i18n="skills.level8">
                            8等
                        </button>
                        <button id="skill-level-10" class="btn-secondary text-sm px-3 py-1" data-i18n="skills.level10">
                            10等
                        </button>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="skill-control">
                        <label class="block text-base font-medium card-content mb-3" data-i18n="skills.normal">常態攻擊</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm card-content w-4">1</span>
                            <input type="range" id="skill1" min="1" max="10" value="1" 
                                   class="flex-1 h-3 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content w-6">10</span>
                            <span id="skill1-value" class="text-xl font-bold material-blue w-8 text-center">1</span>
                        </div>
                    </div>
                    <div class="skill-control">
                        <label class="block text-base font-medium card-content mb-3" data-i18n="skills.resonance">共鳴技能</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm card-content w-4">1</span>
                            <input type="range" id="skill2" min="1" max="10" value="1" 
                                   class="flex-1 h-3 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content w-6">10</span>
                            <span id="skill2-value" class="text-xl font-bold material-blue w-8 text-center">1</span>
                        </div>
                    </div>
                    <div class="skill-control">
                        <label class="block text-base font-medium card-content mb-3" data-i18n="skills.liberation">共鳴解放</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm card-content w-4">1</span>
                            <input type="range" id="skill3" min="1" max="10" value="1" 
                                   class="flex-1 h-3 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content w-6">10</span>
                            <span id="skill3-value" class="text-xl font-bold material-blue w-8 text-center">1</span>
                        </div>
                    </div>
                    <div class="skill-control">
                        <label class="block text-base font-medium card-content mb-3" data-i18n="skills.variation">變奏技能</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm card-content w-4">1</span>
                            <input type="range" id="skill4" min="1" max="10" value="1" 
                                   class="flex-1 h-3 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content w-6">10</span>
                            <span id="skill4-value" class="text-xl font-bold material-blue w-8 text-center">1</span>
                        </div>
                    </div>
                    <div class="skill-control">
                        <label class="block text-base font-medium card-content mb-3" data-i18n="skills.circuit">共鳴迴路</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm card-content w-4">1</span>
                            <input type="range" id="skill5" min="1" max="10" value="1" 
                                   class="flex-1 h-3 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content w-6">10</span>
                            <span id="skill5-value" class="text-xl font-bold material-blue w-8 text-center">1</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 武器設定與目標需求 -->
            <div class="space-y-6">
                <!-- 武器等級設定 -->
                <div class="card">
                    <h2 class="text-2xl card-title flex items-center mb-6" data-i18n="weapon.title">
                        🗡️ 武器突破等級
                    </h2>
                    <div class="skill-control">
                        <label class="block text-base font-medium card-content mb-3" data-i18n="weapon.level">武器等級</label>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm card-content w-4">1</span>
                            <input type="range" id="weapon" min="0" max="6" value="0" step="1"
                                   class="flex-1 h-3 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content w-6">90</span>
                            <span id="weapon-value" class="text-xl font-bold material-purple w-12 text-center">1級</span>
                        </div>
                    </div>
                </div>

                <!-- 目標需求 -->
                <div class="card">
                    <h2 class="text-xl card-title flex items-center mb-4" data-i18n="target.title">
                        🎯 目標需求總計
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 rounded-lg p-4 text-center border-2 border-green-200">
                            <div class="text-2xl mb-2">🟢</div>
                            <div class="text-sm card-content font-medium mb-1" data-i18n="materials.green">綠色素材</div>
                            <div id="target-green" class="text-2xl font-bold material-green">0</div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 text-center border-2 border-blue-200">
                            <div class="text-2xl mb-2">🔵</div>
                            <div class="text-sm card-content font-medium mb-1" data-i18n="materials.blue">藍色素材</div>
                            <div id="target-blue" class="text-2xl font-bold material-blue">0</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 text-center border-2 border-purple-200">
                            <div class="text-2xl mb-2">🟣</div>
                            <div class="text-sm card-content font-medium mb-1" data-i18n="materials.purple">紫色素材</div>
                            <div id="target-purple" class="text-2xl font-bold material-purple">0</div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 text-center border-2 border-yellow-200">
                            <div class="text-2xl mb-2">🟡</div>
                            <div class="text-sm card-content font-medium mb-1" data-i18n="materials.gold">金色素材</div>
                            <div id="target-gold" class="text-2xl font-bold material-gold">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 第二區塊：持有數量輸入 -->
        <div class="card mb-8">
            <h2 class="text-2xl card-title flex items-center mb-6" data-i18n="current.title">
                📦 當前持有數量
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="text-center">
                    <div class="bg-green-50 rounded-xl p-4 mb-4 border-2 border-green-200 hover:border-green-300 transition-colors">
                        <span class="text-3xl block mb-2">🟢</span>
                        <p class="text-base font-semibold material-green mb-2" data-i18n="materials.green">綠色素材</p>
                    </div>
                    <input type="number" id="current-green" value="0" min="0" 
                           class="input-field w-full text-center text-lg font-semibold" placeholder="0">
                </div>
                <div class="text-center">
                    <div class="bg-blue-50 rounded-xl p-4 mb-4 border-2 border-blue-200 hover:border-blue-300 transition-colors">
                        <span class="text-3xl block mb-2">🔵</span>
                        <p class="text-base font-semibold material-blue mb-2" data-i18n="materials.blue">藍色素材</p>
                    </div>
                    <input type="number" id="current-blue" value="0" min="0" 
                           class="input-field w-full text-center text-lg font-semibold" placeholder="0">
                </div>
                <div class="text-center">
                    <div class="bg-purple-50 rounded-xl p-4 mb-4 border-2 border-purple-200 hover:border-purple-300 transition-colors">
                        <span class="text-3xl block mb-2">🟣</span>
                        <p class="text-base font-semibold material-purple mb-2" data-i18n="materials.purple">紫色素材</p>
                    </div>
                    <input type="number" id="current-purple" value="0" min="0" 
                           class="input-field w-full text-center text-lg font-semibold" placeholder="0">
                </div>
                <div class="text-center">
                    <div class="bg-yellow-50 rounded-xl p-4 mb-4 border-2 border-yellow-200 hover:border-yellow-300 transition-colors">
                        <span class="text-3xl block mb-2">🟡</span>
                        <p class="text-base font-semibold material-gold mb-2" data-i18n="materials.gold">金色素材</p>
                    </div>
                    <input type="number" id="current-gold" value="0" min="0" 
                           class="input-field w-full text-center text-lg font-semibold" placeholder="0">
                </div>
            </div>
        </div>

        <!-- 第三區塊：快捷操作按鈕 -->
        <div class="card mb-8">
            <div class="flex flex-wrap gap-4 justify-center">
                <button id="max-cultivation-btn" class="btn-primary text-lg px-8 py-4" data-i18n="buttons.maxCultivation">
                    🎓 一鍵畢業需求
                </button>
                <button id="reset-default-btn" class="btn-success text-lg px-8 py-4" data-i18n="buttons.resetDefault">
                    🎯 重置預設
                </button>
                <button id="reset-all-btn" class="btn-secondary text-lg px-8 py-4" data-i18n="buttons.resetAll">
                    🔄 重置數據
                </button>
                <button id="copy-report-btn" class="btn-warning text-lg px-8 py-4" data-i18n="buttons.copyReport">
                    📋 複製報告
                </button>
            </div>
        </div>

        <!-- 第四區塊：分析結果 -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
            <!-- 狀態分析 -->
            <div class="card">
                <h2 class="text-xl card-title flex items-center mb-6" data-i18n="analysis.title">
                    📊 資源狀態分析
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="text-left py-4 card-content font-semibold text-base" data-i18n="analysis.material">素材</th>
                                <th class="text-center py-4 card-content font-semibold text-base" data-i18n="analysis.target">目標</th>
                                <th class="text-center py-4 card-content font-semibold text-base" data-i18n="analysis.current">持有</th>
                                <th class="text-center py-4 card-content font-semibold text-base" data-i18n="analysis.status">狀態</th>
                            </tr>
                        </thead>
                        <tbody id="status-table">
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-4 card-content text-base">🟢 <span data-i18n="materials.green">綠色</span></td>
                                <td class="text-center py-4 card-content text-base" id="status-target-green">0</td>
                                <td class="text-center py-4 card-content text-base" id="status-current-green">0</td>
                                <td class="text-center py-4 text-base" id="status-green">-</td>
                            </tr>
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-4 card-content text-base">🔵 <span data-i18n="materials.blue">藍色</span></td>
                                <td class="text-center py-4 card-content text-base" id="status-target-blue">0</td>
                                <td class="text-center py-4 card-content text-base" id="status-current-blue">0</td>
                                <td class="text-center py-4 text-base" id="status-blue">-</td>
                            </tr>
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-4 card-content text-base">🟣 <span data-i18n="materials.purple">紫色</span></td>
                                <td class="text-center py-4 card-content text-base" id="status-target-purple">0</td>
                                <td class="text-center py-4 card-content text-base" id="status-current-purple">0</td>
                                <td class="text-center py-4 text-base" id="status-purple">-</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 card-content text-base">🟡 <span data-i18n="materials.gold">金色</span></td>
                                <td class="text-center py-4 card-content text-base" id="status-target-gold">0</td>
                                <td class="text-center py-4 card-content text-base" id="status-current-gold">0</td>
                                <td class="text-center py-4 text-base" id="status-gold">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 最佳合成策略 -->
            <div class="card">
                <h2 class="text-xl card-title flex items-center mb-6" data-i18n="strategy.title">
                    🧠 最佳合成策略
                    <span class="ml-3 px-3 py-1 bg-blue-500 text-white text-sm rounded-full animate-pulse" data-i18n="strategy.smart">智慧推薦</span>
                </h2>
                <div id="strategy-display" class="space-y-3">
                    <div class="bg-gray-50 rounded-lg p-4 text-center border-2 border-dashed border-gray-300">
                        <p class="card-content text-base" data-i18n="strategy.placeholder">輸入持有數量後自動顯示最佳策略</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Execution Result Preview -->
        <div class="mt-8">
            <div class="card">
                <h2 class="text-2xl card-title flex items-center" data-i18n="preview.title">
                    🔄 執行後預覽
                </h2>
                <div id="execution-preview" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-green-50 rounded-lg p-4 text-center border-2 border-green-200">
                        <div class="text-2xl mb-2">🟢</div>
                        <div class="text-sm card-content font-medium" data-i18n="materials.green">綠色素材</div>
                        <div id="preview-green" class="text-lg font-bold material-green">-</div>
                        <div id="preview-green-status" class="text-xs card-content">-</div>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 text-center border-2 border-blue-200">
                        <div class="text-2xl mb-2">🔵</div>
                        <div class="text-sm card-content font-medium" data-i18n="materials.blue">藍色素材</div>
                        <div id="preview-blue" class="text-lg font-bold material-blue">-</div>
                        <div id="preview-blue-status" class="text-xs card-content">-</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4 text-center border-2 border-purple-200">
                        <div class="text-2xl mb-2">🟣</div>
                        <div class="text-sm card-content font-medium" data-i18n="materials.purple">紫色素材</div>
                        <div id="preview-purple" class="text-lg font-bold material-purple">-</div>
                        <div id="preview-purple-status" class="text-xs card-content">-</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4 text-center border-2 border-yellow-200">
                        <div class="text-2xl mb-2">🟡</div>
                        <div class="text-sm card-content font-medium" data-i18n="materials.gold">金色素材</div>
                        <div id="preview-gold" class="text-lg font-bold material-gold">-</div>
                        <div id="preview-gold-status" class="text-xs card-content">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Section -->
        <div class="mt-8">
            <div class="report-section">
                <h2 class="text-2xl card-title flex items-center" data-i18n="report.title">
                    📋 智慧素材需求分析報告
                </h2>
                <div id="report-content" class="bg-gray-50 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap border-2 border-gray-200" style="color: #2c3e50;">
輸入持有數量後自動生成詳細報告...
                </div>
            </div>
        </div>

        <!-- Calculation Process Section -->
        <div class="mt-6">
            <div class="bg-gray-100 rounded-lg p-4 border border-gray-300">
                <details class="cursor-pointer">
                    <summary class="text-sm text-gray-600 font-medium hover:text-gray-800 transition-colors" data-i18n="calculation.details">
                        🔍 計算過程詳情 (點擊展開)
                    </summary>
                    <div class="mt-4 pt-4 border-t border-gray-300">
                        <div id="calculation-process" class="bg-white rounded p-3 font-mono text-xs text-gray-700 whitespace-pre-wrap border">
點擊上方按鈕或輸入數據後顯示詳細計算過程...
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Instructions -->
        <div class="mt-8 card">
            <h3 class="text-lg card-title mb-3" data-i18n="instructions.title">📖 使用說明</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base" data-i18n="instructions.setTarget">🎯 設定目標</h4>
                    <ul class="space-y-1 card-content">
                        <li data-i18n="instructions.adjustSkills">• 調整角色技能等級（1-10級）</li>
                        <li data-i18n="instructions.setWeapon">• 設定武器突破等級（1-90級）</li>
                        <li data-i18n="instructions.autoCalculate">• 系統自動計算所需素材</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base" data-i18n="instructions.inputHoldings">📦 輸入持有量</h4>
                    <ul class="space-y-1 card-content">
                        <li data-i18n="instructions.inputMaterials">• 輸入各色素材當前持有數量</li>
                        <li data-i18n="instructions.fourTierSystem">• 支援四級素材系統</li>
                        <li data-i18n="instructions.synthesisPath">• 綠→藍→紫→金 合成路徑</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base" data-i18n="instructions.smartCalculation">🧠 智慧計算</h4>
                    <ul class="space-y-1 card-content">
                        <li data-i18n="instructions.autoStrategy">• 輸入素材後自動計算最佳策略</li>
                        <li data-i18n="instructions.preserveGreen">• 保證綠色素材不被過度消耗</li>
                        <li data-i18n="instructions.maxEfficiency">• 最大化資源利用效率</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base" data-i18n="instructions.reportFeature">📋 報告功能</h4>
                    <ul class="space-y-1 card-content">
                        <li data-i18n="instructions.detailedStrategy">• 詳細的合成策略說明</li>
                        <li data-i18n="instructions.beforeAfter">• 執行前後數量對比</li>
                        <li data-i18n="instructions.oneClickCopy">• 一鍵複製完整報告</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base" data-i18n="instructions.farmingMethods">⚡ 刷取方式說明</h4>
                    <ul class="space-y-1 card-content">
                        <li data-i18n="instructions.normal">• 常規(40體/場): 標準凝素領域</li>
                        <li data-i18n="instructions.safe">• 安全(40體/場): 含緩衝的保險場次</li>
                        <li data-i18n="instructions.doubleEvent">• 活動雙倍(40體/場): 雙倍掉落期間</li>
                        <li data-i18n="instructions.reduced">• 減負途徑(80體/場): 2倍素材掉落</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base" data-i18n="instructions.recordFeature">💾 記錄功能</h4>
                    <ul class="space-y-1 card-content">
                        <li data-i18n="instructions.saveSettings">• 保存當前角色和武器設定</li>
                        <li data-i18n="instructions.quickLoad">• 快速載入之前的配置</li>
                        <li data-i18n="instructions.manageRecords">• 管理和刪除不需要的記錄</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Internationalization data
        const i18nData = {
            zh: {
                title: "🎮 Sid的鳴潮智慧素材需求計算器",
                subtitle: "逆向演算法優化 • 智慧合成策略 • 零浪費資源配置",
                records: {
                    title: "📋 使用記錄",
                    save: "💾 保存當前設定",
                    clearAll: "🗑️ 清空記錄",
                    empty: "目前沒有保存的記錄",
                    savePrompt: "請為這個配置輸入名稱：",
                    defaultName: "角色配置",
                    confirmClear: "確定要清空所有記錄嗎？",
                    deleteRecord: "刪除這個記錄？"
                },
                skills: {
                    title: "⚔️ 角色技能等級",
                    level6: "6等",
                    level8: "8等",
                    level10: "10等",
                    normal: "常態攻擊",
                    resonance: "共鳴技能",
                    liberation: "共鳴解放",
                    variation: "變奏技能",
                    circuit: "共鳴迴路"
                },
                weapon: {
                    title: "🗡️ 武器突破等級",
                    level: "武器等級"
                },
                target: {
                    title: "🎯 目標需求總計"
                },
                materials: {
                    green: "綠色素材",
                    blue: "藍色素材",
                    purple: "紫色素材",
                    gold: "金色素材"
                },
                current: {
                    title: "📦 當前持有數量"
                },
                buttons: {
                    maxCultivation: "🎓 一鍵畢業需求",
                    resetDefault: "🎯 重置預設",
                    resetAll: "🔄 重置數據",
                    copyReport: "📋 複製報告"
                },
                analysis: {
                    title: "📊 資源狀態分析",
                    material: "素材",
                    target: "目標",
                    current: "持有",
                    status: "狀態"
                },
                strategy: {
                    title: "🧠 最佳合成策略",
                    smart: "智慧推薦",
                    placeholder: "輸入持有數量後自動顯示最佳策略",
                    noSynthesis: "🎉 無需合成，當前資源已經最優配置！"
                },
                preview: {
                    title: "🔄 執行後預覽"
                },
                report: {
                    title: "📋 智慧素材需求分析報告",
                    placeholder: "輸入持有數量後自動生成詳細報告..."
                },
                calculation: {
                    details: "🔍 計算過程詳情 (點擊展開)",
                    placeholder: "點擊上方按鈕或輸入數據後顯示詳細計算過程..."
                },
                instructions: {
                    title: "📖 使用說明",
                    setTarget: "🎯 設定目標",
                    adjustSkills: "• 調整角色技能等級（1-10級）",
                    setWeapon: "• 設定武器突破等級（1-90級）",
                    autoCalculate: "• 系統自動計算所需素材",
                    inputHoldings: "📦 輸入持有量",
                    inputMaterials: "• 輸入各色素材當前持有數量",
                    fourTierSystem: "• 支援四級素材系統",
                    synthesisPath: "• 綠→藍→紫→金 合成路徑",
                    smartCalculation: "🧠 智慧計算",
                    autoStrategy: "• 輸入素材後自動計算最佳策略",
                    preserveGreen: "• 保證綠色素材不被過度消耗",
                    maxEfficiency: "• 最大化資源利用效率",
                    reportFeature: "📋 報告功能",
                    detailedStrategy: "• 詳細的合成策略說明",
                    beforeAfter: "• 執行前後數量對比",
                    oneClickCopy: "• 一鍵複製完整報告",
                    farmingMethods: "⚡ 刷取方式說明",
                    normal: "• 常規(40體/場): 標準凝素領域",
                    safe: "• 安全(40體/場): 含緩衝的保險場次",
                    doubleEvent: "• 活動雙倍(40體/場): 雙倍掉落期間",
                    reduced: "• 減負途徑(80體/場): 2倍素材掉落",
                    recordFeature: "💾 記錄功能",
                    saveSettings: "• 保存當前角色和武器設定",
                    quickLoad: "• 快速載入之前的配置",
                    manageRecords: "• 管理和刪除不需要的記錄"
                },
                messages: {
                    recordSaved: "✅ 配置已保存！",
                    recordLoaded: "✅ 配置已載入！",
                    recordDeleted: "✅ 記錄已刪除！",
                    recordsCleared: "✅ 所有記錄已清空！",
                    reportCopied: "✅ 已複製！"
                }
            },
            en: {
                title: "🎮 Sid's Wuthering Waves Smart Material Calculator",
                subtitle: "Reverse Algorithm Optimization • Smart Synthesis Strategy • Zero Waste Resource Allocation",
                records: {
                    title: "📋 User Records",
                    save: "💾 Save Current Settings",
                    clearAll: "🗑️ Clear All",
                    empty: "No saved records currently",
                    savePrompt: "Please enter a name for this configuration:",
                    defaultName: "Character Config",
                    confirmClear: "Are you sure you want to clear all records?",
                    deleteRecord: "Delete this record?"
                },
                skills: {
                    title: "⚔️ Character Skill Levels",
                    level6: "Lv.6",
                    level8: "Lv.8",
                    level10: "Lv.10",
                    normal: "Normal Attack",
                    resonance: "Resonance Skill",
                    liberation: "Resonance Liberation",
                    variation: "Variation Skill",
                    circuit: "Resonance Circuit"
                },
                weapon: {
                    title: "🗡️ Weapon Breakthrough Level",
                    level: "Weapon Level"
                },
                target: {
                    title: "🎯 Target Requirements Total"
                },
                materials: {
                    green: "Green Materials",
                    blue: "Blue Materials",
                    purple: "Purple Materials",
                    gold: "Gold Materials"
                },
                current: {
                    title: "📦 Current Holdings"
                },
                buttons: {
                    maxCultivation: "🎓 Max Cultivation",
                    resetDefault: "🎯 Reset Default",
                    resetAll: "🔄 Reset All Data",
                    copyReport: "📋 Copy Report"
                },
                analysis: {
                    title: "📊 Resource Status Analysis",
                    material: "Material",
                    target: "Target",
                    current: "Current",
                    status: "Status"
                },
                strategy: {
                    title: "🧠 Optimal Synthesis Strategy",
                    smart: "Smart Recommendation",
                    placeholder: "Enter current holdings to display optimal strategy",
                    noSynthesis: "🎉 No synthesis needed, current resources are optimally configured!"
                },
                preview: {
                    title: "🔄 Post-Execution Preview"
                },
                report: {
                    title: "📋 Smart Material Requirement Analysis Report",
                    placeholder: "Enter current holdings to auto-generate detailed report..."
                },
                calculation: {
                    details: "🔍 Calculation Details (Click to expand)",
                    placeholder: "Click buttons above or enter data to show detailed calculation process..."
                },
                instructions: {
                    title: "📖 Instructions",
                    setTarget: "🎯 Set Target",
                    adjustSkills: "• Adjust character skill levels (1-10)",
                    setWeapon: "• Set weapon breakthrough level (1-90)",
                    autoCalculate: "• System auto-calculates required materials",
                    inputHoldings: "📦 Input Holdings",
                    inputMaterials: "• Enter current holdings for each material type",
                    fourTierSystem: "• Supports four-tier material system",
                    synthesisPath: "• Green→Blue→Purple→Gold synthesis path",
                    smartCalculation: "🧠 Smart Calculation",
                    autoStrategy: "• Auto-calculates optimal strategy after input",
                    preserveGreen: "• Ensures green materials aren't over-consumed",
                    maxEfficiency: "• Maximizes resource utilization efficiency",
                    reportFeature: "📋 Report Feature",
                    detailedStrategy: "• Detailed synthesis strategy explanation",
                    beforeAfter: "• Before/after quantity comparison",
                    oneClickCopy: "• One-click copy complete report",
                    farmingMethods: "⚡ Farming Methods",
                    normal: "• Normal (40 stamina/run): Standard Tacet Field",
                    safe: "• Safe (40 stamina/run): With buffer insurance runs",
                    doubleEvent: "• Event Double (40 stamina/run): Double drop period",
                    reduced: "• Reduced Load (80 stamina/run): 2x material drops",
                    recordFeature: "💾 Record Feature",
                    saveSettings: "• Save current character and weapon settings",
                    quickLoad: "• Quickly load previous configurations",
                    manageRecords: "• Manage and delete unwanted records"
                },
                messages: {
                    recordSaved: "✅ Configuration saved!",
                    recordLoaded: "✅ Configuration loaded!",
                    recordDeleted: "✅ Record deleted!",
                    recordsCleared: "✅ All records cleared!",
                    reportCopied: "✅ Copied!"
                }
            }
        };

        // Current language
        let currentLanguage = 'zh';

        // Skill upgrade requirements (level 1->2, 2->3, etc.)
        const skillRequirements = {
            1: {green: 2, blue: 0, purple: 0, gold: 0},
            2: {green: 3, blue: 0, purple: 0, gold: 0},
            3: {green: 0, blue: 2, purple: 0, gold: 0},
            4: {green: 0, blue: 3, purple: 0, gold: 0},
            5: {green: 0, blue: 0, purple: 3, gold: 0},
            6: {green: 0, blue: 0, purple: 5, gold: 0},
            7: {green: 0, blue: 0, purple: 0, gold: 2},
            8: {green: 0, blue: 0, purple: 0, gold: 3},
            9: {green: 0, blue: 0, purple: 0, gold: 6}
        };

        // Weapon breakthrough requirements (cumulative from level 1)
        const weaponRequirements = {
            1: {green: 0, blue: 0, purple: 0, gold: 0},
            40: {green: 6, blue: 0, purple: 0, gold: 0},
            50: {green: 6, blue: 8, purple: 0, gold: 0},
            60: {green: 6, blue: 8, purple: 6, gold: 0},
            70: {green: 6, blue: 8, purple: 6, gold: 8},
            80: {green: 6, blue: 8, purple: 6, gold: 20},
            90: {green: 6, blue: 8, purple: 6, gold: 20}
        };

        // Weapon level mapping for slider
        const weaponLevels = [1, 40, 50, 60, 70, 80, 90];

        // Base talent unlock requirements
        const baseTalentRequirements = {
            green: 0,
            blue: 3,
            purple: 15,
            gold: 12
        };

        // Domain drop rates data
        const domainDropRates = {
            stamina: 40,    // 每場消耗體力
            green: 6.42,    // 平均每場綠色掉落
            blue: 8.00,     // 平均每場藍色掉落
            purple: 1.59,   // 平均每場紫色掉落
            gold: 0.25      // 平均每場金色掉落
        };

        // User records storage
        let userRecords = JSON.parse(localStorage.getItem('wuthering-waves-records') || '[]');

        // Language functions
        function updateLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('wuthering-waves-language', lang);
            
            // Update document language
            document.documentElement.lang = lang === 'zh' ? 'zh-TW' : 'en';
            
            // Update language button states
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
            
            // Update all text elements with i18n data
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.dataset.i18n;
                const value = getNestedValue(i18nData[lang], key);
                if (value) {
                    element.textContent = value;
                }
            });

            // Update weapon level display
            updateWeaponLevelDisplay();

            // Update placeholder texts
            updatePlaceholders();

            // Re-render records with new language
            renderRecords();

            // Re-perform calculation to update report in new language
            performCalculation();
        }

        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => current && current[key], obj);
        }

        function updateWeaponLevelDisplay() {
            const weaponSlider = document.getElementById('weapon');
            const sliderValue = parseInt(weaponSlider.value);
            const weaponLevel = weaponLevels[sliderValue];
            const suffix = currentLanguage === 'zh' ? '級' : '';
            document.getElementById('weapon-value').textContent = weaponLevel + suffix;
        }

        function updatePlaceholders() {
            const strategyPlaceholder = getNestedValue(i18nData[currentLanguage], 'strategy.placeholder');
            const reportPlaceholder = getNestedValue(i18nData[currentLanguage], 'report.placeholder');
            const calcPlaceholder = getNestedValue(i18nData[currentLanguage], 'calculation.placeholder');

            if (document.getElementById('strategy-display').querySelector('.bg-gray-50')) {
                document.getElementById('strategy-display').innerHTML = 
                    `<div class="bg-gray-50 rounded-lg p-4 text-center border-2 border-dashed border-gray-300">
                        <p class="card-content text-base">${strategyPlaceholder}</p>
                    </div>`;
            }

            if (document.getElementById('report-content').textContent.includes('輸入持有數量後') || 
                document.getElementById('report-content').textContent.includes('Enter current holdings')) {
                document.getElementById('report-content').textContent = reportPlaceholder;
            }

            if (document.getElementById('calculation-process').textContent.includes('點擊上方按鈕') || 
                document.getElementById('calculation-process').textContent.includes('Click buttons above')) {
                document.getElementById('calculation-process').textContent = calcPlaceholder;
            }
        }

        // Record management functions
        function saveCurrentRecord() {
            const name = prompt(getNestedValue(i18nData[currentLanguage], 'records.savePrompt'), 
                               getNestedValue(i18nData[currentLanguage], 'records.defaultName'));
            if (!name) return;

            const record = {
                id: Date.now(),
                name: name,
                timestamp: new Date().toLocaleString(currentLanguage === 'zh' ? 'zh-TW' : 'en-US'),
                skills: {
                    skill1: parseInt(document.getElementById('skill1').value),
                    skill2: parseInt(document.getElementById('skill2').value),
                    skill3: parseInt(document.getElementById('skill3').value),
                    skill4: parseInt(document.getElementById('skill4').value),
                    skill5: parseInt(document.getElementById('skill5').value)
                },
                weapon: parseInt(document.getElementById('weapon').value),
                materials: {
                    green: parseInt(document.getElementById('current-green').value) || 0,
                    blue: parseInt(document.getElementById('current-blue').value) || 0,
                    purple: parseInt(document.getElementById('current-purple').value) || 0,
                    gold: parseInt(document.getElementById('current-gold').value) || 0
                }
            };

            userRecords.unshift(record);
            // Keep only the latest 10 records
            if (userRecords.length > 10) {
                userRecords = userRecords.slice(0, 10);
            }
            
            localStorage.setItem('wuthering-waves-records', JSON.stringify(userRecords));
            renderRecords();
            
            showMessage(getNestedValue(i18nData[currentLanguage], 'messages.recordSaved'));
        }

        function loadRecord(recordId) {
            const record = userRecords.find(r => r.id === recordId);
            if (!record) return;

            // Load skills
            ['skill1', 'skill2', 'skill3', 'skill4', 'skill5'].forEach(skillId => {
                const value = record.skills[skillId];
                document.getElementById(skillId).value = value;
                document.getElementById(skillId + '-value').textContent = value;
            });

            // Load weapon
            document.getElementById('weapon').value = record.weapon;
            updateWeaponLevelDisplay();
            window.currentWeaponLevel = weaponLevels[record.weapon];

            // Load materials
            ['green', 'blue', 'purple', 'gold'].forEach(color => {
                document.getElementById('current-' + color).value = record.materials[color];
            });

            // Recalculate
            calculateRequirements();
            performCalculation();
            
            showMessage(getNestedValue(i18nData[currentLanguage], 'messages.recordLoaded'));
        }

        function deleteRecord(recordId) {
            if (!confirm(getNestedValue(i18nData[currentLanguage], 'records.deleteRecord'))) return;
            
            userRecords = userRecords.filter(r => r.id !== recordId);
            localStorage.setItem('wuthering-waves-records', JSON.stringify(userRecords));
            renderRecords();
            
            showMessage(getNestedValue(i18nData[currentLanguage], 'messages.recordDeleted'));
        }

        function clearAllRecords() {
            if (!confirm(getNestedValue(i18nData[currentLanguage], 'records.confirmClear'))) return;
            
            userRecords = [];
            localStorage.setItem('wuthering-waves-records', JSON.stringify(userRecords));
            renderRecords();
            
            showMessage(getNestedValue(i18nData[currentLanguage], 'messages.recordsCleared'));
        }

        function renderRecords() {
            const recordsList = document.getElementById('records-list');
            
            if (userRecords.length === 0) {
                recordsList.innerHTML = `<p class="text-gray-500 text-center">${getNestedValue(i18nData[currentLanguage], 'records.empty')}</p>`;
                return;
            }

            recordsList.innerHTML = userRecords.map(record => {
                const skillLevels = [record.skills.skill1, record.skills.skill2, record.skills.skill3, record.skills.skill4, record.skills.skill5];
                const weaponLevel = weaponLevels[record.weapon];
                const suffix = currentLanguage === 'zh' ? '級' : '';
                
                return `
                    <div class="record-item" onclick="loadRecord(${record.id})">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-semibold text-blue-700">${record.name}</div>
                                <div class="text-sm text-gray-600">
                                    ${currentLanguage === 'zh' ? '技能' : 'Skills'}: [${skillLevels.join(', ')}] | 
                                    ${currentLanguage === 'zh' ? '武器' : 'Weapon'}: ${weaponLevel}${suffix} | 
                                    ${currentLanguage === 'zh' ? '素材' : 'Materials'}: 🟢${record.materials.green} 🔵${record.materials.blue} 🟣${record.materials.purple} 🟡${record.materials.gold}
                                </div>
                                <div class="text-xs text-gray-500">${record.timestamp}</div>
                            </div>
                            <button class="record-delete text-red-500 hover:text-red-700 ml-4 p-1" 
                                    onclick="event.stopPropagation(); deleteRecord(${record.id})">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showMessage(message) {
            // Create temporary message display
            const messageEl = document.createElement('div');
            messageEl.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            messageEl.textContent = message;
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 2000);
        }

        // Verification function for AI self-check
        function verifyRuns(n, requiredGold) {
            const directGold = 0.25 * n;
            const green = 6.42 * n, blue = 8 * n, purple = 1.59 * n;
            const synthBlue = Math.floor(green / 3);
            const synthPurple = Math.floor((blue + synthBlue) / 3);
            const synthGold = Math.floor((purple + synthPurple) / 3);
            return (directGold + synthGold) >= requiredGold;
        }

        // New dynamic domain calculation algorithm
        function calculateDomainRuns(shortageGold, currentMaterials) {
            // 凝素領域固定掉落率
            const DROP_RATES = {
                green: 6.42,
                blue: 8.00,
                purple: 1.59,
                gold: 0.25
            };

            // 計算最小場次（考慮直接掉落+三階合成）
            function calculateMinRuns() {
                let runs = 0;
                while (true) {
                    // 直接獲取
                    const directGold = runs * DROP_RATES.gold;
                    
                    // 合成獲取（完整三階轉換）
                    const synthGold = 
                        Math.floor((
                            (runs * DROP_RATES.purple) + 
                            Math.floor((
                                (runs * DROP_RATES.blue) + 
                                Math.floor((runs * DROP_RATES.green) / 3)
                            ) / 3)
                        ) / 3);
                    
                    if (directGold + synthGold >= shortageGold) {
                        return runs;
                    }
                    runs++;
                }
            }

            // 資源消耗驗證
            function verifyResources(runs) {
                const requiredGreen = Math.ceil(shortageGold / (DROP_RATES.gold + DROP_RATES.green/27));
                return {
                    green: runs * DROP_RATES.green <= currentMaterials.green + requiredGreen,
                    blue: runs * DROP_RATES.blue <= currentMaterials.blue + Math.floor(runs * DROP_RATES.green / 3),
                    purple: runs * DROP_RATES.purple <= currentMaterials.purple + Math.floor(runs * DROP_RATES.blue / 3)
                };
            }

            const minRuns = calculateMinRuns();
            
            // 智能緩衝機制
            let bufferRate = 0.1; // 基礎10%緩衝
            if (shortageGold > 30) {
                bufferRate = 0.15; // 大缺口15%緩衝
            } else if (shortageGold <= 20) {
                bufferRate = 0.08; // 小缺口8%緩衝
            }
            
            const safeRuns = Math.ceil(minRuns * (1 + bufferRate));
            
            // 計算效率指標
            const directGold = minRuns * DROP_RATES.gold;
            const synthGold = Math.floor((
                (minRuns * DROP_RATES.purple) + 
                Math.floor((
                    (minRuns * DROP_RATES.blue) + 
                    Math.floor((minRuns * DROP_RATES.green) / 3)
                ) / 3)
            ) / 3);
            const totalEfficiency = (directGold + synthGold) / minRuns;
            
            return {
                minRuns,
                safeRuns,
                stamina: minRuns * 40,
                resourceCheck: verifyResources(minRuns),
                efficiency: totalEfficiency,
                directGold: directGold,
                synthGold: synthGold,
                totalGold: directGold + synthGold,
                bufferRate: bufferRate
            };
        }

        // Legacy function wrapper for compatibility
        function calculateOptimalDomainRuns(required) {
            // If no gold needed, use simple calculation
            if (required.gold === 0) {
                const greenRuns = required.green > 0 ? Math.ceil(required.green / domainDropRates.green) : 0;
                const blueRuns = required.blue > 0 ? Math.ceil(required.blue / domainDropRates.blue) : 0;
                const purpleRuns = required.purple > 0 ? Math.ceil(required.purple / domainDropRates.purple) : 0;
                const runs = Math.max(greenRuns, blueRuns, purpleRuns);
                
                return {
                    runs: runs,
                    stamina: runs * domainDropRates.stamina,
                    directGold: runs * domainDropRates.gold,
                    synthesisPath: runs > 0 ? "無需金色素材合成" : "無需刷取",
                    totalGold: runs * domainDropRates.gold,
                    synthGold: 0,
                    oldMethodRuns: runs,
                    remaining: {
                        green: Math.max(0, runs * domainDropRates.green - required.green),
                        blue: Math.max(0, runs * domainDropRates.blue - required.blue),
                        purple: Math.max(0, runs * domainDropRates.purple - required.purple)
                    }
                };
            }

            // Use new dynamic algorithm for gold requirements
            const currentMaterials = {
                green: parseInt(document.getElementById('current-green').value) || 0,
                blue: parseInt(document.getElementById('current-blue').value) || 0,
                purple: parseInt(document.getElementById('current-purple').value) || 0,
                gold: parseInt(document.getElementById('current-gold').value) || 0
            };

            const domainResult = calculateDomainRuns(required.gold, currentMaterials);
            
            return {
                runs: domainResult.minRuns,
                safeRuns: domainResult.safeRuns,
                stamina: domainResult.stamina,
                directGold: domainResult.directGold,
                synthGold: domainResult.synthGold,
                totalGold: domainResult.totalGold,
                efficiency: domainResult.efficiency,
                resourceCheck: domainResult.resourceCheck,
                bufferRate: domainResult.bufferRate
            };
        }

        // Initialize sliders and buttons
        function initializeSliders() {
            const sliders = ['skill1', 'skill2', 'skill3', 'skill4', 'skill5'];
            sliders.forEach(id => {
                const slider = document.getElementById(id);
                const valueDisplay = document.getElementById(id + '-value');
                
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value;
                    calculateRequirements();
                });
            });

            // Initialize weapon slider
            const weaponSlider = document.getElementById('weapon');
            const weaponValueDisplay = document.getElementById('weapon-value');
            
            weaponSlider.addEventListener('input', function() {
                const sliderValue = parseInt(this.value);
                const weaponLevel = weaponLevels[sliderValue];
                const suffix = currentLanguage === 'zh' ? '級' : '';
                weaponValueDisplay.textContent = weaponLevel + suffix;
                window.currentWeaponLevel = weaponLevel;
                calculateRequirements();
            });

            // Initialize skill level quick buttons
            document.getElementById('skill-level-6').addEventListener('click', function() {
                setAllSkillLevels(6);
            });
            document.getElementById('skill-level-8').addEventListener('click', function() {
                setAllSkillLevels(8);
            });
            document.getElementById('skill-level-10').addEventListener('click', function() {
                setAllSkillLevels(10);
            });

            // Initialize current holdings inputs with auto-calculation
            const inputs = ['current-green', 'current-blue', 'current-purple', 'current-gold'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    updateStatusTable();
                    // Auto-trigger calculation after a short delay
                    clearTimeout(window.autoCalculateTimeout);
                    window.autoCalculateTimeout = setTimeout(() => {
                        performCalculation();
                    }, 500);
                });
            });

            // Initialize language buttons
            document.getElementById('lang-zh').addEventListener('click', function() {
                updateLanguage('zh');
            });
            document.getElementById('lang-en').addEventListener('click', function() {
                updateLanguage('en');
            });

            // Initialize record buttons
            document.getElementById('save-record-btn').addEventListener('click', saveCurrentRecord);
            document.getElementById('clear-records-btn').addEventListener('click', clearAllRecords);
        }

        // Set all skill levels to a specific value
        function setAllSkillLevels(level) {
            ['skill1', 'skill2', 'skill3', 'skill4', 'skill5'].forEach(id => {
                document.getElementById(id).value = level;
                document.getElementById(id + '-value').textContent = level;
            });
            calculateRequirements();
        }

        // Set weapon level
        function setWeaponLevel(level) {
            const sliderIndex = weaponLevels.indexOf(level);
            if (sliderIndex !== -1) {
                document.getElementById('weapon').value = sliderIndex;
                updateWeaponLevelDisplay();
                window.currentWeaponLevel = level;
                calculateRequirements();
            }
        }

        // Calculate total requirements based on current settings
        function calculateRequirements() {
            let totalReq = {
                green: baseTalentRequirements.green,
                blue: baseTalentRequirements.blue,
                purple: baseTalentRequirements.purple,
                gold: baseTalentRequirements.gold
            };

            // Add skill requirements
            for (let i = 1; i <= 5; i++) {
                const level = parseInt(document.getElementById(`skill${i}`).value);
                for (let l = 1; l < level; l++) {
                    if (skillRequirements[l]) {
                        totalReq.green += skillRequirements[l].green;
                        totalReq.blue += skillRequirements[l].blue;
                        totalReq.purple += skillRequirements[l].purple;
                        totalReq.gold += skillRequirements[l].gold;
                    }
                }
            }

            // Add weapon requirements
            const weaponLevel = window.currentWeaponLevel || 1;
            if (weaponRequirements[weaponLevel]) {
                totalReq.green += weaponRequirements[weaponLevel].green;
                totalReq.blue += weaponRequirements[weaponLevel].blue;
                totalReq.purple += weaponRequirements[weaponLevel].purple;
                totalReq.gold += weaponRequirements[weaponLevel].gold;
            }

            // Update display
            document.getElementById('target-green').textContent = totalReq.green;
            document.getElementById('target-blue').textContent = totalReq.blue;
            document.getElementById('target-purple').textContent = totalReq.purple;
            document.getElementById('target-gold').textContent = totalReq.gold;

            updateStatusTable();
            
            // 即時更新合成策略和執行預覽
            performCalculation();
            
            return totalReq;
        }

        // Update status table
        function updateStatusTable() {
            const targets = {
                green: parseInt(document.getElementById('target-green').textContent),
                blue: parseInt(document.getElementById('target-blue').textContent),
                purple: parseInt(document.getElementById('target-purple').textContent),
                gold: parseInt(document.getElementById('target-gold').textContent)
            };

            const current = {
                green: parseInt(document.getElementById('current-green').value) || 0,
                blue: parseInt(document.getElementById('current-blue').value) || 0,
                purple: parseInt(document.getElementById('current-purple').value) || 0,
                gold: parseInt(document.getElementById('current-gold').value) || 0
            };

            const colors = ['green', 'blue', 'purple', 'gold'];
            colors.forEach(color => {
                document.getElementById(`status-target-${color}`).textContent = targets[color];
                document.getElementById(`status-current-${color}`).textContent = current[color];
                
                const diff = current[color] - targets[color];
                const statusEl = document.getElementById(`status-${color}`);
                
                if (diff >= 0) {
                    statusEl.innerHTML = `<span class="status-success">✓ +${diff}</span>`;
                } else {
                    statusEl.innerHTML = `<span class="status-error">✗ ${diff}</span>`;
                }
            });
        }

        // Reverse algorithm calculation
        function calculateOptimalStrategy() {
            const targets = {
                green: parseInt(document.getElementById('target-green').textContent),
                blue: parseInt(document.getElementById('target-blue').textContent),
                purple: parseInt(document.getElementById('target-purple').textContent),
                gold: parseInt(document.getElementById('target-gold').textContent)
            };

            const current = {
                green: parseInt(document.getElementById('current-green').value) || 0,
                blue: parseInt(document.getElementById('current-blue').value) || 0,
                purple: parseInt(document.getElementById('current-purple').value) || 0,
                gold: parseInt(document.getElementById('current-gold').value) || 0
            };

            // Reverse algorithm implementation
            let strategy = [];
            let finalAmounts = {...current};

            // Step 1: Calculate gold deficit and required purple
            const goldDeficit = Math.max(0, targets.gold - current.gold);
            const purpleNeededForGold = goldDeficit * 3;

            // Step 2: Calculate total purple requirement
            const totalPurpleNeeded = targets.purple + purpleNeededForGold;
            const purpleDeficit = Math.max(0, totalPurpleNeeded - current.purple);
            const blueNeededForPurple = purpleDeficit * 3;

            // Step 3: Calculate total blue requirement
            const totalBlueNeeded = targets.blue + blueNeededForPurple;
            const blueDeficit = Math.max(0, totalBlueNeeded - current.blue);
            const greenNeededForBlue = blueDeficit * 3;

            // Step 4: Calculate available green (must preserve target amount)
            const availableGreen = Math.max(0, current.green - targets.green);

            // Step 5: Execute synthesis strategy
            // Green -> Blue synthesis
            const greenToBlueSynthesis = Math.min(Math.floor(availableGreen / 3), blueDeficit);
            if (greenToBlueSynthesis > 0) {
                const synthText = currentLanguage === 'zh' ? 
                    `綠→藍合成: ${greenToBlueSynthesis} 次 (消耗 ${greenToBlueSynthesis * 3} 綠色 → 獲得 ${greenToBlueSynthesis} 藍色)` :
                    `Green→Blue Synthesis: ${greenToBlueSynthesis} times (Consume ${greenToBlueSynthesis * 3} Green → Get ${greenToBlueSynthesis} Blue)`;
                strategy.push(synthText);
                finalAmounts.green -= greenToBlueSynthesis * 3;
                finalAmounts.blue += greenToBlueSynthesis;
            }

            // Blue -> Purple synthesis
            const availableBlue = finalAmounts.blue - targets.blue;
            const blueToPurpleSynthesis = Math.min(Math.floor(Math.max(0, availableBlue) / 3), purpleDeficit);
            if (blueToPurpleSynthesis > 0) {
                const synthText = currentLanguage === 'zh' ? 
                    `藍→紫合成: ${blueToPurpleSynthesis} 次 (消耗 ${blueToPurpleSynthesis * 3} 藍色 → 獲得 ${blueToPurpleSynthesis} 紫色)` :
                    `Blue→Purple Synthesis: ${blueToPurpleSynthesis} times (Consume ${blueToPurpleSynthesis * 3} Blue → Get ${blueToPurpleSynthesis} Purple)`;
                strategy.push(synthText);
                finalAmounts.blue -= blueToPurpleSynthesis * 3;
                finalAmounts.purple += blueToPurpleSynthesis;
            }

            // Purple -> Gold synthesis
            const availablePurple = finalAmounts.purple - targets.purple;
            const purpleToGoldSynthesis = Math.min(Math.floor(Math.max(0, availablePurple) / 3), goldDeficit);
            if (purpleToGoldSynthesis > 0) {
                const synthText = currentLanguage === 'zh' ? 
                    `紫→金合成: ${purpleToGoldSynthesis} 次 (消耗 ${purpleToGoldSynthesis * 3} 紫色 → 獲得 ${purpleToGoldSynthesis} 金色)` :
                    `Purple→Gold Synthesis: ${purpleToGoldSynthesis} times (Consume ${purpleToGoldSynthesis * 3} Purple → Get ${purpleToGoldSynthesis} Gold)`;
                strategy.push(synthText);
                finalAmounts.purple -= purpleToGoldSynthesis * 3;
                finalAmounts.gold += purpleToGoldSynthesis;
            }

            return {strategy, finalAmounts, targets, current};
        }

        // Generate calculation process details
        function generateCalculationProcess(calculation) {
            const {strategy, finalAmounts, targets, current} = calculation;
            const now = new Date().toLocaleString(currentLanguage === 'zh' ? 'zh-TW' : 'en-US');

            let process = currentLanguage === 'zh' ? 
                `🔍 計算過程詳情\n計算時間: ${now}\n\n` :
                `🔍 Calculation Process Details\nCalculation Time: ${now}\n\n`;

            // 1. 初始狀態
            if (currentLanguage === 'zh') {
                process += `📊 初始狀態:\n`;
                process += `目標需求: 綠${targets.green} 藍${targets.blue} 紫${targets.purple} 金${targets.gold}\n`;
                process += `當前持有: 綠${current.green} 藍${current.blue} 紫${current.purple} 金${current.gold}\n\n`;
            } else {
                process += `📊 Initial State:\n`;
                process += `Target Requirements: Green${targets.green} Blue${targets.blue} Purple${targets.purple} Gold${targets.gold}\n`;
                process += `Current Holdings: Green${current.green} Blue${current.blue} Purple${current.purple} Gold${current.gold}\n\n`;
            }

            // 2. 逆向演算法計算過程
            const goldDeficit = Math.max(0, targets.gold - current.gold);
            if (currentLanguage === 'zh') {
                process += `🧮 逆向演算法計算:\n`;
                process += `步驟1 - 金色素材分析:\n`;
                process += `  金色缺口 = max(0, ${targets.gold} - ${current.gold}) = ${goldDeficit}\n`;
            } else {
                process += `🧮 Reverse Algorithm Calculation:\n`;
                process += `Step 1 - Gold Material Analysis:\n`;
                process += `  Gold Deficit = max(0, ${targets.gold} - ${current.gold}) = ${goldDeficit}\n`;
            }
            
            if (goldDeficit > 0) {
                const purpleNeededForGold = goldDeficit * 3;
                if (currentLanguage === 'zh') {
                    process += `  合成金色需要紫色 = ${goldDeficit} × 3 = ${purpleNeededForGold}\n`;
                } else {
                    process += `  Purple needed for Gold synthesis = ${goldDeficit} × 3 = ${purpleNeededForGold}\n`;
                }
                
                // Step 2: Purple calculation
                const totalPurpleNeeded = targets.purple + purpleNeededForGold;
                const purpleDeficit = Math.max(0, totalPurpleNeeded - current.purple);
                if (currentLanguage === 'zh') {
                    process += `步驟2 - 紫色素材分析:\n`;
                    process += `  紫色總需求 = ${targets.purple} + ${purpleNeededForGold} = ${totalPurpleNeeded}\n`;
                    process += `  紫色缺口 = max(0, ${totalPurpleNeeded} - ${current.purple}) = ${purpleDeficit}\n`;
                } else {
                    process += `Step 2 - Purple Material Analysis:\n`;
                    process += `  Total Purple needed = ${targets.purple} + ${purpleNeededForGold} = ${totalPurpleNeeded}\n`;
                    process += `  Purple deficit = max(0, ${totalPurpleNeeded} - ${current.purple}) = ${purpleDeficit}\n`;
                }
                
                if (purpleDeficit > 0) {
                    const blueNeededForPurple = purpleDeficit * 3;
                    if (currentLanguage === 'zh') {
                        process += `  合成紫色需要藍色 = ${purpleDeficit} × 3 = ${blueNeededForPurple}\n`;
                    } else {
                        process += `  Blue needed for Purple synthesis = ${purpleDeficit} × 3 = ${blueNeededForPurple}\n`;
                    }
                    
                    // Step 3: Blue calculation
                    const totalBlueNeeded = targets.blue + blueNeededForPurple;
                    const blueDeficit = Math.max(0, totalBlueNeeded - current.blue);
                    if (currentLanguage === 'zh') {
                        process += `步驟3 - 藍色素材分析:\n`;
                        process += `  藍色總需求 = ${targets.blue} + ${blueNeededForPurple} = ${totalBlueNeeded}\n`;
                        process += `  藍色缺口 = max(0, ${totalBlueNeeded} - ${current.blue}) = ${blueDeficit}\n`;
                    } else {
                        process += `Step 3 - Blue Material Analysis:\n`;
                        process += `  Total Blue needed = ${targets.blue} + ${blueNeededForPurple} = ${totalBlueNeeded}\n`;
                        process += `  Blue deficit = max(0, ${totalBlueNeeded} - ${current.blue}) = ${blueDeficit}\n`;
                    }
                    
                    if (blueDeficit > 0) {
                        const greenNeededForBlue = blueDeficit * 3;
                        const availableGreen = Math.max(0, current.green - targets.green);
                        if (currentLanguage === 'zh') {
                            process += `步驟4 - 綠色素材分析:\n`;
                            process += `  合成藍色需要綠色 = ${blueDeficit} × 3 = ${greenNeededForBlue}\n`;
                            process += `  可用綠色 = max(0, ${current.green} - ${targets.green}) = ${availableGreen}\n`;
                            process += `  綠色合成能力 = min(${Math.floor(availableGreen / 3)}, ${blueDeficit}) = ${Math.min(Math.floor(availableGreen / 3), blueDeficit)}\n`;
                        } else {
                            process += `Step 4 - Green Material Analysis:\n`;
                            process += `  Green needed for Blue synthesis = ${blueDeficit} × 3 = ${greenNeededForBlue}\n`;
                            process += `  Available Green = max(0, ${current.green} - ${targets.green}) = ${availableGreen}\n`;
                            process += `  Green synthesis capacity = min(${Math.floor(availableGreen / 3)}, ${blueDeficit}) = ${Math.min(Math.floor(availableGreen / 3), blueDeficit)}\n`;
                        }
                    }
                }
            } else {
                if (currentLanguage === 'zh') {
                    process += `  無需金色素材，跳過後續計算\n`;
                } else {
                    process += `  No gold materials needed, skip subsequent calculations\n`;
                }
            }

            process += `\n`;

            // 3. 合成執行過程
            if (strategy.length > 0) {
                if (currentLanguage === 'zh') {
                    process += `⚙️ 合成執行過程:\n`;
                } else {
                    process += `⚙️ Synthesis Execution Process:\n`;
                }
                let tempAmounts = {...current};
                
                strategy.forEach((step, index) => {
                    if (currentLanguage === 'zh') {
                        process += `執行步驟 ${index + 1}: ${step}\n`;
                    } else {
                        process += `Execution Step ${index + 1}: ${step}\n`;
                    }
                    
                    if (step.includes('綠→藍') || step.includes('Green→Blue')) {
                        const matches = step.match(/(\d+)/g);
                        if (matches && matches.length >= 3) {
                            const times = parseInt(matches[0]);
                            const greenUsed = parseInt(matches[1]);
                            const blueGained = parseInt(matches[2]);
                            tempAmounts.green -= greenUsed;
                            tempAmounts.blue += blueGained;
                            if (currentLanguage === 'zh') {
                                process += `  執行後: 綠${tempAmounts.green} 藍${tempAmounts.blue}\n`;
                            } else {
                                process += `  After execution: Green${tempAmounts.green} Blue${tempAmounts.blue}\n`;
                            }
                        }
                    } else if (step.includes('藍→紫') || step.includes('Blue→Purple')) {
                        const matches = step.match(/(\d+)/g);
                        if (matches && matches.length >= 3) {
                            const times = parseInt(matches[0]);
                            const blueUsed = parseInt(matches[1]);
                            const purpleGained = parseInt(matches[2]);
                            tempAmounts.blue -= blueUsed;
                            tempAmounts.purple += purpleGained;
                            if (currentLanguage === 'zh') {
                                process += `  執行後: 藍${tempAmounts.blue} 紫${tempAmounts.purple}\n`;
                            } else {
                                process += `  After execution: Blue${tempAmounts.blue} Purple${tempAmounts.purple}\n`;
                            }
                        }
                    } else if (step.includes('紫→金') || step.includes('Purple→Gold')) {
                        const matches = step.match(/(\d+)/g);
                        if (matches && matches.length >= 3) {
                            const times = parseInt(matches[0]);
                            const purpleUsed = parseInt(matches[1]);
                            const goldGained = parseInt(matches[2]);
                            tempAmounts.purple -= purpleUsed;
                            tempAmounts.gold += goldGained;
                            if (currentLanguage === 'zh') {
                                process += `  執行後: 紫${tempAmounts.purple} 金${tempAmounts.gold}\n`;
                            } else {
                                process += `  After execution: Purple${tempAmounts.purple} Gold${tempAmounts.gold}\n`;
                            }
                        }
                    }
                });
            } else {
                if (currentLanguage === 'zh') {
                    process += `⚙️ 無需執行合成操作\n`;
                } else {
                    process += `⚙️ No synthesis operations needed\n`;
                }
            }

            process += `\n`;

            // 4. 最終結果驗證
            if (currentLanguage === 'zh') {
                process += `✅ 最終結果驗證:\n`;
                process += `合成後持有: 綠${Math.floor(finalAmounts.green)} 藍${Math.floor(finalAmounts.blue)} 紫${Math.floor(finalAmounts.purple)} 金${Math.floor(finalAmounts.gold)}\n`;
                process += `目標需求: 綠${targets.green} 藍${targets.blue} 紫${targets.purple} 金${targets.gold}\n`;
            } else {
                process += `✅ Final Result Verification:\n`;
                process += `After synthesis: Green${Math.floor(finalAmounts.green)} Blue${Math.floor(finalAmounts.blue)} Purple${Math.floor(finalAmounts.purple)} Gold${Math.floor(finalAmounts.gold)}\n`;
                process += `Target requirements: Green${targets.green} Blue${targets.blue} Purple${targets.purple} Gold${targets.gold}\n`;
            }
            
            const finalShortages = {
                green: Math.max(0, targets.green - finalAmounts.green),
                blue: Math.max(0, targets.blue - finalAmounts.blue),
                purple: Math.max(0, targets.purple - finalAmounts.purple),
                gold: Math.max(0, targets.gold - finalAmounts.gold)
            };
            
            if (currentLanguage === 'zh') {
                process += `剩餘缺口: 綠${finalShortages.green} 藍${finalShortages.blue} 紫${finalShortages.purple} 金${finalShortages.gold}\n`;
            } else {
                process += `Remaining deficit: Green${finalShortages.green} Blue${finalShortages.blue} Purple${finalShortages.purple} Gold${finalShortages.gold}\n`;
            }

            return process;
        }

        // Generate simplified report
        function generateReport(calculation) {
            const {strategy, finalAmounts, targets, current} = calculation;
            const now = new Date().toLocaleString(currentLanguage === 'zh' ? 'zh-TW' : 'en-US');

            // 計算素材缺口（在報告開始就計算）
            const shortages = {
                green: Math.max(0, targets.green - finalAmounts.green),
                blue: Math.max(0, targets.blue - finalAmounts.blue),
                purple: Math.max(0, targets.purple - finalAmounts.purple),
                gold: Math.max(0, targets.gold - finalAmounts.gold)
            };

            let report = currentLanguage === 'zh' ?
                `🎯 素材需求分析報告\n生成時間: ${now}\n\n` :
                `🎯 Material Requirement Analysis Report\nGeneration Time: ${now}\n\n`;

            // 1. 資源狀態 - 簡化顯示
            if (currentLanguage === 'zh') {
                report += `📊 資源狀態\n`;
            } else {
                report += `📊 Resource Status\n`;
            }

            const colors = [
                {name: '🟢綠', key: 'green', nameEn: '🟢Green'},
                {name: '🔵藍', key: 'blue', nameEn: '🔵Blue'}, 
                {name: '🟣紫', key: 'purple', nameEn: '🟣Purple'},
                {name: '🟡金', key: 'gold', nameEn: '🟡Gold'}
            ];

            let statusLine = '';
            colors.forEach(({name, key, nameEn}) => {
                const diff = current[key] - targets[key];
                const displayName = currentLanguage === 'zh' ? name : nameEn;
                if (diff >= 0) {
                    statusLine += `${displayName}✓ `;
                } else {
                    const deficitText = currentLanguage === 'zh' ? '缺' : 'need';
                    statusLine += `${displayName}${deficitText}${Math.abs(diff)} `;
                }
            });
            report += statusLine + '\n\n';

            // 2. 合成策略 - 簡化顯示
            if (strategy.length === 0) {
                // 檢查是否有任何素材缺口
                const hasAnyShortage = Object.values(shortages).some(shortage => shortage > 0);
                if (hasAnyShortage) {
                    if (currentLanguage === 'zh') {
                        report += `🔄 無需合成\n\n`;
                    } else {
                        report += `🔄 No synthesis needed\n\n`;
                    }
                } else {
                    if (currentLanguage === 'zh') {
                        report += `✅ 無需合成，資源已足夠\n\n`;
                    } else {
                        report += `✅ No synthesis needed, resources are sufficient\n\n`;
                    }
                }
            } else {
                if (currentLanguage === 'zh') {
                    report += `🔄 合成策略\n`;
                } else {
                    report += `🔄 Synthesis Strategy\n`;
                }
                strategy.forEach((step, index) => {
                    if (currentLanguage === 'zh') {
                        if (step.includes('綠→藍')) {
                            const matches = step.match(/(\d+) 綠色.*?(\d+) 藍色/);
                            if (matches) report += `• 用${matches[1]}綠 → 得${matches[2]}藍\n`;
                        } else if (step.includes('藍→紫')) {
                            const matches = step.match(/(\d+) 藍色.*?(\d+) 紫色/);
                            if (matches) report += `• 用${matches[1]}藍 → 得${matches[2]}紫\n`;
                        } else if (step.includes('紫→金')) {
                            const matches = step.match(/(\d+) 紫色.*?(\d+) 金色/);
                            if (matches) report += `• 用${matches[1]}紫 → 得${matches[2]}金\n`;
                        }
                    } else {
                        if (step.includes('Green→Blue')) {
                            const matches = step.match(/(\d+) Green.*?(\d+) Blue/);
                            if (matches) report += `• Use ${matches[1]}Green → Get ${matches[2]}Blue\n`;
                        } else if (step.includes('Blue→Purple')) {
                            const matches = step.match(/(\d+) Blue.*?(\d+) Purple/);
                            if (matches) report += `• Use ${matches[1]}Blue → Get ${matches[2]}Purple\n`;
                        } else if (step.includes('Purple→Gold')) {
                            const matches = step.match(/(\d+) Purple.*?(\d+) Gold/);
                            if (matches) report += `• Use ${matches[1]}Purple → Get ${matches[2]}Gold\n`;
                        }
                    }
                });
                report += '\n';
            }

            // 3. 凝素領域建議 - 包含減負途徑和活動建議
            if (shortages.gold === 0 && shortages.purple === 0 && shortages.blue === 0 && shortages.green === 0) {
                if (currentLanguage === 'zh') {
                    report += `🎉 完美！無需刷取凝素領域\n`;
                } else {
                    report += `🎉 Perfect! No need to farm Tacet Fields\n`;
                }
            } else {
                if (currentLanguage === 'zh') {
                    report += `⚡ 凝素領域建議\n`;
                } else {
                    report += `⚡ Tacet Field Recommendations\n`;
                }
                
                if (shortages.gold > 0) {
                    const domainResult = calculateDomainRuns(shortages.gold, current);
                    if (currentLanguage === 'zh') {
                        report += `缺口: ${shortages.gold}金\n`;
                    } else {
                        report += `Deficit: ${shortages.gold} Gold\n`;
                    }
                    
                    // 計算活動雙倍掉落建議
                    const doubleDropRuns = Math.ceil(domainResult.minRuns / 2);
                    const dailyLimit = 3;
                    const doubleDropDays = Math.ceil(doubleDropRuns / dailyLimit);
                    
                    // 計算減負途徑建議
                    const reducedRuns = Math.ceil(domainResult.minRuns / 2);
                    
                    if (currentLanguage === 'zh') {
                        report += `\n📋 刷取方案:\n`;
                        report += `• 常規(40體/場): ${domainResult.minRuns}場 (${domainResult.minRuns * 40}體力) - 理論最少場次\n`;
                        report += `• 安全(40體/場): ${domainResult.safeRuns}場 (${domainResult.safeRuns * 40}體力) - 含緩衝保險\n`;
                        
                        if (doubleDropRuns <= dailyLimit) {
                            report += `• 活動雙倍(40體/場): ${doubleDropRuns}場 (${doubleDropRuns * 40}體力) - 1天內完成\n`;
                        } else {
                            const remainingRuns = domainResult.minRuns - (dailyLimit * 2 * doubleDropDays);
                            if (remainingRuns > 0) {
                                report += `• 活動雙倍(40體/場): ${dailyLimit}場×${doubleDropDays}天 + 常規${remainingRuns}場\n`;
                                report += `  總計: ${(dailyLimit * doubleDropDays * 40) + (remainingRuns * 40)}體力\n`;
                            } else {
                                report += `• 活動雙倍(40體/場): ${dailyLimit}場×${doubleDropDays}天 (${dailyLimit * doubleDropDays * 40}體力)\n`;
                            }
                        }
                        
                        report += `• 減負途徑(80體/場): ${reducedRuns}場 (${reducedRuns * 80}體力) - 2倍素材掉落\n`;
                    } else {
                        report += `\n📋 Farming Options:\n`;
                        report += `• Normal(40 stamina/run): ${domainResult.minRuns} runs (${domainResult.minRuns * 40} stamina) - Theoretical minimum\n`;
                        report += `• Safe(40 stamina/run): ${domainResult.safeRuns} runs (${domainResult.safeRuns * 40} stamina) - With buffer insurance\n`;
                        
                        if (doubleDropRuns <= dailyLimit) {
                            report += `• Event Double(40 stamina/run): ${doubleDropRuns} runs (${doubleDropRuns * 40} stamina) - Complete in 1 day\n`;
                        } else {
                            const remainingRuns = domainResult.minRuns - (dailyLimit * 2 * doubleDropDays);
                            if (remainingRuns > 0) {
                                report += `• Event Double(40 stamina/run): ${dailyLimit} runs×${doubleDropDays} days + Normal ${remainingRuns} runs\n`;
                                report += `  Total: ${(dailyLimit * doubleDropDays * 40) + (remainingRuns * 40)} stamina\n`;
                            } else {
                                report += `• Event Double(40 stamina/run): ${dailyLimit} runs×${doubleDropDays} days (${dailyLimit * doubleDropDays * 40} stamina)\n`;
                            }
                        }
                        
                        report += `• Reduced Load(80 stamina/run): ${reducedRuns} runs (${reducedRuns * 80} stamina) - 2x material drops\n`;
                    }
                    
                } else if (shortages.purple > 0) {
                    const runs = Math.ceil(shortages.purple / 1.59);
                    const doubleRuns = Math.ceil(runs / 2);
                    const reducedRuns = Math.ceil(runs / 2);
                    
                    if (currentLanguage === 'zh') {
                        report += `缺口: ${shortages.purple}紫\n`;
                        report += `• 常規(40體/場): ${runs}場 (${runs * 40}體力)\n`;
                        report += `• 活動雙倍(40體/場): ${doubleRuns}場 (${doubleRuns * 40}體力)\n`;
                        report += `• 減負途徑(80體/場): ${reducedRuns}場 (${reducedRuns * 80}體力)\n`;
                    } else {
                        report += `Deficit: ${shortages.purple} Purple\n`;
                        report += `• Normal(40 stamina/run): ${runs} runs (${runs * 40} stamina)\n`;
                        report += `• Event Double(40 stamina/run): ${doubleRuns} runs (${doubleRuns * 40} stamina)\n`;
                        report += `• Reduced Load(80 stamina/run): ${reducedRuns} runs (${reducedRuns * 80} stamina)\n`;
                    }
                    
                } else if (shortages.blue > 0) {
                    const runs = Math.ceil(shortages.blue / 8.00);
                    const doubleRuns = Math.ceil(runs / 2);
                    const reducedRuns = Math.ceil(runs / 2);
                    
                    if (currentLanguage === 'zh') {
                        report += `缺口: ${shortages.blue}藍\n`;
                        report += `• 常規(40體/場): ${runs}場 (${runs * 40}體力)\n`;
                        report += `• 活動雙倍(40體/場): ${doubleRuns}場 (${doubleRuns * 40}體力)\n`;
                        report += `• 減負途徑(80體/場): ${reducedRuns}場 (${reducedRuns * 80}體力)\n`;
                    } else {
                        report += `Deficit: ${shortages.blue} Blue\n`;
                        report += `• Normal(40 stamina/run): ${runs} runs (${runs * 40} stamina)\n`;
                        report += `• Event Double(40 stamina/run): ${doubleRuns} runs (${doubleRuns * 40} stamina)\n`;
                        report += `• Reduced Load(80 stamina/run): ${reducedRuns} runs (${reducedRuns * 80} stamina)\n`;
                    }
                    
                } else if (shortages.green > 0) {
                    const runs = Math.ceil(shortages.green / 6.42);
                    const doubleRuns = Math.ceil(runs / 2);
                    const reducedRuns = Math.ceil(runs / 2);
                    
                    if (currentLanguage === 'zh') {
                        report += `缺口: ${shortages.green}綠\n`;
                        report += `• 常規(40體/場): ${runs}場 (${runs * 40}體力)\n`;
                        report += `• 活動雙倍(40體/場): ${doubleRuns}場 (${doubleRuns * 40}體力)\n`;
                        report += `• 減負途徑(80體/場): ${reducedRuns}場 (${reducedRuns * 80}體力)\n`;
                    } else {
                        report += `Deficit: ${shortages.green} Green\n`;
                        report += `• Normal(40 stamina/run): ${runs} runs (${runs * 40} stamina)\n`;
                        report += `• Event Double(40 stamina/run): ${doubleRuns} runs (${doubleRuns * 40} stamina)\n`;
                        report += `• Reduced Load(80 stamina/run): ${reducedRuns} runs (${reducedRuns * 80} stamina)\n`;
                    }
                }
            }

            return report;
        }

        // Update execution preview - only shows synthesis results, not domain farming
        function updateExecutionPreview(calculation) {
            const {current, targets} = calculation;
            
            // Simulate only the synthesis strategy execution
            let simulatedAmounts = {...current};
            
            // Execute the same synthesis logic as in calculateOptimalStrategy
            const goldDeficit = Math.max(0, targets.gold - current.gold);
            const purpleNeededForGold = goldDeficit * 3;
            const totalPurpleNeeded = targets.purple + purpleNeededForGold;
            const purpleDeficit = Math.max(0, totalPurpleNeeded - current.purple);
            const blueNeededForPurple = purpleDeficit * 3;
            const totalBlueNeeded = targets.blue + blueNeededForPurple;
            const blueDeficit = Math.max(0, totalBlueNeeded - current.blue);
            const availableGreen = Math.max(0, current.green - targets.green);

            // Green -> Blue synthesis
            const greenToBlueSynthesis = Math.min(Math.floor(availableGreen / 3), blueDeficit);
            if (greenToBlueSynthesis > 0) {
                simulatedAmounts.green -= greenToBlueSynthesis * 3;
                simulatedAmounts.blue += greenToBlueSynthesis;
            }

            // Blue -> Purple synthesis
            const availableBlue = simulatedAmounts.blue - targets.blue;
            const blueToPurpleSynthesis = Math.min(Math.floor(Math.max(0, availableBlue) / 3), purpleDeficit);
            if (blueToPurpleSynthesis > 0) {
                simulatedAmounts.blue -= blueToPurpleSynthesis * 3;
                simulatedAmounts.purple += blueToPurpleSynthesis;
            }

            // Purple -> Gold synthesis
            const availablePurple = simulatedAmounts.purple - targets.purple;
            const purpleToGoldSynthesis = Math.min(Math.floor(Math.max(0, availablePurple) / 3), goldDeficit);
            if (purpleToGoldSynthesis > 0) {
                simulatedAmounts.purple -= purpleToGoldSynthesis * 3;
                simulatedAmounts.gold += purpleToGoldSynthesis;
            }
            
            // Update display with synthesis-only results
            const colors = ['green', 'blue', 'purple', 'gold'];
            colors.forEach(color => {
                const final = Math.floor(simulatedAmounts[color]);
                const target = targets[color];
                const diff = final - target;
                
                const unitText = currentLanguage === 'zh' ? ' 個' : '';
                document.getElementById(`preview-${color}`).textContent = final + unitText;
                
                if (diff >= 0) {
                    const statusText = currentLanguage === 'zh' ? `✓ 達標 +${diff}` : `✓ Met +${diff}`;
                    document.getElementById(`preview-${color}-status`).textContent = statusText;
                    document.getElementById(`preview-${color}-status`).className = 'text-xs opacity-90 text-green-600';
                } else {
                    const statusText = currentLanguage === 'zh' ? `✗ 不足 ${Math.abs(diff)}` : `✗ Short ${Math.abs(diff)}`;
                    document.getElementById(`preview-${color}-status`).textContent = statusText;
                    document.getElementById(`preview-${color}-status`).className = 'text-xs opacity-90 text-red-600';
                }
            });
        }

        // Perform calculation function (used by both auto-calculation and manual trigger)
        function performCalculation() {
            // 檢查是否有持有數量輸入，避免在初始化時顯示錯誤信息
            const hasInput = ['current-green', 'current-blue', 'current-purple', 'current-gold']
                .some(id => parseInt(document.getElementById(id).value) > 0);
            
            if (!hasInput) {
                // 如果沒有輸入持有數量，顯示提示信息
                const placeholderText = getNestedValue(i18nData[currentLanguage], 'strategy.placeholder');
                document.getElementById('strategy-display').innerHTML = `<div class="bg-gray-50 rounded-lg p-4 text-center border-2 border-dashed border-gray-300"><p class="card-content text-base">${placeholderText}</p></div>`;
                document.getElementById('report-content').textContent = getNestedValue(i18nData[currentLanguage], 'report.placeholder');
                
                // 重置執行預覽
                ['green', 'blue', 'purple', 'gold'].forEach(color => {
                    document.getElementById(`preview-${color}`).textContent = '-';
                    document.getElementById(`preview-${color}-status`).textContent = '-';
                    document.getElementById(`preview-${color}-status`).className = 'text-xs card-content';
                });
                return;
            }

            const calculation = calculateOptimalStrategy();
            const {strategy, current, targets} = calculation;

            // 檢查是否有嚴重素材不足的情況
            const shortages = {
                green: Math.max(0, targets.green - current.green),
                blue: Math.max(0, targets.blue - current.blue),
                purple: Math.max(0, targets.purple - current.purple),
                gold: Math.max(0, targets.gold - current.gold)
            };

            // Update strategy display
            const strategyDisplay = document.getElementById('strategy-display');
            
            if (strategy.length === 0) {
                const noSynthesisText = getNestedValue(i18nData[currentLanguage], 'strategy.noSynthesis');
                strategyDisplay.innerHTML = `<p class="text-green-600 font-semibold">${noSynthesisText}</p>`;
            } else {
                strategyDisplay.innerHTML = strategy.map(step => 
                    `<div class="bg-blue-50 p-2 rounded border-l-4 border-blue-400">${step}</div>`
                ).join('');
            }

            // Update execution preview
            updateExecutionPreview(calculation);

            // Generate and display report
            const report = generateReport(calculation);
            document.getElementById('report-content').textContent = report;

            // Generate and display calculation process
            const process = generateCalculationProcess(calculation);
            document.getElementById('calculation-process').textContent = process;
        }

        // Event listeners
        document.getElementById('max-cultivation-btn').addEventListener('click', function() {
            this.classList.add('pulse-animation');
            setTimeout(() => this.classList.remove('pulse-animation'), 1000);

            // Set all skills to maximum level
            setAllSkillLevels(10);
            
            // Set weapon to maximum level
            setWeaponLevel(90);
            
            // Recalculate requirements and perform calculation
            calculateRequirements();
            performCalculation();
        });

        document.getElementById('reset-default-btn').addEventListener('click', function() {
            // Reset to character + weapon full requirements
            setAllSkillLevels(10);
            setWeaponLevel(90);
            
            calculateRequirements();
        });

        document.getElementById('reset-all-btn').addEventListener('click', function() {
            // Reset everything to initial state
            setAllSkillLevels(1);
            setWeaponLevel(1);
            
            ['current-green', 'current-blue', 'current-purple', 'current-gold'].forEach(id => {
                document.getElementById(id).value = 0;
            });

            const placeholderText = getNestedValue(i18nData[currentLanguage], 'strategy.placeholder');
            document.getElementById('strategy-display').innerHTML = `<div class="bg-gray-50 rounded-lg p-4 text-center border-2 border-dashed border-gray-300"><p class="card-content text-base">${placeholderText}</p></div>`;
            document.getElementById('report-content').textContent = getNestedValue(i18nData[currentLanguage], 'report.placeholder');
            
            // Reset execution preview
            ['green', 'blue', 'purple', 'gold'].forEach(color => {
                document.getElementById(`preview-${color}`).textContent = '-';
                document.getElementById(`preview-${color}-status`).textContent = '-';
            });
            
            calculateRequirements();
        });

        document.getElementById('copy-report-btn').addEventListener('click', async function() {
            const reportContent = document.getElementById('report-content').textContent;
            
            try {
                await navigator.clipboard.writeText(reportContent);
                
                const originalText = this.textContent;
                const copiedText = getNestedValue(i18nData[currentLanguage], 'messages.reportCopied');
                this.textContent = copiedText;
                this.classList.add('pulse-animation');
                
                setTimeout(() => {
                    this.textContent = originalText;
                    this.classList.remove('pulse-animation');
                }, 2000);
            } catch (err) {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = reportContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const originalText = this.textContent;
                const copiedText = getNestedValue(i18nData[currentLanguage], 'messages.reportCopied');
                this.textContent = copiedText;
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
            }
        });

        // Initialize the application
        function initializeApp() {
            // Load saved language preference
            const savedLang = localStorage.getItem('wuthering-waves-language') || 'zh';
            currentLanguage = savedLang;
            
            // Initialize current weapon level
            window.currentWeaponLevel = 1;
            
            // Initialize all components
            initializeSliders();
            updateLanguage(savedLang);
            calculateRequirements();
            renderRecords();
        }

        // Start the application
        initializeApp();
    </script>
</body>
</html>
