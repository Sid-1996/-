<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sidçš„é³´æ½®æ™ºæ…§ç´ æéœ€æ±‚è¨ˆç®—å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .card-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .card-content {
            color: #34495e;
        }
        
        .material-green { color: #27ae60; }
        .material-blue { color: #3498db; }
        .material-purple { color: #9b59b6; }
        .material-gold { color: #f39c12; }
        
        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .slider-track {
            background: linear-gradient(to right, #bdc3c7 0%, #3498db 100%);
            height: 6px;
            border-radius: 3px;
        }
        
        .input-field {
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 10px 15px;
            transition: border-color 0.3s ease;
            background: white;
        }
        
        .input-field:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .status-success {
            color: #27ae60;
            font-weight: 600;
        }
        
        .status-error {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .report-section {
            background: rgba(255, 255, 255, 0.95);
            color: #2c3e50;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header-title {
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header-subtitle {
            color: rgba(255,255,255,0.9);
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold header-title mb-2">ğŸ® Sidçš„é³´æ½®æ™ºæ…§ç´ æéœ€æ±‚è¨ˆç®—å™¨</h1>
            <p class="header-subtitle">é€†å‘æ¼”ç®—æ³•å„ªåŒ– â€¢ æ™ºæ…§åˆæˆç­–ç•¥ â€¢ é›¶æµªè²»è³‡æºé…ç½®</p>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- Left Column: Controls -->
            <div class="xl:col-span-2 space-y-6">
                <!-- Character Skills Section -->
                <div class="card">
                    <div class="flex flex-wrap items-center justify-between mb-4">
                        <h2 class="text-2xl card-title flex items-center">
                            âš”ï¸ è§’è‰²æŠ€èƒ½ç­‰ç´šè¨­å®š
                        </h2>
                        <div class="flex gap-2 mt-2 sm:mt-0">
                            <button id="skill-level-6" class="btn-secondary">
                                6ç­‰
                            </button>
                            <button id="skill-level-8" class="btn-secondary">
                                8ç­‰
                            </button>
                            <button id="skill-level-10" class="btn-secondary">
                                10ç­‰
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="skill-control">
                            <label class="block text-sm font-medium card-content mb-2">å¸¸æ…‹æ”»æ“Š</label>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm card-content">1</span>
                                <input type="range" id="skill1" min="1" max="10" value="1" 
                                       class="flex-1 h-2 rounded-lg appearance-none cursor-pointer slider-track">
                                <span class="text-sm card-content">10</span>
                                <span id="skill1-value" class="text-lg font-semibold material-blue w-8">1</span>
                            </div>
                        </div>
                        <div class="skill-control">
                            <label class="block text-sm font-medium card-content mb-2">å…±é³´æŠ€èƒ½</label>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm card-content">1</span>
                                <input type="range" id="skill2" min="1" max="10" value="1" 
                                       class="flex-1 h-2 rounded-lg appearance-none cursor-pointer slider-track">
                                <span class="text-sm card-content">10</span>
                                <span id="skill2-value" class="text-lg font-semibold material-blue w-8">1</span>
                            </div>
                        </div>
                        <div class="skill-control">
                            <label class="block text-sm font-medium card-content mb-2">å…±é³´è§£æ”¾</label>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm card-content">1</span>
                                <input type="range" id="skill3" min="1" max="10" value="1" 
                                       class="flex-1 h-2 rounded-lg appearance-none cursor-pointer slider-track">
                                <span class="text-sm card-content">10</span>
                                <span id="skill3-value" class="text-lg font-semibold material-blue w-8">1</span>
                            </div>
                        </div>
                        <div class="skill-control">
                            <label class="block text-sm font-medium card-content mb-2">è®Šå¥æŠ€èƒ½</label>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm card-content">1</span>
                                <input type="range" id="skill4" min="1" max="10" value="1" 
                                       class="flex-1 h-2 rounded-lg appearance-none cursor-pointer slider-track">
                                <span class="text-sm card-content">10</span>
                                <span id="skill4-value" class="text-lg font-semibold material-blue w-8">1</span>
                            </div>
                        </div>
                        <div class="skill-control md:col-span-2">
                            <label class="block text-sm font-medium card-content mb-2">å…±é³´è¿´è·¯</label>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm card-content">1</span>
                                <input type="range" id="skill5" min="1" max="10" value="1" 
                                       class="flex-1 h-2 rounded-lg appearance-none cursor-pointer slider-track">
                                <span class="text-sm card-content">10</span>
                                <span id="skill5-value" class="text-lg font-semibold material-blue w-8">1</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weapon Level Section -->
                <div class="card">
                    <h2 class="text-2xl card-title flex items-center">
                        ğŸ—¡ï¸ æ­¦å™¨çªç ´ç­‰ç´šè¨­å®š
                    </h2>
                    <div class="skill-control">
                        <label class="block text-sm font-medium card-content mb-2">æ­¦å™¨ç­‰ç´š</label>
                        <div class="flex items-center space-x-3">
                            <span class="text-sm card-content">1</span>
                            <input type="range" id="weapon" min="0" max="6" value="0" step="1"
                                   class="flex-1 h-2 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content">90</span>
                            <span id="weapon-value" class="text-lg font-semibold material-purple w-12">1ç´š</span>
                        </div>
                    </div>
                </div>

                <!-- Target Requirements -->
                <div class="card" style="padding: 20px;">
                    <h2 class="text-lg card-title flex items-center">
                        ğŸ¯ ç›®æ¨™éœ€æ±‚
                    </h2>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="flex items-center card-content"><span class="text-base mr-1">ğŸŸ¢</span>ç¶ è‰²</span>
                            <span id="target-green" class="font-bold material-green">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="flex items-center card-content"><span class="text-base mr-1">ğŸ”µ</span>è—è‰²</span>
                            <span id="target-blue" class="font-bold material-blue">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="flex items-center card-content"><span class="text-base mr-1">ğŸŸ£</span>ç´«è‰²</span>
                            <span id="target-purple" class="font-bold material-purple">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="flex items-center card-content"><span class="text-base mr-1">ğŸŸ¡</span>é‡‘è‰²</span>
                            <span id="target-gold" class="font-bold material-gold">0</span>
                        </div>
                    </div>
                </div>

                <!-- Current Holdings Section -->
                <div class="card">
                    <h2 class="text-2xl card-title flex items-center">
                        ğŸ“¦ ç•¶å‰æŒæœ‰æ•¸é‡
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="bg-green-50 rounded-lg p-3 mb-2 border-2 border-green-100">
                                <span class="text-2xl">ğŸŸ¢</span>
                                <p class="text-sm font-medium material-green">ç¶ è‰²ç´ æ</p>
                            </div>
                            <input type="number" id="current-green" value="0" min="0" 
                                   class="input-field w-full text-center">
                        </div>
                        <div class="text-center">
                            <div class="bg-blue-50 rounded-lg p-3 mb-2 border-2 border-blue-100">
                                <span class="text-2xl">ğŸ”µ</span>
                                <p class="text-sm font-medium material-blue">è—è‰²ç´ æ</p>
                            </div>
                            <input type="number" id="current-blue" value="0" min="0" 
                                   class="input-field w-full text-center">
                        </div>
                        <div class="text-center">
                            <div class="bg-purple-50 rounded-lg p-3 mb-2 border-2 border-purple-100">
                                <span class="text-2xl">ğŸŸ£</span>
                                <p class="text-sm font-medium material-purple">ç´«è‰²ç´ æ</p>
                            </div>
                            <input type="number" id="current-purple" value="0" min="0" 
                                   class="input-field w-full text-center">
                        </div>
                        <div class="text-center">
                            <div class="bg-yellow-50 rounded-lg p-3 mb-2 border-2 border-yellow-100">
                                <span class="text-2xl">ğŸŸ¡</span>
                                <p class="text-sm font-medium material-gold">é‡‘è‰²ç´ æ</p>
                            </div>
                            <input type="number" id="current-gold" value="0" min="0" 
                                   class="input-field w-full text-center">
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 justify-center">
                    <button id="max-cultivation-btn" class="btn-primary">
                        ğŸ“ ä¸€éµç•¢æ¥­éœ€æ±‚
                    </button>
                    <button id="reset-default-btn" class="btn-success">
                        ğŸ¯ é‡ç½®é è¨­
                    </button>
                    <button id="reset-all-btn" class="btn-secondary" style="padding: 12px 24px;">
                        ğŸ”„ é‡ç½®æ•¸æ“š
                    </button>
                    <button id="copy-report-btn" class="btn-warning">
                        ğŸ“‹ è¤‡è£½å ±å‘Š
                    </button>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="space-y-6">
                <!-- Status Analysis -->
                <div class="card">
                    <h2 class="text-xl card-title flex items-center">
                        ğŸ“Š ç‹€æ…‹åˆ†æ
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b-2 border-gray-200">
                                    <th class="text-left py-3 card-content font-semibold">ç´ æ</th>
                                    <th class="text-center py-3 card-content font-semibold">ç›®æ¨™</th>
                                    <th class="text-center py-3 card-content font-semibold">æŒæœ‰</th>
                                    <th class="text-center py-3 card-content font-semibold">ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody id="status-table">
                                <tr class="border-b border-gray-100">
                                    <td class="py-3 card-content">ğŸŸ¢ ç¶ è‰²</td>
                                    <td class="text-center py-3 card-content" id="status-target-green">0</td>
                                    <td class="text-center py-3 card-content" id="status-current-green">0</td>
                                    <td class="text-center py-3" id="status-green">-</td>
                                </tr>
                                <tr class="border-b border-gray-100">
                                    <td class="py-3 card-content">ğŸ”µ è—è‰²</td>
                                    <td class="text-center py-3 card-content" id="status-target-blue">0</td>
                                    <td class="text-center py-3 card-content" id="status-current-blue">0</td>
                                    <td class="text-center py-3" id="status-blue">-</td>
                                </tr>
                                <tr class="border-b border-gray-100">
                                    <td class="py-3 card-content">ğŸŸ£ ç´«è‰²</td>
                                    <td class="text-center py-3 card-content" id="status-target-purple">0</td>
                                    <td class="text-center py-3 card-content" id="status-current-purple">0</td>
                                    <td class="text-center py-3" id="status-purple">-</td>
                                </tr>
                                <tr>
                                    <td class="py-3 card-content">ğŸŸ¡ é‡‘è‰²</td>
                                    <td class="text-center py-3 card-content" id="status-target-gold">0</td>
                                    <td class="text-center py-3 card-content" id="status-current-gold">0</td>
                                    <td class="text-center py-3" id="status-gold">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Strategy Display -->
                <div class="card">
                    <h2 class="text-xl card-title flex items-center">
                        ğŸ§  æœ€ä½³åˆæˆç­–ç•¥
                        <span class="ml-2 px-2 py-1 bg-blue-500 text-white text-xs rounded-full animate-bounce">é‡è¦</span>
                    </h2>
                    <div id="strategy-display" class="space-y-2 text-sm">
                        <p class="card-content">è¼¸å…¥æŒæœ‰æ•¸é‡å¾Œè‡ªå‹•é¡¯ç¤ºæœ€ä½³ç­–ç•¥</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Execution Result Preview -->
        <div class="mt-8">
            <div class="card">
                <h2 class="text-2xl card-title flex items-center">
                    ğŸ”„ åŸ·è¡Œå¾Œé è¦½
                </h2>
                <div id="execution-preview" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-green-50 rounded-lg p-4 text-center border-2 border-green-200">
                        <div class="text-2xl mb-2">ğŸŸ¢</div>
                        <div class="text-sm card-content font-medium">ç¶ è‰²ç´ æ</div>
                        <div id="preview-green" class="text-lg font-bold material-green">-</div>
                        <div id="preview-green-status" class="text-xs card-content">-</div>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 text-center border-2 border-blue-200">
                        <div class="text-2xl mb-2">ğŸ”µ</div>
                        <div class="text-sm card-content font-medium">è—è‰²ç´ æ</div>
                        <div id="preview-blue" class="text-lg font-bold material-blue">-</div>
                        <div id="preview-blue-status" class="text-xs card-content">-</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4 text-center border-2 border-purple-200">
                        <div class="text-2xl mb-2">ğŸŸ£</div>
                        <div class="text-sm card-content font-medium">ç´«è‰²ç´ æ</div>
                        <div id="preview-purple" class="text-lg font-bold material-purple">-</div>
                        <div id="preview-purple-status" class="text-xs card-content">-</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4 text-center border-2 border-yellow-200">
                        <div class="text-2xl mb-2">ğŸŸ¡</div>
                        <div class="text-sm card-content font-medium">é‡‘è‰²ç´ æ</div>
                        <div id="preview-gold" class="text-lg font-bold material-gold">-</div>
                        <div id="preview-gold-status" class="text-xs card-content">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Section -->
        <div class="mt-8">
            <div class="report-section">
                <h2 class="text-2xl card-title flex items-center">
                    ğŸ“‹ æ™ºæ…§ç´ æéœ€æ±‚åˆ†æå ±å‘Š
                </h2>
                <div id="report-content" class="bg-gray-50 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap border-2 border-gray-200" style="color: #2c3e50;">
è¼¸å…¥æŒæœ‰æ•¸é‡å¾Œè‡ªå‹•ç”Ÿæˆè©³ç´°å ±å‘Š...
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="mt-8 card">
            <h3 class="text-lg card-title mb-3">ğŸ“– ä½¿ç”¨èªªæ˜</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">ğŸ¯ è¨­å®šç›®æ¨™</h4>
                    <ul class="space-y-1 card-content">
                        <li>â€¢ èª¿æ•´è§’è‰²æŠ€èƒ½ç­‰ç´šï¼ˆ1-10ç´šï¼‰</li>
                        <li>â€¢ è¨­å®šæ­¦å™¨çªç ´ç­‰ç´šï¼ˆ1-90ç´šï¼‰</li>
                        <li>â€¢ ç³»çµ±è‡ªå‹•è¨ˆç®—æ‰€éœ€ç´ æ</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">ğŸ“¦ è¼¸å…¥æŒæœ‰é‡</h4>
                    <ul class="space-y-1 card-content">
                        <li>â€¢ è¼¸å…¥å„è‰²ç´ æç•¶å‰æŒæœ‰æ•¸é‡</li>
                        <li>â€¢ æ”¯æ´å››ç´šç´ æç³»çµ±</li>
                        <li>â€¢ ç¶ â†’è—â†’ç´«â†’é‡‘ åˆæˆè·¯å¾‘</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">ğŸ§  æ™ºæ…§è¨ˆç®—</h4>
                    <ul class="space-y-1 card-content">
                        <li>â€¢ è¼¸å…¥ç´ æå¾Œè‡ªå‹•è¨ˆç®—æœ€ä½³ç­–ç•¥</li>
                        <li>â€¢ ä¿è­‰ç¶ è‰²ç´ æä¸è¢«éåº¦æ¶ˆè€—</li>
                        <li>â€¢ æœ€å¤§åŒ–è³‡æºåˆ©ç”¨æ•ˆç‡</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">ğŸ“‹ å ±å‘ŠåŠŸèƒ½</h4>
                    <ul class="space-y-1 card-content">
                        <li>â€¢ è©³ç´°çš„åˆæˆç­–ç•¥èªªæ˜</li>
                        <li>â€¢ åŸ·è¡Œå‰å¾Œæ•¸é‡å°æ¯”</li>
                        <li>â€¢ ä¸€éµè¤‡è£½å®Œæ•´å ±å‘Š</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Skill upgrade requirements (level 1->2, 2->3, etc.)
        const skillRequirements = {
            1: {green: 2, blue: 0, purple: 0, gold: 0},
            2: {green: 3, blue: 0, purple: 0, gold: 0},
            3: {green: 0, blue: 2, purple: 0, gold: 0},
            4: {green: 0, blue: 3, purple: 0, gold: 0},
            5: {green: 0, blue: 0, purple: 3, gold: 0},
            6: {green: 0, blue: 0, purple: 5, gold: 0},
            7: {green: 0, blue: 0, purple: 0, gold: 2},
            8: {green: 0, blue: 0, purple: 0, gold: 3},
            9: {green: 0, blue: 0, purple: 0, gold: 6}
        };

        // Weapon breakthrough requirements (cumulative from level 1)
        const weaponRequirements = {
            1: {green: 0, blue: 0, purple: 0, gold: 0},
            40: {green: 6, blue: 0, purple: 0, gold: 0},
            50: {green: 6, blue: 8, purple: 0, gold: 0},
            60: {green: 6, blue: 8, purple: 6, gold: 0},
            70: {green: 6, blue: 8, purple: 6, gold: 8},
            80: {green: 6, blue: 8, purple: 6, gold: 20},
            90: {green: 6, blue: 8, purple: 6, gold: 20}
        };

        // Weapon level mapping for slider
        const weaponLevels = [1, 40, 50, 60, 70, 80, 90];

        // Base talent unlock requirements
        const baseTalentRequirements = {
            green: 0,
            blue: 3,
            purple: 15,
            gold: 12
        };

        // Domain drop rates data
        const domainDropRates = {
            stamina: 40,    // æ¯å ´æ¶ˆè€—é«”åŠ›
            green: 6.42,    // å¹³å‡æ¯å ´ç¶ è‰²æ‰è½
            blue: 8.00,     // å¹³å‡æ¯å ´è—è‰²æ‰è½
            purple: 1.59,   // å¹³å‡æ¯å ´ç´«è‰²æ‰è½
            gold: 0.25      // å¹³å‡æ¯å ´é‡‘è‰²æ‰è½
        };

        // Verification function for AI self-check
        function verifyRuns(n, requiredGold) {
            const directGold = 0.25 * n;
            const green = 6.42 * n, blue = 8 * n, purple = 1.59 * n;
            const synthBlue = Math.floor(green / 3);
            const synthPurple = Math.floor((blue + synthBlue) / 3);
            const synthGold = Math.floor((purple + synthPurple) / 3);
            return (directGold + synthGold) >= requiredGold;
        }

        // New dynamic domain calculation algorithm
        function calculateDomainRuns(shortageGold, currentMaterials) {
            // å‡ç´ é ˜åŸŸå›ºå®šæ‰è½ç‡
            const DROP_RATES = {
                green: 6.42,
                blue: 8.00,
                purple: 1.59,
                gold: 0.25
            };

            // è¨ˆç®—æœ€å°å ´æ¬¡ï¼ˆè€ƒæ…®ç›´æ¥æ‰è½+ä¸‰éšåˆæˆï¼‰
            function calculateMinRuns() {
                let runs = 0;
                while (true) {
                    // ç›´æ¥ç²å–
                    const directGold = runs * DROP_RATES.gold;
                    
                    // åˆæˆç²å–ï¼ˆå®Œæ•´ä¸‰éšè½‰æ›ï¼‰
                    const synthGold = 
                        Math.floor((
                            (runs * DROP_RATES.purple) + 
                            Math.floor((
                                (runs * DROP_RATES.blue) + 
                                Math.floor((runs * DROP_RATES.green) / 3)
                            ) / 3)
                        ) / 3);
                    
                    if (directGold + synthGold >= shortageGold) {
                        return runs;
                    }
                    runs++;
                }
            }

            // è³‡æºæ¶ˆè€—é©—è­‰
            function verifyResources(runs) {
                const requiredGreen = Math.ceil(shortageGold / (DROP_RATES.gold + DROP_RATES.green/27));
                return {
                    green: runs * DROP_RATES.green <= currentMaterials.green + requiredGreen,
                    blue: runs * DROP_RATES.blue <= currentMaterials.blue + Math.floor(runs * DROP_RATES.green / 3),
                    purple: runs * DROP_RATES.purple <= currentMaterials.purple + Math.floor(runs * DROP_RATES.blue / 3)
                };
            }

            const minRuns = calculateMinRuns();
            
            // æ™ºèƒ½ç·©è¡æ©Ÿåˆ¶
            let bufferRate = 0.1; // åŸºç¤10%ç·©è¡
            if (shortageGold > 30) {
                bufferRate = 0.15; // å¤§ç¼ºå£15%ç·©è¡
            } else if (shortageGold <= 20) {
                bufferRate = 0.08; // å°ç¼ºå£8%ç·©è¡
            }
            
            const safeRuns = Math.ceil(minRuns * (1 + bufferRate));
            
            // è¨ˆç®—æ•ˆç‡æŒ‡æ¨™
            const directGold = minRuns * DROP_RATES.gold;
            const synthGold = Math.floor((
                (minRuns * DROP_RATES.purple) + 
                Math.floor((
                    (minRuns * DROP_RATES.blue) + 
                    Math.floor((minRuns * DROP_RATES.green) / 3)
                ) / 3)
            ) / 3);
            const totalEfficiency = (directGold + synthGold) / minRuns;
            
            return {
                minRuns,
                safeRuns,
                stamina: minRuns * 40,
                resourceCheck: verifyResources(minRuns),
                efficiency: totalEfficiency,
                directGold: directGold,
                synthGold: synthGold,
                totalGold: directGold + synthGold,
                bufferRate: bufferRate
            };
        }

        // Legacy function wrapper for compatibility
        function calculateOptimalDomainRuns(required) {
            // If no gold needed, use simple calculation
            if (required.gold === 0) {
                const greenRuns = required.green > 0 ? Math.ceil(required.green / domainDropRates.green) : 0;
                const blueRuns = required.blue > 0 ? Math.ceil(required.blue / domainDropRates.blue) : 0;
                const purpleRuns = required.purple > 0 ? Math.ceil(required.purple / domainDropRates.purple) : 0;
                const runs = Math.max(greenRuns, blueRuns, purpleRuns);
                
                return {
                    runs: runs,
                    stamina: runs * domainDropRates.stamina,
                    directGold: runs * domainDropRates.gold,
                    synthesisPath: runs > 0 ? "ç„¡éœ€é‡‘è‰²ç´ æåˆæˆ" : "ç„¡éœ€åˆ·å–",
                    totalGold: runs * domainDropRates.gold,
                    synthGold: 0,
                    oldMethodRuns: runs,
                    remaining: {
                        green: Math.max(0, runs * domainDropRates.green - required.green),
                        blue: Math.max(0, runs * domainDropRates.blue - required.blue),
                        purple: Math.max(0, runs * domainDropRates.purple - required.purple)
                    }
                };
            }

            // Use new dynamic algorithm for gold requirements
            const currentMaterials = {
                green: parseInt(document.getElementById('current-green').value) || 0,
                blue: parseInt(document.getElementById('current-blue').value) || 0,
                purple: parseInt(document.getElementById('current-purple').value) || 0,
                gold: parseInt(document.getElementById('current-gold').value) || 0
            };

            const domainResult = calculateDomainRuns(required.gold, currentMaterials);
            
            return {
                runs: domainResult.minRuns,
                safeRuns: domainResult.safeRuns,
                stamina: domainResult.stamina,
                directGold: domainResult.directGold,
                synthGold: domainResult.synthGold,
                totalGold: domainResult.totalGold,
                efficiency: domainResult.efficiency,
                resourceCheck: domainResult.resourceCheck,
                bufferRate: domainResult.bufferRate
            };
        }

        // Initialize sliders and buttons
        function initializeSliders() {
            const sliders = ['skill1', 'skill2', 'skill3', 'skill4', 'skill5'];
            sliders.forEach(id => {
                const slider = document.getElementById(id);
                const valueDisplay = document.getElementById(id + '-value');
                
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value;
                    calculateRequirements();
                });
            });

            // Initialize weapon slider
            const weaponSlider = document.getElementById('weapon');
            const weaponValueDisplay = document.getElementById('weapon-value');
            
            weaponSlider.addEventListener('input', function() {
                const sliderValue = parseInt(this.value);
                const weaponLevel = weaponLevels[sliderValue];
                weaponValueDisplay.textContent = weaponLevel + 'ç´š';
                window.currentWeaponLevel = weaponLevel;
                calculateRequirements();
            });

            // Initialize skill level quick buttons
            document.getElementById('skill-level-6').addEventListener('click', function() {
                setAllSkillLevels(6);
            });
            document.getElementById('skill-level-8').addEventListener('click', function() {
                setAllSkillLevels(8);
            });
            document.getElementById('skill-level-10').addEventListener('click', function() {
                setAllSkillLevels(10);
            });

            // Initialize weapon level buttons
            const weaponButtons = document.querySelectorAll('.weapon-level-btn');
            weaponButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const level = parseInt(this.dataset.level);
                    setWeaponLevel(level);
                    
                    // Update button states
                    weaponButtons.forEach(btn => {
                        btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                        btn.classList.add('bg-gray-100', 'border-gray-300');
                    });
                    this.classList.remove('bg-gray-100', 'border-gray-300');
                    this.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                });
            });

            // Initialize current holdings inputs with auto-calculation
            const inputs = ['current-green', 'current-blue', 'current-purple', 'current-gold'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    updateStatusTable();
                    // Auto-trigger calculation after a short delay
                    clearTimeout(window.autoCalculateTimeout);
                    window.autoCalculateTimeout = setTimeout(() => {
                        performCalculation();
                    }, 500);
                });
            });
        }

        // Set all skill levels to a specific value
        function setAllSkillLevels(level) {
            ['skill1', 'skill2', 'skill3', 'skill4', 'skill5'].forEach(id => {
                document.getElementById(id).value = level;
                document.getElementById(id + '-value').textContent = level;
            });
            calculateRequirements();
        }

        // Set weapon level
        function setWeaponLevel(level) {
            const sliderIndex = weaponLevels.indexOf(level);
            if (sliderIndex !== -1) {
                document.getElementById('weapon').value = sliderIndex;
                document.getElementById('weapon-value').textContent = level + 'ç´š';
                window.currentWeaponLevel = level;
                calculateRequirements();
            }
        }

        // Calculate total requirements based on current settings
        function calculateRequirements() {
            let totalReq = {
                green: baseTalentRequirements.green,
                blue: baseTalentRequirements.blue,
                purple: baseTalentRequirements.purple,
                gold: baseTalentRequirements.gold
            };

            // Add skill requirements
            for (let i = 1; i <= 5; i++) {
                const level = parseInt(document.getElementById(`skill${i}`).value);
                for (let l = 1; l < level; l++) {
                    if (skillRequirements[l]) {
                        totalReq.green += skillRequirements[l].green;
                        totalReq.blue += skillRequirements[l].blue;
                        totalReq.purple += skillRequirements[l].purple;
                        totalReq.gold += skillRequirements[l].gold;
                    }
                }
            }

            // Add weapon requirements
            const weaponLevel = window.currentWeaponLevel || 1;
            if (weaponRequirements[weaponLevel]) {
                totalReq.green += weaponRequirements[weaponLevel].green;
                totalReq.blue += weaponRequirements[weaponLevel].blue;
                totalReq.purple += weaponRequirements[weaponLevel].purple;
                totalReq.gold += weaponRequirements[weaponLevel].gold;
            }

            // Update display
            document.getElementById('target-green').textContent = totalReq.green;
            document.getElementById('target-blue').textContent = totalReq.blue;
            document.getElementById('target-purple').textContent = totalReq.purple;
            document.getElementById('target-gold').textContent = totalReq.gold;

            updateStatusTable();
            
            // å³æ™‚æ›´æ–°åˆæˆç­–ç•¥å’ŒåŸ·è¡Œé è¦½
            performCalculation();
            
            return totalReq;
        }

        // Update status table
        function updateStatusTable() {
            const targets = {
                green: parseInt(document.getElementById('target-green').textContent),
                blue: parseInt(document.getElementById('target-blue').textContent),
                purple: parseInt(document.getElementById('target-purple').textContent),
                gold: parseInt(document.getElementById('target-gold').textContent)
            };

            const current = {
                green: parseInt(document.getElementById('current-green').value) || 0,
                blue: parseInt(document.getElementById('current-blue').value) || 0,
                purple: parseInt(document.getElementById('current-purple').value) || 0,
                gold: parseInt(document.getElementById('current-gold').value) || 0
            };

            const colors = ['green', 'blue', 'purple', 'gold'];
            colors.forEach(color => {
                document.getElementById(`status-target-${color}`).textContent = targets[color];
                document.getElementById(`status-current-${color}`).textContent = current[color];
                
                const diff = current[color] - targets[color];
                const statusEl = document.getElementById(`status-${color}`);
                
                if (diff >= 0) {
                    statusEl.innerHTML = `<span class="status-success">âœ“ +${diff}</span>`;
                } else {
                    statusEl.innerHTML = `<span class="status-error">âœ— ${diff}</span>`;
                }
            });
        }

        // Reverse algorithm calculation
        function calculateOptimalStrategy() {
            const targets = {
                green: parseInt(document.getElementById('target-green').textContent),
                blue: parseInt(document.getElementById('target-blue').textContent),
                purple: parseInt(document.getElementById('target-purple').textContent),
                gold: parseInt(document.getElementById('target-gold').textContent)
            };

            const current = {
                green: parseInt(document.getElementById('current-green').value) || 0,
                blue: parseInt(document.getElementById('current-blue').value) || 0,
                purple: parseInt(document.getElementById('current-purple').value) || 0,
                gold: parseInt(document.getElementById('current-gold').value) || 0
            };

            // Reverse algorithm implementation
            let strategy = [];
            let finalAmounts = {...current};

            // Step 1: Calculate gold deficit and required purple
            const goldDeficit = Math.max(0, targets.gold - current.gold);
            const purpleNeededForGold = goldDeficit * 3;

            // Step 2: Calculate total purple requirement
            const totalPurpleNeeded = targets.purple + purpleNeededForGold;
            const purpleDeficit = Math.max(0, totalPurpleNeeded - current.purple);
            const blueNeededForPurple = purpleDeficit * 3;

            // Step 3: Calculate total blue requirement
            const totalBlueNeeded = targets.blue + blueNeededForPurple;
            const blueDeficit = Math.max(0, totalBlueNeeded - current.blue);
            const greenNeededForBlue = blueDeficit * 3;

            // Step 4: Calculate available green (must preserve target amount)
            const availableGreen = Math.max(0, current.green - targets.green);

            // Step 5: Execute synthesis strategy
            // Green -> Blue synthesis
            const greenToBlueSynthesis = Math.min(Math.floor(availableGreen / 3), blueDeficit);
            if (greenToBlueSynthesis > 0) {
                strategy.push(`ç¶ â†’è—åˆæˆ: ${greenToBlueSynthesis} æ¬¡ (æ¶ˆè€— ${greenToBlueSynthesis * 3} ç¶ è‰² â†’ ç²å¾— ${greenToBlueSynthesis} è—è‰²)`);
                finalAmounts.green -= greenToBlueSynthesis * 3;
                finalAmounts.blue += greenToBlueSynthesis;
            }

            // Blue -> Purple synthesis
            const availableBlue = finalAmounts.blue - targets.blue;
            const blueToPurpleSynthesis = Math.min(Math.floor(Math.max(0, availableBlue) / 3), purpleDeficit);
            if (blueToPurpleSynthesis > 0) {
                strategy.push(`è—â†’ç´«åˆæˆ: ${blueToPurpleSynthesis} æ¬¡ (æ¶ˆè€— ${blueToPurpleSynthesis * 3} è—è‰² â†’ ç²å¾— ${blueToPurpleSynthesis} ç´«è‰²)`);
                finalAmounts.blue -= blueToPurpleSynthesis * 3;
                finalAmounts.purple += blueToPurpleSynthesis;
            }

            // Purple -> Gold synthesis
            const availablePurple = finalAmounts.purple - targets.purple;
            const purpleToGoldSynthesis = Math.min(Math.floor(Math.max(0, availablePurple) / 3), goldDeficit);
            if (purpleToGoldSynthesis > 0) {
                strategy.push(`ç´«â†’é‡‘åˆæˆ: ${purpleToGoldSynthesis} æ¬¡ (æ¶ˆè€— ${purpleToGoldSynthesis * 3} ç´«è‰² â†’ ç²å¾— ${purpleToGoldSynthesis} é‡‘è‰²)`);
                finalAmounts.purple -= purpleToGoldSynthesis * 3;
                finalAmounts.gold += purpleToGoldSynthesis;
            }

            return {strategy, finalAmounts, targets, current};
        }

        // Generate detailed report
        function generateReport(calculation) {
            const {strategy, finalAmounts, targets, current} = calculation;
            const now = new Date().toLocaleString('zh-TW');

            let report = `=== ğŸ¯ ç´ æéœ€æ±‚ç²¾ç®—å ±å‘Š ===\n\n`;
            
            report += `ã€åŸºæœ¬è³‡è¨Šã€‘\n`;
            report += `âŒš ç”Ÿæˆæ™‚é–“: ${now}\n\n`;

            // è³‡æºç‹€æ…‹åˆ†æ
            report += `ã€è³‡æºç‹€æ…‹ã€‘\n`;
            const colors = [
                {name: 'ğŸŸ¢ ç¶ è‰²', key: 'green'},
                {name: 'ğŸ”µ è—è‰²', key: 'blue'},
                {name: 'ğŸŸ£ ç´«è‰²', key: 'purple'},
                {name: 'ğŸŸ¡ é‡‘è‰²', key: 'gold'}
            ];

            let achievedItems = [];
            let shortageItems = [];

            colors.forEach(({name, key}) => {
                const currentVal = current[key];
                const targetVal = targets[key];
                const diff = currentVal - targetVal;
                
                if (diff >= 0) {
                    achievedItems.push(`- ${name} ${currentVal}/${targetVal}`);
                } else {
                    shortageItems.push(`- ${name} ${currentVal}/${targetVal} (ç¼ºå£:${Math.abs(diff)})`);
                }
            });

            if (achievedItems.length > 0) {
                report += `âœ… å·²é”æ¨™:\n`;
                achievedItems.forEach(item => report += `${item}\n`);
            }
            
            if (shortageItems.length > 0) {
                report += `âš ï¸ éœ€è£œè¶³:\n`;
                shortageItems.forEach(item => report += `${item}\n`);
            }
            
            if (achievedItems.length === 0 && shortageItems.length === 0) {
                report += `âœ… æ‰€æœ‰è³‡æºå·²é”æ¨™\n`;
            }
            report += `\n`;

            // åˆæˆç­–ç•¥
            report += `ã€åˆæˆç­–ç•¥ã€‘\n`;
            if (strategy.length === 0) {
                report += `âœ… ç„¡éœ€åˆæˆï¼Œç•¶å‰è³‡æºé…ç½®å·²é”æ¨™\n\n`;
            } else {
                report += `ğŸ”„ ä¸‰éšæ®µè³‡æºè½‰æ›:\n`;
                strategy.forEach((step, index) => {
                    const stepNum = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£'][index] || `${index + 1}ï¸âƒ£`;
                    
                    // è§£æåˆæˆæ­¥é©Ÿ
                    if (step.includes('ç¶ â†’è—')) {
                        const matches = step.match(/(\d+) æ¬¡.*?(\d+) ç¶ è‰².*?(\d+) è—è‰²/);
                        if (matches) {
                            report += `${stepNum} ç¶ â†’è—:\n`;
                            report += `   - æ¶ˆè€—: ${matches[2]}ç¶ \n`;
                            report += `   - ç²å¾—: ${matches[3]}è—\n`;
                        }
                    } else if (step.includes('è—â†’ç´«')) {
                        const matches = step.match(/(\d+) æ¬¡.*?(\d+) è—è‰².*?(\d+) ç´«è‰²/);
                        if (matches) {
                            report += `${stepNum} è—â†’ç´«:\n`;
                            report += `   - æ¶ˆè€—: ${matches[2]}è—\n`;
                            report += `   - ç²å¾—: ${matches[3]}ç´«\n`;
                        }
                    } else if (step.includes('ç´«â†’é‡‘')) {
                        const matches = step.match(/(\d+) æ¬¡.*?(\d+) ç´«è‰².*?(\d+) é‡‘è‰²/);
                        if (matches) {
                            report += `${stepNum} ç´«â†’é‡‘:\n`;
                            report += `   - æ¶ˆè€—: ${matches[2]}ç´«\n`;
                            report += `   - ç²å¾—: ${matches[3]}é‡‘\n`;
                        }
                    }
                });
                report += `\n`;
            }

            // å‡ç´ é ˜åŸŸç²¾æº–æ–¹æ¡ˆ - è¨ˆç®—åˆæˆå¾Œçš„ç¼ºå£
            const shortages = {
                green: Math.max(0, targets.green - finalAmounts.green),
                blue: Math.max(0, targets.blue - finalAmounts.blue),
                purple: Math.max(0, targets.purple - finalAmounts.purple),
                gold: Math.max(0, targets.gold - finalAmounts.gold)
            };
            
            report += `=== ğŸ¯ å‡ç´ é ˜åŸŸç²¾æº–æ–¹æ¡ˆ ===\n\n`;
            
            if (shortages.gold === 0 && shortages.purple === 0 && shortages.blue === 0 && shortages.green === 0) {
                report += `âœ… ç„¡éœ€åˆ·å–å‡ç´ é ˜åŸŸï¼Œç•¶å‰è³‡æºå·²è¶³å¤ \n\n`;
            } else if (shortages.gold > 0) {
                // ä½¿ç”¨æ–°å‹•æ…‹ç®—æ³•è¨ˆç®—
                const domainResult = calculateDomainRuns(shortages.gold, current);
                
                // ç¼ºå£åˆ†æ
                report += `ã€ç¼ºå£åˆ†æã€‘\n`;
                report += `â— åˆæˆå¾Œä»éœ€è£œè¶³: ${shortages.gold}é‡‘\n`;
                
                // ç²¾åº¦æ§åˆ¶
                const precision = shortages.gold <= 20 ? 1 : 0;
                const directRate = (0.25).toFixed(2);
                const synthRate = ((domainResult.efficiency - 0.25)).toFixed(2);
                const totalRate = domainResult.efficiency.toFixed(2);
                
                report += `ğŸ“Š æ¯å ´ç²å–ç‡:\n`;
                report += `   - ç›´æ¥æ‰è½: ${directRate}é‡‘\n`;
                report += `   - åˆæˆæ½›åŠ›: ${synthRate}é‡‘ (ç¶“ä¸‰éšè½‰æ›)\n`;
                report += `   - ç¸½æ•ˆç‡: ${totalRate}é‡‘/å ´\n`;
                report += `æ¯å ´ç­‰æ•ˆç²å–ï¼š${totalRate}é‡‘\n\n`;
                
                // å‹•æ…‹å ´æ¬¡é©—è­‰
                const minRuns = domainResult.minRuns;
                const safeRuns = domainResult.safeRuns;
                const bufferPercent = Math.round(domainResult.bufferRate * 100);
                
                report += `ã€${minRuns}å ´å¯¦æ¸¬é©—è­‰ã€‘\n`;
                report += `âœ¦ ç›´æ¥ç²å–: ${(domainResult.directGold).toFixed(precision)}é‡‘ (${minRuns}Ã—${directRate})\n`;
                report += `âœ¦ åˆæˆç²å–: ${(domainResult.synthGold).toFixed(precision)}é‡‘ (å®Œæ•´è·¯å¾‘):\n`;
                
                // è©³ç´°åˆæˆè·¯å¾‘
                const greenCollected = (minRuns * 6.42).toFixed(1);
                const synthBlue = Math.floor(minRuns * 6.42 / 3);
                const blueCollected = (minRuns * 8.00).toFixed(1);
                const totalBlue = (minRuns * 8.00 + synthBlue).toFixed(1);
                const synthPurple = Math.floor((minRuns * 8.00 + synthBlue) / 3);
                const purpleCollected = (minRuns * 1.59).toFixed(1);
                const totalPurple = (minRuns * 1.59 + synthPurple).toFixed(1);
                const synthGold = Math.floor((minRuns * 1.59 + synthPurple) / 3);
                
                report += `   1ï¸âƒ£ æ”¶é›†${greenCollected}ç¶  â†’ åˆæˆ${synthBlue}è—\n`;
                report += `   2ï¸âƒ£ ç¸½è—é‡: ${synthBlue}(åˆæˆ)+${blueCollected}(æ‰è½)=${totalBlue} â†’ åˆæˆ${synthPurple}ç´«\n`;
                report += `   3ï¸âƒ£ ç¸½ç´«é‡: ${synthPurple}(åˆæˆ)+${purpleCollected}(æ‰è½)=${totalPurple} â†’ åˆæˆ${synthGold}é‡‘\n`;
                report += `âœ“ ç¸½å’Œ: ${(domainResult.directGold).toFixed(precision)} + ${(domainResult.synthGold).toFixed(precision)} = ${(domainResult.totalGold).toFixed(precision)}é‡‘ â‰¥ ${shortages.gold}é‡‘\n\n`;
                
                // åŸ·è¡Œå»ºè­°
                report += `ã€åŸ·è¡Œå»ºè­°ã€‘\n`;
                report += `â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n`;
                report += `â”‚ ç²¾ç¢ºæœ€å°å ´æ¬¡       â”‚ ${minRuns}å ´ (${minRuns * 40}é«”åŠ›) â”‚\n`;
                report += `â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n`;
                report += `â”‚ å®‰å…¨ç·©è¡(${bufferPercent}%)      â”‚ ${safeRuns}å ´ (${safeRuns * 40}é«”åŠ›) â”‚\n`;
                report += `â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\n`;
                
                // è³‡æºé©—è­‰
                report += `ã€è³‡æºé©—è­‰ã€‘\n`;
                const resourceCheck = domainResult.resourceCheck;
                
                if (resourceCheck.green && resourceCheck.blue && resourceCheck.purple) {
                    report += `âœ“ ç¶ è‰²æ¶ˆè€—: ${greenCollected} â‰¤ ${(current.green + minRuns * 6.42).toFixed(1)} (å¯ç”¨)\n`;
                    report += `âœ“ è—è‰²å¹³è¡¡: \n`;
                    report += `   - æ¶ˆè€—: ${totalBlue}\n`;
                    report += `   - ä¾†æº: ${current.blue}(å‰©é¤˜) + ${synthBlue}(åˆæˆ) = ${(current.blue + synthBlue).toFixed(1)} âœ”\n`;
                    report += `âœ“ ç´«è‰²å¹³è¡¡:\n`;
                    report += `   - æ¶ˆè€—: ${totalPurple}\n`;
                    report += `   - ä¾†æº: ${current.purple}(å‰©é¤˜) + ${synthPurple}(åˆæˆ) = ${(current.purple + synthPurple).toFixed(1)} âœ”\n\n`;
                } else {
                    report += `â— è³‡æºé©—è­‰ä¸é€šé:\n`;
                    if (!resourceCheck.green) {
                        report += `   - ç¶ è‰²ä¸è¶³ï¼Œéœ€å„ªå…ˆåˆ·å–ç¶ è‰²è‡³${Math.ceil(minRuns * 6.42 - current.green)}\n`;
                    }
                    if (!resourceCheck.blue) {
                        report += `   - è—è‰²ä¸è¶³ï¼Œéœ€å„ªå…ˆåˆ·å–è—è‰²è‡³${Math.ceil(minRuns * 8.00 - current.blue)}\n`;
                    }
                    if (!resourceCheck.purple) {
                        report += `   - ç´«è‰²ä¸è¶³ï¼Œéœ€å„ªå…ˆåˆ·å–ç´«è‰²è‡³${Math.ceil(minRuns * 1.59 - current.purple)}\n`;
                    }
                    report += `\n`;
                }
            } else {
                // è™•ç†å…¶ä»–ç´ æç¼ºå£
                report += `ã€ç¼ºå£åˆ†æã€‘\n`;
                if (shortages.purple > 0) {
                    report += `â— åˆæˆå¾Œä»éœ€è£œè¶³: ${shortages.purple}ç´«\n`;
                } else if (shortages.blue > 0) {
                    report += `â— åˆæˆå¾Œä»éœ€è£œè¶³: ${shortages.blue}è—\n`;
                } else if (shortages.green > 0) {
                    report += `â— åˆæˆå¾Œä»éœ€è£œè¶³: ${shortages.green}ç¶ \n`;
                }
                
                // ç°¡åŒ–è¨ˆç®—éé‡‘è‰²ç´ æ
                const purpleRuns = shortages.purple > 0 ? Math.ceil(shortages.purple / 1.59) : 0;
                const blueRuns = shortages.blue > 0 ? Math.ceil(shortages.blue / 8.00) : 0;
                const greenRuns = shortages.green > 0 ? Math.ceil(shortages.green / 6.42) : 0;
                const requiredRuns = Math.max(purpleRuns, blueRuns, greenRuns);
                
                if (requiredRuns > 0) {
                    report += `ã€åŸ·è¡Œå»ºè­°ã€‘\n`;
                    report += `â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n`;
                    report += `â”‚ å»ºè­°å ´æ¬¡          â”‚ ${requiredRuns}å ´ (${requiredRuns * 40}é«”åŠ›) â”‚\n`;
                    report += `â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\n`;
                }
            }

            report += `\nï¼ˆè¨ˆç®—é‚è¼¯é©—è­‰ï¼šâŒˆç¼ºé¡/(ç›´æ¥ç²å–ç‡+åˆæˆè½‰æ›ç‡)âŒ‰ï¼‰`;

            return report;
        }

        // Update execution preview - only shows synthesis results, not domain farming
        function updateExecutionPreview(calculation) {
            const {current, targets} = calculation;
            
            // Simulate only the synthesis strategy execution
            let simulatedAmounts = {...current};
            
            // Execute the same synthesis logic as in calculateOptimalStrategy
            const goldDeficit = Math.max(0, targets.gold - current.gold);
            const purpleNeededForGold = goldDeficit * 3;
            const totalPurpleNeeded = targets.purple + purpleNeededForGold;
            const purpleDeficit = Math.max(0, totalPurpleNeeded - current.purple);
            const blueNeededForPurple = purpleDeficit * 3;
            const totalBlueNeeded = targets.blue + blueNeededForPurple;
            const blueDeficit = Math.max(0, totalBlueNeeded - current.blue);
            const availableGreen = Math.max(0, current.green - targets.green);

            // Green -> Blue synthesis
            const greenToBlueSynthesis = Math.min(Math.floor(availableGreen / 3), blueDeficit);
            if (greenToBlueSynthesis > 0) {
                simulatedAmounts.green -= greenToBlueSynthesis * 3;
                simulatedAmounts.blue += greenToBlueSynthesis;
            }

            // Blue -> Purple synthesis
            const availableBlue = simulatedAmounts.blue - targets.blue;
            const blueToPurpleSynthesis = Math.min(Math.floor(Math.max(0, availableBlue) / 3), purpleDeficit);
            if (blueToPurpleSynthesis > 0) {
                simulatedAmounts.blue -= blueToPurpleSynthesis * 3;
                simulatedAmounts.purple += blueToPurpleSynthesis;
            }

            // Purple -> Gold synthesis
            const availablePurple = simulatedAmounts.purple - targets.purple;
            const purpleToGoldSynthesis = Math.min(Math.floor(Math.max(0, availablePurple) / 3), goldDeficit);
            if (purpleToGoldSynthesis > 0) {
                simulatedAmounts.purple -= purpleToGoldSynthesis * 3;
                simulatedAmounts.gold += purpleToGoldSynthesis;
            }
            
            // Update display with synthesis-only results
            const colors = ['green', 'blue', 'purple', 'gold'];
            colors.forEach(color => {
                const final = Math.floor(simulatedAmounts[color]);
                const target = targets[color];
                const diff = final - target;
                
                document.getElementById(`preview-${color}`).textContent = final + ' å€‹';
                
                if (diff >= 0) {
                    document.getElementById(`preview-${color}-status`).textContent = `âœ“ é”æ¨™ +${diff}`;
                    document.getElementById(`preview-${color}-status`).className = 'text-xs opacity-90 text-green-600';
                } else {
                    document.getElementById(`preview-${color}-status`).textContent = `âœ— ä¸è¶³ ${Math.abs(diff)}`;
                    document.getElementById(`preview-${color}-status`).className = 'text-xs opacity-90 text-red-600';
                }
            });
        }

        // Perform calculation function (used by both auto-calculation and manual trigger)
        function performCalculation() {
            // æª¢æŸ¥æ˜¯å¦æœ‰æŒæœ‰æ•¸é‡è¼¸å…¥ï¼Œé¿å…åœ¨åˆå§‹åŒ–æ™‚é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
            const hasInput = ['current-green', 'current-blue', 'current-purple', 'current-gold']
                .some(id => parseInt(document.getElementById(id).value) > 0);
            
            if (!hasInput) {
                // å¦‚æœæ²’æœ‰è¼¸å…¥æŒæœ‰æ•¸é‡ï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯
                document.getElementById('strategy-display').innerHTML = '<p class="text-gray-500">è¼¸å…¥æŒæœ‰æ•¸é‡å¾Œè‡ªå‹•é¡¯ç¤ºæœ€ä½³ç­–ç•¥</p>';
                document.getElementById('report-content').textContent = 'è¼¸å…¥æŒæœ‰æ•¸é‡å¾Œè‡ªå‹•ç”Ÿæˆè©³ç´°å ±å‘Š...';
                
                // é‡ç½®åŸ·è¡Œé è¦½
                ['green', 'blue', 'purple', 'gold'].forEach(color => {
                    document.getElementById(`preview-${color}`).textContent = '-';
                    document.getElementById(`preview-${color}-status`).textContent = '-';
                    document.getElementById(`preview-${color}-status`).className = 'text-xs card-content';
                });
                return;
            }

            const calculation = calculateOptimalStrategy();
            const {strategy} = calculation;

            // Update strategy display
            const strategyDisplay = document.getElementById('strategy-display');
            if (strategy.length === 0) {
                strategyDisplay.innerHTML = '<p class="text-green-600 font-semibold">ğŸ‰ ç„¡éœ€åˆæˆï¼Œç•¶å‰è³‡æºå·²ç¶“æœ€å„ªé…ç½®ï¼</p>';
            } else {
                strategyDisplay.innerHTML = strategy.map(step => 
                    `<div class="bg-blue-50 p-2 rounded border-l-4 border-blue-400">${step}</div>`
                ).join('');
            }

            // Update execution preview
            updateExecutionPreview(calculation);

            // Generate and display report
            const report = generateReport(calculation);
            document.getElementById('report-content').textContent = report;
        }

        // Event listeners
        document.getElementById('max-cultivation-btn').addEventListener('click', function() {
            this.classList.add('pulse-animation');
            setTimeout(() => this.classList.remove('pulse-animation'), 1000);

            // Set all skills to maximum level
            setAllSkillLevels(10);
            
            // Set weapon to maximum level
            setWeaponLevel(90);
            
            // Update weapon button state
            const weaponButtons = document.querySelectorAll('.weapon-level-btn');
            weaponButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-gray-100', 'border-gray-300');
            });
            const maxWeaponBtn = document.querySelector('[data-level="90"]');
            if (maxWeaponBtn) {
                maxWeaponBtn.classList.remove('bg-gray-100', 'border-gray-300');
                maxWeaponBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }
            
            // Recalculate requirements and perform calculation
            calculateRequirements();
            performCalculation();
        });

        document.getElementById('reset-default-btn').addEventListener('click', function() {
            // Reset to character + weapon full requirements
            setAllSkillLevels(10);
            setWeaponLevel(90);
            
            // Update weapon button state
            const weaponButtons = document.querySelectorAll('.weapon-level-btn');
            weaponButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-gray-100', 'border-gray-300');
            });
            const maxWeaponBtn = document.querySelector('[data-level="90"]');
            if (maxWeaponBtn) {
                maxWeaponBtn.classList.remove('bg-gray-100', 'border-gray-300');
                maxWeaponBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }
            
            calculateRequirements();
        });

        document.getElementById('reset-all-btn').addEventListener('click', function() {
            // Reset everything to initial state
            setAllSkillLevels(1);
            setWeaponLevel(1);
            
            // Update weapon button state
            const weaponButtons = document.querySelectorAll('.weapon-level-btn');
            weaponButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-gray-100', 'border-gray-300');
            });
            const firstWeaponBtn = document.querySelector('[data-level="1"]');
            if (firstWeaponBtn) {
                firstWeaponBtn.classList.remove('bg-gray-100', 'border-gray-300');
                firstWeaponBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }
            
            ['current-green', 'current-blue', 'current-purple', 'current-gold'].forEach(id => {
                document.getElementById(id).value = 0;
            });

            document.getElementById('strategy-display').innerHTML = '<p class="text-gray-500">è¼¸å…¥æŒæœ‰æ•¸é‡å¾Œè‡ªå‹•é¡¯ç¤ºæœ€ä½³ç­–ç•¥</p>';
            document.getElementById('report-content').textContent = 'è¼¸å…¥æŒæœ‰æ•¸é‡å¾Œè‡ªå‹•ç”Ÿæˆè©³ç´°å ±å‘Š...';
            
            // Reset execution preview
            ['green', 'blue', 'purple', 'gold'].forEach(color => {
                document.getElementById(`preview-${color}`).textContent = '-';
                document.getElementById(`preview-${color}-status`).textContent = '-';
            });
            
            calculateRequirements();
        });

        document.getElementById('copy-report-btn').addEventListener('click', async function() {
            const reportContent = document.getElementById('report-content').textContent;
            
            try {
                await navigator.clipboard.writeText(reportContent);
                
                const originalText = this.textContent;
                this.textContent = 'âœ… å·²è¤‡è£½ï¼';
                this.classList.add('pulse-animation');
                
                setTimeout(() => {
                    this.textContent = originalText;
                    this.classList.remove('pulse-animation');
                }, 2000);
            } catch (err) {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = reportContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const originalText = this.textContent;
                this.textContent = 'âœ… å·²è¤‡è£½ï¼';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
            }
        });

        // Initialize the application
        window.currentWeaponLevel = 1;
        initializeSliders();
        calculateRequirements();
        
        // Set initial weapon button state
        const firstWeaponBtn = document.querySelector('[data-level="1"]');
        if (firstWeaponBtn) {
            firstWeaponBtn.classList.remove('bg-gray-100', 'border-gray-300');
            firstWeaponBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97145c85c72d4a9e',t:'MTc1NTU1MTA0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
