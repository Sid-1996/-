<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sid的鳴潮智慧素材需求計算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .card-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .card-content {
            color: #34495e;
        }
        
        .material-green { color: #27ae60; }
        .material-blue { color: #3498db; }
        .material-purple { color: #9b59b6; }
        .material-gold { color: #f39c12; }
        
        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .slider-track {
            background: linear-gradient(to right, #bdc3c7 0%, #3498db 100%);
            height: 6px;
            border-radius: 3px;
        }
        
        .input-field {
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 10px 15px;
            transition: border-color 0.3s ease;
            background: white;
        }
        
        .input-field:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .status-success {
            color: #27ae60;
            font-weight: 600;
        }
        
        .status-error {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .report-section {
            background: rgba(255, 255, 255, 0.95);
            color: #2c3e50;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header-title {
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header-subtitle {
            color: rgba(255,255,255,0.9);
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold header-title mb-2">🎮 Sid的鳴潮智慧素材需求計算器</h1>
            <p class="header-subtitle">逆向演算法優化 • 智慧合成策略 • 零浪費資源配置</p>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- Left Column: Controls -->
            <div class="xl:col-span-2 space-y-6">
                <!-- Character Skills Section -->
                <div class="card">
                    <div class="flex flex-wrap items-center justify-between mb-4">
                        <h2 class="text-2xl card-title flex items-center">
                            ⚔️ 角色技能等級設定
                        </h2>
                        <div class="flex gap-2 mt-2 sm:mt-0">
                            <button id="skill-level-6" class="btn-secondary">
                                6等
                            </button>
                            <button id="skill-level-8" class="btn-secondary">
                                8等
                            </button>
                            <button id="skill-level-10" class="btn-secondary">
                                10等
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="skill-control">
                            <label class="block text-sm font-medium card-content mb-2">常態攻擊</label>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm card-content">1</span>
                                <input type="range" id="skill1" min="1" max="10" value="1" 
                                       class="flex-1 h-2 rounded-lg appearance-none cursor-pointer slider-track">
                                <span class="text-sm card-content">10</span>
                                <span id="skill1-value" class="text-lg font-semibold material-blue w-8">1</span>
                            </div>
                        </div>
                        <div class="skill-control">
                            <label class="block text-sm font-medium card-content mb-2">共鳴技能</label>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm card-content">1</span>
                                <input type="range" id="skill2" min="1" max="10" value="1" 
                                       class="flex-1 h-2 rounded-lg appearance-none cursor-pointer slider-track">
                                <span class="text-sm card-content">10</span>
                                <span id="skill2-value" class="text-lg font-semibold material-blue w-8">1</span>
                            </div>
                        </div>
                        <div class="skill-control">
                            <label class="block text-sm font-medium card-content mb-2">共鳴解放</label>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm card-content">1</span>
                                <input type="range" id="skill3" min="1" max="10" value="1" 
                                       class="flex-1 h-2 rounded-lg appearance-none cursor-pointer slider-track">
                                <span class="text-sm card-content">10</span>
                                <span id="skill3-value" class="text-lg font-semibold material-blue w-8">1</span>
                            </div>
                        </div>
                        <div class="skill-control">
                            <label class="block text-sm font-medium card-content mb-2">變奏技能</label>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm card-content">1</span>
                                <input type="range" id="skill4" min="1" max="10" value="1" 
                                       class="flex-1 h-2 rounded-lg appearance-none cursor-pointer slider-track">
                                <span class="text-sm card-content">10</span>
                                <span id="skill4-value" class="text-lg font-semibold material-blue w-8">1</span>
                            </div>
                        </div>
                        <div class="skill-control md:col-span-2">
                            <label class="block text-sm font-medium card-content mb-2">共鳴迴路</label>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm card-content">1</span>
                                <input type="range" id="skill5" min="1" max="10" value="1" 
                                       class="flex-1 h-2 rounded-lg appearance-none cursor-pointer slider-track">
                                <span class="text-sm card-content">10</span>
                                <span id="skill5-value" class="text-lg font-semibold material-blue w-8">1</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weapon Level Section -->
                <div class="card">
                    <h2 class="text-2xl card-title flex items-center">
                        🗡️ 武器突破等級設定
                    </h2>
                    <div class="skill-control">
                        <label class="block text-sm font-medium card-content mb-2">武器等級</label>
                        <div class="flex items-center space-x-3">
                            <span class="text-sm card-content">1</span>
                            <input type="range" id="weapon" min="0" max="6" value="0" step="1"
                                   class="flex-1 h-2 rounded-lg appearance-none cursor-pointer slider-track">
                            <span class="text-sm card-content">90</span>
                            <span id="weapon-value" class="text-lg font-semibold material-purple w-12">1級</span>
                        </div>
                    </div>
                </div>

                <!-- Target Requirements -->
                <div class="card" style="padding: 20px;">
                    <h2 class="text-lg card-title flex items-center">
                        🎯 目標需求
                    </h2>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="flex items-center card-content"><span class="text-base mr-1">🟢</span>綠色</span>
                            <span id="target-green" class="font-bold material-green">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="flex items-center card-content"><span class="text-base mr-1">🔵</span>藍色</span>
                            <span id="target-blue" class="font-bold material-blue">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="flex items-center card-content"><span class="text-base mr-1">🟣</span>紫色</span>
                            <span id="target-purple" class="font-bold material-purple">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="flex items-center card-content"><span class="text-base mr-1">🟡</span>金色</span>
                            <span id="target-gold" class="font-bold material-gold">0</span>
                        </div>
                    </div>
                </div>

                <!-- Current Holdings Section -->
                <div class="card">
                    <h2 class="text-2xl card-title flex items-center">
                        📦 當前持有數量
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="bg-green-50 rounded-lg p-3 mb-2 border-2 border-green-100">
                                <span class="text-2xl">🟢</span>
                                <p class="text-sm font-medium material-green">綠色素材</p>
                            </div>
                            <input type="number" id="current-green" value="0" min="0" 
                                   class="input-field w-full text-center">
                        </div>
                        <div class="text-center">
                            <div class="bg-blue-50 rounded-lg p-3 mb-2 border-2 border-blue-100">
                                <span class="text-2xl">🔵</span>
                                <p class="text-sm font-medium material-blue">藍色素材</p>
                            </div>
                            <input type="number" id="current-blue" value="0" min="0" 
                                   class="input-field w-full text-center">
                        </div>
                        <div class="text-center">
                            <div class="bg-purple-50 rounded-lg p-3 mb-2 border-2 border-purple-100">
                                <span class="text-2xl">🟣</span>
                                <p class="text-sm font-medium material-purple">紫色素材</p>
                            </div>
                            <input type="number" id="current-purple" value="0" min="0" 
                                   class="input-field w-full text-center">
                        </div>
                        <div class="text-center">
                            <div class="bg-yellow-50 rounded-lg p-3 mb-2 border-2 border-yellow-100">
                                <span class="text-2xl">🟡</span>
                                <p class="text-sm font-medium material-gold">金色素材</p>
                            </div>
                            <input type="number" id="current-gold" value="0" min="0" 
                                   class="input-field w-full text-center">
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 justify-center">
                    <button id="max-cultivation-btn" class="btn-primary">
                        🎓 一鍵畢業需求
                    </button>
                    <button id="reset-default-btn" class="btn-success">
                        🎯 重置預設
                    </button>
                    <button id="reset-all-btn" class="btn-secondary" style="padding: 12px 24px;">
                        🔄 重置數據
                    </button>
                    <button id="copy-report-btn" class="btn-warning">
                        📋 複製報告
                    </button>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="space-y-6">
                <!-- Status Analysis -->
                <div class="card">
                    <h2 class="text-xl card-title flex items-center">
                        📊 狀態分析
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b-2 border-gray-200">
                                    <th class="text-left py-3 card-content font-semibold">素材</th>
                                    <th class="text-center py-3 card-content font-semibold">目標</th>
                                    <th class="text-center py-3 card-content font-semibold">持有</th>
                                    <th class="text-center py-3 card-content font-semibold">狀態</th>
                                </tr>
                            </thead>
                            <tbody id="status-table">
                                <tr class="border-b border-gray-100">
                                    <td class="py-3 card-content">🟢 綠色</td>
                                    <td class="text-center py-3 card-content" id="status-target-green">0</td>
                                    <td class="text-center py-3 card-content" id="status-current-green">0</td>
                                    <td class="text-center py-3" id="status-green">-</td>
                                </tr>
                                <tr class="border-b border-gray-100">
                                    <td class="py-3 card-content">🔵 藍色</td>
                                    <td class="text-center py-3 card-content" id="status-target-blue">0</td>
                                    <td class="text-center py-3 card-content" id="status-current-blue">0</td>
                                    <td class="text-center py-3" id="status-blue">-</td>
                                </tr>
                                <tr class="border-b border-gray-100">
                                    <td class="py-3 card-content">🟣 紫色</td>
                                    <td class="text-center py-3 card-content" id="status-target-purple">0</td>
                                    <td class="text-center py-3 card-content" id="status-current-purple">0</td>
                                    <td class="text-center py-3" id="status-purple">-</td>
                                </tr>
                                <tr>
                                    <td class="py-3 card-content">🟡 金色</td>
                                    <td class="text-center py-3 card-content" id="status-target-gold">0</td>
                                    <td class="text-center py-3 card-content" id="status-current-gold">0</td>
                                    <td class="text-center py-3" id="status-gold">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Strategy Display -->
                <div class="card">
                    <h2 class="text-xl card-title flex items-center">
                        🧠 最佳合成策略
                        <span class="ml-2 px-2 py-1 bg-blue-500 text-white text-xs rounded-full animate-bounce">重要</span>
                    </h2>
                    <div id="strategy-display" class="space-y-2 text-sm">
                        <p class="card-content">輸入持有數量後自動顯示最佳策略</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Execution Result Preview -->
        <div class="mt-8">
            <div class="card">
                <h2 class="text-2xl card-title flex items-center">
                    🔄 執行後預覽
                </h2>
                <div id="execution-preview" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-green-50 rounded-lg p-4 text-center border-2 border-green-200">
                        <div class="text-2xl mb-2">🟢</div>
                        <div class="text-sm card-content font-medium">綠色素材</div>
                        <div id="preview-green" class="text-lg font-bold material-green">-</div>
                        <div id="preview-green-status" class="text-xs card-content">-</div>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 text-center border-2 border-blue-200">
                        <div class="text-2xl mb-2">🔵</div>
                        <div class="text-sm card-content font-medium">藍色素材</div>
                        <div id="preview-blue" class="text-lg font-bold material-blue">-</div>
                        <div id="preview-blue-status" class="text-xs card-content">-</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4 text-center border-2 border-purple-200">
                        <div class="text-2xl mb-2">🟣</div>
                        <div class="text-sm card-content font-medium">紫色素材</div>
                        <div id="preview-purple" class="text-lg font-bold material-purple">-</div>
                        <div id="preview-purple-status" class="text-xs card-content">-</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4 text-center border-2 border-yellow-200">
                        <div class="text-2xl mb-2">🟡</div>
                        <div class="text-sm card-content font-medium">金色素材</div>
                        <div id="preview-gold" class="text-lg font-bold material-gold">-</div>
                        <div id="preview-gold-status" class="text-xs card-content">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Section -->
        <div class="mt-8">
            <div class="report-section">
                <h2 class="text-2xl card-title flex items-center">
                    📋 智慧素材需求分析報告
                </h2>
                <div id="report-content" class="bg-gray-50 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap border-2 border-gray-200" style="color: #2c3e50;">
輸入持有數量後自動生成詳細報告...
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="mt-8 card">
            <h3 class="text-lg card-title mb-3">📖 使用說明</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">🎯 設定目標</h4>
                    <ul class="space-y-1 card-content">
                        <li>• 調整角色技能等級（1-10級）</li>
                        <li>• 設定武器突破等級（1-90級）</li>
                        <li>• 系統自動計算所需素材</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">📦 輸入持有量</h4>
                    <ul class="space-y-1 card-content">
                        <li>• 輸入各色素材當前持有數量</li>
                        <li>• 支援四級素材系統</li>
                        <li>• 綠→藍→紫→金 合成路徑</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">🧠 智慧計算</h4>
                    <ul class="space-y-1 card-content">
                        <li>• 輸入素材後自動計算最佳策略</li>
                        <li>• 保證綠色素材不被過度消耗</li>
                        <li>• 最大化資源利用效率</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold card-title mb-2 text-base">📋 報告功能</h4>
                    <ul class="space-y-1 card-content">
                        <li>• 詳細的合成策略說明</li>
                        <li>• 執行前後數量對比</li>
                        <li>• 一鍵複製完整報告</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Skill upgrade requirements (level 1->2, 2->3, etc.)
        const skillRequirements = {
            1: {green: 2, blue: 0, purple: 0, gold: 0},
            2: {green: 3, blue: 0, purple: 0, gold: 0},
            3: {green: 0, blue: 2, purple: 0, gold: 0},
            4: {green: 0, blue: 3, purple: 0, gold: 0},
            5: {green: 0, blue: 0, purple: 3, gold: 0},
            6: {green: 0, blue: 0, purple: 5, gold: 0},
            7: {green: 0, blue: 0, purple: 0, gold: 2},
            8: {green: 0, blue: 0, purple: 0, gold: 3},
            9: {green: 0, blue: 0, purple: 0, gold: 6}
        };

        // Weapon breakthrough requirements (cumulative from level 1)
        const weaponRequirements = {
            1: {green: 0, blue: 0, purple: 0, gold: 0},
            40: {green: 6, blue: 0, purple: 0, gold: 0},
            50: {green: 6, blue: 8, purple: 0, gold: 0},
            60: {green: 6, blue: 8, purple: 6, gold: 0},
            70: {green: 6, blue: 8, purple: 6, gold: 8},
            80: {green: 6, blue: 8, purple: 6, gold: 20},
            90: {green: 6, blue: 8, purple: 6, gold: 20}
        };

        // Weapon level mapping for slider
        const weaponLevels = [1, 40, 50, 60, 70, 80, 90];

        // Base talent unlock requirements
        const baseTalentRequirements = {
            green: 0,
            blue: 3,
            purple: 15,
            gold: 12
        };

        // Domain drop rates data
        const domainDropRates = {
            stamina: 40,    // 每場消耗體力
            green: 6.42,    // 平均每場綠色掉落
            blue: 8.00,     // 平均每場藍色掉落
            purple: 1.59,   // 平均每場紫色掉落
            gold: 0.25      // 平均每場金色掉落
        };

        // Verification function for AI self-check
        function verifyRuns(n, requiredGold) {
            const directGold = 0.25 * n;
            const green = 6.42 * n, blue = 8 * n, purple = 1.59 * n;
            const synthBlue = Math.floor(green / 3);
            const synthPurple = Math.floor((blue + synthBlue) / 3);
            const synthGold = Math.floor((purple + synthPurple) / 3);
            return (directGold + synthGold) >= requiredGold;
        }

        // New dynamic domain calculation algorithm
        function calculateDomainRuns(shortageGold, currentMaterials) {
            // 凝素領域固定掉落率
            const DROP_RATES = {
                green: 6.42,
                blue: 8.00,
                purple: 1.59,
                gold: 0.25
            };

            // 計算最小場次（考慮直接掉落+三階合成）
            function calculateMinRuns() {
                let runs = 0;
                while (true) {
                    // 直接獲取
                    const directGold = runs * DROP_RATES.gold;
                    
                    // 合成獲取（完整三階轉換）
                    const synthGold = 
                        Math.floor((
                            (runs * DROP_RATES.purple) + 
                            Math.floor((
                                (runs * DROP_RATES.blue) + 
                                Math.floor((runs * DROP_RATES.green) / 3)
                            ) / 3)
                        ) / 3);
                    
                    if (directGold + synthGold >= shortageGold) {
                        return runs;
                    }
                    runs++;
                }
            }

            // 資源消耗驗證
            function verifyResources(runs) {
                const requiredGreen = Math.ceil(shortageGold / (DROP_RATES.gold + DROP_RATES.green/27));
                return {
                    green: runs * DROP_RATES.green <= currentMaterials.green + requiredGreen,
                    blue: runs * DROP_RATES.blue <= currentMaterials.blue + Math.floor(runs * DROP_RATES.green / 3),
                    purple: runs * DROP_RATES.purple <= currentMaterials.purple + Math.floor(runs * DROP_RATES.blue / 3)
                };
            }

            const minRuns = calculateMinRuns();
            
            // 智能緩衝機制
            let bufferRate = 0.1; // 基礎10%緩衝
            if (shortageGold > 30) {
                bufferRate = 0.15; // 大缺口15%緩衝
            } else if (shortageGold <= 20) {
                bufferRate = 0.08; // 小缺口8%緩衝
            }
            
            const safeRuns = Math.ceil(minRuns * (1 + bufferRate));
            
            // 計算效率指標
            const directGold = minRuns * DROP_RATES.gold;
            const synthGold = Math.floor((
                (minRuns * DROP_RATES.purple) + 
                Math.floor((
                    (minRuns * DROP_RATES.blue) + 
                    Math.floor((minRuns * DROP_RATES.green) / 3)
                ) / 3)
            ) / 3);
            const totalEfficiency = (directGold + synthGold) / minRuns;
            
            return {
                minRuns,
                safeRuns,
                stamina: minRuns * 40,
                resourceCheck: verifyResources(minRuns),
                efficiency: totalEfficiency,
                directGold: directGold,
                synthGold: synthGold,
                totalGold: directGold + synthGold,
                bufferRate: bufferRate
            };
        }

        // Legacy function wrapper for compatibility
        function calculateOptimalDomainRuns(required) {
            // If no gold needed, use simple calculation
            if (required.gold === 0) {
                const greenRuns = required.green > 0 ? Math.ceil(required.green / domainDropRates.green) : 0;
                const blueRuns = required.blue > 0 ? Math.ceil(required.blue / domainDropRates.blue) : 0;
                const purpleRuns = required.purple > 0 ? Math.ceil(required.purple / domainDropRates.purple) : 0;
                const runs = Math.max(greenRuns, blueRuns, purpleRuns);
                
                return {
                    runs: runs,
                    stamina: runs * domainDropRates.stamina,
                    directGold: runs * domainDropRates.gold,
                    synthesisPath: runs > 0 ? "無需金色素材合成" : "無需刷取",
                    totalGold: runs * domainDropRates.gold,
                    synthGold: 0,
                    oldMethodRuns: runs,
                    remaining: {
                        green: Math.max(0, runs * domainDropRates.green - required.green),
                        blue: Math.max(0, runs * domainDropRates.blue - required.blue),
                        purple: Math.max(0, runs * domainDropRates.purple - required.purple)
                    }
                };
            }

            // Use new dynamic algorithm for gold requirements
            const currentMaterials = {
                green: parseInt(document.getElementById('current-green').value) || 0,
                blue: parseInt(document.getElementById('current-blue').value) || 0,
                purple: parseInt(document.getElementById('current-purple').value) || 0,
                gold: parseInt(document.getElementById('current-gold').value) || 0
            };

            const domainResult = calculateDomainRuns(required.gold, currentMaterials);
            
            return {
                runs: domainResult.minRuns,
                safeRuns: domainResult.safeRuns,
                stamina: domainResult.stamina,
                directGold: domainResult.directGold,
                synthGold: domainResult.synthGold,
                totalGold: domainResult.totalGold,
                efficiency: domainResult.efficiency,
                resourceCheck: domainResult.resourceCheck,
                bufferRate: domainResult.bufferRate
            };
        }

        // Initialize sliders and buttons
        function initializeSliders() {
            const sliders = ['skill1', 'skill2', 'skill3', 'skill4', 'skill5'];
            sliders.forEach(id => {
                const slider = document.getElementById(id);
                const valueDisplay = document.getElementById(id + '-value');
                
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value;
                    calculateRequirements();
                });
            });

            // Initialize weapon slider
            const weaponSlider = document.getElementById('weapon');
            const weaponValueDisplay = document.getElementById('weapon-value');
            
            weaponSlider.addEventListener('input', function() {
                const sliderValue = parseInt(this.value);
                const weaponLevel = weaponLevels[sliderValue];
                weaponValueDisplay.textContent = weaponLevel + '級';
                window.currentWeaponLevel = weaponLevel;
                calculateRequirements();
            });

            // Initialize skill level quick buttons
            document.getElementById('skill-level-6').addEventListener('click', function() {
                setAllSkillLevels(6);
            });
            document.getElementById('skill-level-8').addEventListener('click', function() {
                setAllSkillLevels(8);
            });
            document.getElementById('skill-level-10').addEventListener('click', function() {
                setAllSkillLevels(10);
            });

            // Initialize weapon level buttons
            const weaponButtons = document.querySelectorAll('.weapon-level-btn');
            weaponButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const level = parseInt(this.dataset.level);
                    setWeaponLevel(level);
                    
                    // Update button states
                    weaponButtons.forEach(btn => {
                        btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                        btn.classList.add('bg-gray-100', 'border-gray-300');
                    });
                    this.classList.remove('bg-gray-100', 'border-gray-300');
                    this.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                });
            });

            // Initialize current holdings inputs with auto-calculation
            const inputs = ['current-green', 'current-blue', 'current-purple', 'current-gold'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    updateStatusTable();
                    // Auto-trigger calculation after a short delay
                    clearTimeout(window.autoCalculateTimeout);
                    window.autoCalculateTimeout = setTimeout(() => {
                        performCalculation();
                    }, 500);
                });
            });
        }

        // Set all skill levels to a specific value
        function setAllSkillLevels(level) {
            ['skill1', 'skill2', 'skill3', 'skill4', 'skill5'].forEach(id => {
                document.getElementById(id).value = level;
                document.getElementById(id + '-value').textContent = level;
            });
            calculateRequirements();
        }

        // Set weapon level
        function setWeaponLevel(level) {
            const sliderIndex = weaponLevels.indexOf(level);
            if (sliderIndex !== -1) {
                document.getElementById('weapon').value = sliderIndex;
                document.getElementById('weapon-value').textContent = level + '級';
                window.currentWeaponLevel = level;
                calculateRequirements();
            }
        }

        // Calculate total requirements based on current settings
        function calculateRequirements() {
            let totalReq = {
                green: baseTalentRequirements.green,
                blue: baseTalentRequirements.blue,
                purple: baseTalentRequirements.purple,
                gold: baseTalentRequirements.gold
            };

            // Add skill requirements
            for (let i = 1; i <= 5; i++) {
                const level = parseInt(document.getElementById(`skill${i}`).value);
                for (let l = 1; l < level; l++) {
                    if (skillRequirements[l]) {
                        totalReq.green += skillRequirements[l].green;
                        totalReq.blue += skillRequirements[l].blue;
                        totalReq.purple += skillRequirements[l].purple;
                        totalReq.gold += skillRequirements[l].gold;
                    }
                }
            }

            // Add weapon requirements
            const weaponLevel = window.currentWeaponLevel || 1;
            if (weaponRequirements[weaponLevel]) {
                totalReq.green += weaponRequirements[weaponLevel].green;
                totalReq.blue += weaponRequirements[weaponLevel].blue;
                totalReq.purple += weaponRequirements[weaponLevel].purple;
                totalReq.gold += weaponRequirements[weaponLevel].gold;
            }

            // Update display
            document.getElementById('target-green').textContent = totalReq.green;
            document.getElementById('target-blue').textContent = totalReq.blue;
            document.getElementById('target-purple').textContent = totalReq.purple;
            document.getElementById('target-gold').textContent = totalReq.gold;

            updateStatusTable();
            
            // 即時更新合成策略和執行預覽
            performCalculation();
            
            return totalReq;
        }

        // Update status table
        function updateStatusTable() {
            const targets = {
                green: parseInt(document.getElementById('target-green').textContent),
                blue: parseInt(document.getElementById('target-blue').textContent),
                purple: parseInt(document.getElementById('target-purple').textContent),
                gold: parseInt(document.getElementById('target-gold').textContent)
            };

            const current = {
                green: parseInt(document.getElementById('current-green').value) || 0,
                blue: parseInt(document.getElementById('current-blue').value) || 0,
                purple: parseInt(document.getElementById('current-purple').value) || 0,
                gold: parseInt(document.getElementById('current-gold').value) || 0
            };

            const colors = ['green', 'blue', 'purple', 'gold'];
            colors.forEach(color => {
                document.getElementById(`status-target-${color}`).textContent = targets[color];
                document.getElementById(`status-current-${color}`).textContent = current[color];
                
                const diff = current[color] - targets[color];
                const statusEl = document.getElementById(`status-${color}`);
                
                if (diff >= 0) {
                    statusEl.innerHTML = `<span class="status-success">✓ +${diff}</span>`;
                } else {
                    statusEl.innerHTML = `<span class="status-error">✗ ${diff}</span>`;
                }
            });
        }

        // Reverse algorithm calculation
        function calculateOptimalStrategy() {
            const targets = {
                green: parseInt(document.getElementById('target-green').textContent),
                blue: parseInt(document.getElementById('target-blue').textContent),
                purple: parseInt(document.getElementById('target-purple').textContent),
                gold: parseInt(document.getElementById('target-gold').textContent)
            };

            const current = {
                green: parseInt(document.getElementById('current-green').value) || 0,
                blue: parseInt(document.getElementById('current-blue').value) || 0,
                purple: parseInt(document.getElementById('current-purple').value) || 0,
                gold: parseInt(document.getElementById('current-gold').value) || 0
            };

            // Reverse algorithm implementation
            let strategy = [];
            let finalAmounts = {...current};

            // Step 1: Calculate gold deficit and required purple
            const goldDeficit = Math.max(0, targets.gold - current.gold);
            const purpleNeededForGold = goldDeficit * 3;

            // Step 2: Calculate total purple requirement
            const totalPurpleNeeded = targets.purple + purpleNeededForGold;
            const purpleDeficit = Math.max(0, totalPurpleNeeded - current.purple);
            const blueNeededForPurple = purpleDeficit * 3;

            // Step 3: Calculate total blue requirement
            const totalBlueNeeded = targets.blue + blueNeededForPurple;
            const blueDeficit = Math.max(0, totalBlueNeeded - current.blue);
            const greenNeededForBlue = blueDeficit * 3;

            // Step 4: Calculate available green (must preserve target amount)
            const availableGreen = Math.max(0, current.green - targets.green);

            // Step 5: Execute synthesis strategy
            // Green -> Blue synthesis
            const greenToBlueSynthesis = Math.min(Math.floor(availableGreen / 3), blueDeficit);
            if (greenToBlueSynthesis > 0) {
                strategy.push(`綠→藍合成: ${greenToBlueSynthesis} 次 (消耗 ${greenToBlueSynthesis * 3} 綠色 → 獲得 ${greenToBlueSynthesis} 藍色)`);
                finalAmounts.green -= greenToBlueSynthesis * 3;
                finalAmounts.blue += greenToBlueSynthesis;
            }

            // Blue -> Purple synthesis
            const availableBlue = finalAmounts.blue - targets.blue;
            const blueToPurpleSynthesis = Math.min(Math.floor(Math.max(0, availableBlue) / 3), purpleDeficit);
            if (blueToPurpleSynthesis > 0) {
                strategy.push(`藍→紫合成: ${blueToPurpleSynthesis} 次 (消耗 ${blueToPurpleSynthesis * 3} 藍色 → 獲得 ${blueToPurpleSynthesis} 紫色)`);
                finalAmounts.blue -= blueToPurpleSynthesis * 3;
                finalAmounts.purple += blueToPurpleSynthesis;
            }

            // Purple -> Gold synthesis
            const availablePurple = finalAmounts.purple - targets.purple;
            const purpleToGoldSynthesis = Math.min(Math.floor(Math.max(0, availablePurple) / 3), goldDeficit);
            if (purpleToGoldSynthesis > 0) {
                strategy.push(`紫→金合成: ${purpleToGoldSynthesis} 次 (消耗 ${purpleToGoldSynthesis * 3} 紫色 → 獲得 ${purpleToGoldSynthesis} 金色)`);
                finalAmounts.purple -= purpleToGoldSynthesis * 3;
                finalAmounts.gold += purpleToGoldSynthesis;
            }

            return {strategy, finalAmounts, targets, current};
        }

        // Generate detailed report
        function generateReport(calculation) {
            const {strategy, finalAmounts, targets, current} = calculation;
            const now = new Date().toLocaleString('zh-TW');

            let report = `=== 🎯 素材需求精算報告 ===\n\n`;
            
            report += `【基本資訊】\n`;
            report += `⌚ 生成時間: ${now}\n\n`;

            // 資源狀態分析
            report += `【資源狀態】\n`;
            const colors = [
                {name: '🟢 綠色', key: 'green'},
                {name: '🔵 藍色', key: 'blue'},
                {name: '🟣 紫色', key: 'purple'},
                {name: '🟡 金色', key: 'gold'}
            ];

            let achievedItems = [];
            let shortageItems = [];

            colors.forEach(({name, key}) => {
                const currentVal = current[key];
                const targetVal = targets[key];
                const diff = currentVal - targetVal;
                
                if (diff >= 0) {
                    achievedItems.push(`- ${name} ${currentVal}/${targetVal}`);
                } else {
                    shortageItems.push(`- ${name} ${currentVal}/${targetVal} (缺口:${Math.abs(diff)})`);
                }
            });

            if (achievedItems.length > 0) {
                report += `✅ 已達標:\n`;
                achievedItems.forEach(item => report += `${item}\n`);
            }
            
            if (shortageItems.length > 0) {
                report += `⚠️ 需補足:\n`;
                shortageItems.forEach(item => report += `${item}\n`);
            }
            
            if (achievedItems.length === 0 && shortageItems.length === 0) {
                report += `✅ 所有資源已達標\n`;
            }
            report += `\n`;

            // 合成策略
            report += `【合成策略】\n`;
            if (strategy.length === 0) {
                report += `✅ 無需合成，當前資源配置已達標\n\n`;
            } else {
                report += `🔄 三階段資源轉換:\n`;
                strategy.forEach((step, index) => {
                    const stepNum = ['1️⃣', '2️⃣', '3️⃣'][index] || `${index + 1}️⃣`;
                    
                    // 解析合成步驟
                    if (step.includes('綠→藍')) {
                        const matches = step.match(/(\d+) 次.*?(\d+) 綠色.*?(\d+) 藍色/);
                        if (matches) {
                            report += `${stepNum} 綠→藍:\n`;
                            report += `   - 消耗: ${matches[2]}綠\n`;
                            report += `   - 獲得: ${matches[3]}藍\n`;
                        }
                    } else if (step.includes('藍→紫')) {
                        const matches = step.match(/(\d+) 次.*?(\d+) 藍色.*?(\d+) 紫色/);
                        if (matches) {
                            report += `${stepNum} 藍→紫:\n`;
                            report += `   - 消耗: ${matches[2]}藍\n`;
                            report += `   - 獲得: ${matches[3]}紫\n`;
                        }
                    } else if (step.includes('紫→金')) {
                        const matches = step.match(/(\d+) 次.*?(\d+) 紫色.*?(\d+) 金色/);
                        if (matches) {
                            report += `${stepNum} 紫→金:\n`;
                            report += `   - 消耗: ${matches[2]}紫\n`;
                            report += `   - 獲得: ${matches[3]}金\n`;
                        }
                    }
                });
                report += `\n`;
            }

            // 凝素領域精準方案 - 計算合成後的缺口
            const shortages = {
                green: Math.max(0, targets.green - finalAmounts.green),
                blue: Math.max(0, targets.blue - finalAmounts.blue),
                purple: Math.max(0, targets.purple - finalAmounts.purple),
                gold: Math.max(0, targets.gold - finalAmounts.gold)
            };
            
            report += `=== 🎯 凝素領域精準方案 ===\n\n`;
            
            if (shortages.gold === 0 && shortages.purple === 0 && shortages.blue === 0 && shortages.green === 0) {
                report += `✅ 無需刷取凝素領域，當前資源已足夠\n\n`;
            } else if (shortages.gold > 0) {
                // 使用新動態算法計算
                const domainResult = calculateDomainRuns(shortages.gold, current);
                
                // 缺口分析
                report += `【缺口分析】\n`;
                report += `❗ 合成後仍需補足: ${shortages.gold}金\n`;
                
                // 精度控制
                const precision = shortages.gold <= 20 ? 1 : 0;
                const directRate = (0.25).toFixed(2);
                const synthRate = ((domainResult.efficiency - 0.25)).toFixed(2);
                const totalRate = domainResult.efficiency.toFixed(2);
                
                report += `📊 每場獲取率:\n`;
                report += `   - 直接掉落: ${directRate}金\n`;
                report += `   - 合成潛力: ${synthRate}金 (經三階轉換)\n`;
                report += `   - 總效率: ${totalRate}金/場\n`;
                report += `每場等效獲取：${totalRate}金\n\n`;
                
                // 動態場次驗證
                const minRuns = domainResult.minRuns;
                const safeRuns = domainResult.safeRuns;
                const bufferPercent = Math.round(domainResult.bufferRate * 100);
                
                report += `【${minRuns}場實測驗證】\n`;
                report += `✦ 直接獲取: ${(domainResult.directGold).toFixed(precision)}金 (${minRuns}×${directRate})\n`;
                report += `✦ 合成獲取: ${(domainResult.synthGold).toFixed(precision)}金 (完整路徑):\n`;
                
                // 詳細合成路徑
                const greenCollected = (minRuns * 6.42).toFixed(1);
                const synthBlue = Math.floor(minRuns * 6.42 / 3);
                const blueCollected = (minRuns * 8.00).toFixed(1);
                const totalBlue = (minRuns * 8.00 + synthBlue).toFixed(1);
                const synthPurple = Math.floor((minRuns * 8.00 + synthBlue) / 3);
                const purpleCollected = (minRuns * 1.59).toFixed(1);
                const totalPurple = (minRuns * 1.59 + synthPurple).toFixed(1);
                const synthGold = Math.floor((minRuns * 1.59 + synthPurple) / 3);
                
                report += `   1️⃣ 收集${greenCollected}綠 → 合成${synthBlue}藍\n`;
                report += `   2️⃣ 總藍量: ${synthBlue}(合成)+${blueCollected}(掉落)=${totalBlue} → 合成${synthPurple}紫\n`;
                report += `   3️⃣ 總紫量: ${synthPurple}(合成)+${purpleCollected}(掉落)=${totalPurple} → 合成${synthGold}金\n`;
                report += `✓ 總和: ${(domainResult.directGold).toFixed(precision)} + ${(domainResult.synthGold).toFixed(precision)} = ${(domainResult.totalGold).toFixed(precision)}金 ≥ ${shortages.gold}金\n\n`;
                
                // 執行建議
                report += `【執行建議】\n`;
                report += `┌───────────────┬─────────┐\n`;
                report += `│ 精確最小場次       │ ${minRuns}場 (${minRuns * 40}體力) │\n`;
                report += `├───────────────┼─────────┤\n`;
                report += `│ 安全緩衝(${bufferPercent}%)      │ ${safeRuns}場 (${safeRuns * 40}體力) │\n`;
                report += `└───────────────┴─────────┘\n\n`;
                
                // 資源驗證
                report += `【資源驗證】\n`;
                const resourceCheck = domainResult.resourceCheck;
                
                if (resourceCheck.green && resourceCheck.blue && resourceCheck.purple) {
                    report += `✓ 綠色消耗: ${greenCollected} ≤ ${(current.green + minRuns * 6.42).toFixed(1)} (可用)\n`;
                    report += `✓ 藍色平衡: \n`;
                    report += `   - 消耗: ${totalBlue}\n`;
                    report += `   - 來源: ${current.blue}(剩餘) + ${synthBlue}(合成) = ${(current.blue + synthBlue).toFixed(1)} ✔\n`;
                    report += `✓ 紫色平衡:\n`;
                    report += `   - 消耗: ${totalPurple}\n`;
                    report += `   - 來源: ${current.purple}(剩餘) + ${synthPurple}(合成) = ${(current.purple + synthPurple).toFixed(1)} ✔\n\n`;
                } else {
                    report += `❗ 資源驗證不通過:\n`;
                    if (!resourceCheck.green) {
                        report += `   - 綠色不足，需優先刷取綠色至${Math.ceil(minRuns * 6.42 - current.green)}\n`;
                    }
                    if (!resourceCheck.blue) {
                        report += `   - 藍色不足，需優先刷取藍色至${Math.ceil(minRuns * 8.00 - current.blue)}\n`;
                    }
                    if (!resourceCheck.purple) {
                        report += `   - 紫色不足，需優先刷取紫色至${Math.ceil(minRuns * 1.59 - current.purple)}\n`;
                    }
                    report += `\n`;
                }
            } else {
                // 處理其他素材缺口
                report += `【缺口分析】\n`;
                if (shortages.purple > 0) {
                    report += `❗ 合成後仍需補足: ${shortages.purple}紫\n`;
                } else if (shortages.blue > 0) {
                    report += `❗ 合成後仍需補足: ${shortages.blue}藍\n`;
                } else if (shortages.green > 0) {
                    report += `❗ 合成後仍需補足: ${shortages.green}綠\n`;
                }
                
                // 簡化計算非金色素材
                const purpleRuns = shortages.purple > 0 ? Math.ceil(shortages.purple / 1.59) : 0;
                const blueRuns = shortages.blue > 0 ? Math.ceil(shortages.blue / 8.00) : 0;
                const greenRuns = shortages.green > 0 ? Math.ceil(shortages.green / 6.42) : 0;
                const requiredRuns = Math.max(purpleRuns, blueRuns, greenRuns);
                
                if (requiredRuns > 0) {
                    report += `【執行建議】\n`;
                    report += `┌───────────────┬─────────┐\n`;
                    report += `│ 建議場次          │ ${requiredRuns}場 (${requiredRuns * 40}體力) │\n`;
                    report += `└───────────────┴─────────┘\n\n`;
                }
            }

            report += `\n（計算邏輯驗證：⌈缺額/(直接獲取率+合成轉換率)⌉）`;

            return report;
        }

        // Update execution preview - only shows synthesis results, not domain farming
        function updateExecutionPreview(calculation) {
            const {current, targets} = calculation;
            
            // Simulate only the synthesis strategy execution
            let simulatedAmounts = {...current};
            
            // Execute the same synthesis logic as in calculateOptimalStrategy
            const goldDeficit = Math.max(0, targets.gold - current.gold);
            const purpleNeededForGold = goldDeficit * 3;
            const totalPurpleNeeded = targets.purple + purpleNeededForGold;
            const purpleDeficit = Math.max(0, totalPurpleNeeded - current.purple);
            const blueNeededForPurple = purpleDeficit * 3;
            const totalBlueNeeded = targets.blue + blueNeededForPurple;
            const blueDeficit = Math.max(0, totalBlueNeeded - current.blue);
            const availableGreen = Math.max(0, current.green - targets.green);

            // Green -> Blue synthesis
            const greenToBlueSynthesis = Math.min(Math.floor(availableGreen / 3), blueDeficit);
            if (greenToBlueSynthesis > 0) {
                simulatedAmounts.green -= greenToBlueSynthesis * 3;
                simulatedAmounts.blue += greenToBlueSynthesis;
            }

            // Blue -> Purple synthesis
            const availableBlue = simulatedAmounts.blue - targets.blue;
            const blueToPurpleSynthesis = Math.min(Math.floor(Math.max(0, availableBlue) / 3), purpleDeficit);
            if (blueToPurpleSynthesis > 0) {
                simulatedAmounts.blue -= blueToPurpleSynthesis * 3;
                simulatedAmounts.purple += blueToPurpleSynthesis;
            }

            // Purple -> Gold synthesis
            const availablePurple = simulatedAmounts.purple - targets.purple;
            const purpleToGoldSynthesis = Math.min(Math.floor(Math.max(0, availablePurple) / 3), goldDeficit);
            if (purpleToGoldSynthesis > 0) {
                simulatedAmounts.purple -= purpleToGoldSynthesis * 3;
                simulatedAmounts.gold += purpleToGoldSynthesis;
            }
            
            // Update display with synthesis-only results
            const colors = ['green', 'blue', 'purple', 'gold'];
            colors.forEach(color => {
                const final = Math.floor(simulatedAmounts[color]);
                const target = targets[color];
                const diff = final - target;
                
                document.getElementById(`preview-${color}`).textContent = final + ' 個';
                
                if (diff >= 0) {
                    document.getElementById(`preview-${color}-status`).textContent = `✓ 達標 +${diff}`;
                    document.getElementById(`preview-${color}-status`).className = 'text-xs opacity-90 text-green-600';
                } else {
                    document.getElementById(`preview-${color}-status`).textContent = `✗ 不足 ${Math.abs(diff)}`;
                    document.getElementById(`preview-${color}-status`).className = 'text-xs opacity-90 text-red-600';
                }
            });
        }

        // Perform calculation function (used by both auto-calculation and manual trigger)
        function performCalculation() {
            // 檢查是否有持有數量輸入，避免在初始化時顯示錯誤信息
            const hasInput = ['current-green', 'current-blue', 'current-purple', 'current-gold']
                .some(id => parseInt(document.getElementById(id).value) > 0);
            
            if (!hasInput) {
                // 如果沒有輸入持有數量，顯示提示信息
                document.getElementById('strategy-display').innerHTML = '<p class="text-gray-500">輸入持有數量後自動顯示最佳策略</p>';
                document.getElementById('report-content').textContent = '輸入持有數量後自動生成詳細報告...';
                
                // 重置執行預覽
                ['green', 'blue', 'purple', 'gold'].forEach(color => {
                    document.getElementById(`preview-${color}`).textContent = '-';
                    document.getElementById(`preview-${color}-status`).textContent = '-';
                    document.getElementById(`preview-${color}-status`).className = 'text-xs card-content';
                });
                return;
            }

            const calculation = calculateOptimalStrategy();
            const {strategy} = calculation;

            // Update strategy display
            const strategyDisplay = document.getElementById('strategy-display');
            if (strategy.length === 0) {
                strategyDisplay.innerHTML = '<p class="text-green-600 font-semibold">🎉 無需合成，當前資源已經最優配置！</p>';
            } else {
                strategyDisplay.innerHTML = strategy.map(step => 
                    `<div class="bg-blue-50 p-2 rounded border-l-4 border-blue-400">${step}</div>`
                ).join('');
            }

            // Update execution preview
            updateExecutionPreview(calculation);

            // Generate and display report
            const report = generateReport(calculation);
            document.getElementById('report-content').textContent = report;
        }

        // Event listeners
        document.getElementById('max-cultivation-btn').addEventListener('click', function() {
            this.classList.add('pulse-animation');
            setTimeout(() => this.classList.remove('pulse-animation'), 1000);

            // Set all skills to maximum level
            setAllSkillLevels(10);
            
            // Set weapon to maximum level
            setWeaponLevel(90);
            
            // Update weapon button state
            const weaponButtons = document.querySelectorAll('.weapon-level-btn');
            weaponButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-gray-100', 'border-gray-300');
            });
            const maxWeaponBtn = document.querySelector('[data-level="90"]');
            if (maxWeaponBtn) {
                maxWeaponBtn.classList.remove('bg-gray-100', 'border-gray-300');
                maxWeaponBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }
            
            // Recalculate requirements and perform calculation
            calculateRequirements();
            performCalculation();
        });

        document.getElementById('reset-default-btn').addEventListener('click', function() {
            // Reset to character + weapon full requirements
            setAllSkillLevels(10);
            setWeaponLevel(90);
            
            // Update weapon button state
            const weaponButtons = document.querySelectorAll('.weapon-level-btn');
            weaponButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-gray-100', 'border-gray-300');
            });
            const maxWeaponBtn = document.querySelector('[data-level="90"]');
            if (maxWeaponBtn) {
                maxWeaponBtn.classList.remove('bg-gray-100', 'border-gray-300');
                maxWeaponBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }
            
            calculateRequirements();
        });

        document.getElementById('reset-all-btn').addEventListener('click', function() {
            // Reset everything to initial state
            setAllSkillLevels(1);
            setWeaponLevel(1);
            
            // Update weapon button state
            const weaponButtons = document.querySelectorAll('.weapon-level-btn');
            weaponButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-gray-100', 'border-gray-300');
            });
            const firstWeaponBtn = document.querySelector('[data-level="1"]');
            if (firstWeaponBtn) {
                firstWeaponBtn.classList.remove('bg-gray-100', 'border-gray-300');
                firstWeaponBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }
            
            ['current-green', 'current-blue', 'current-purple', 'current-gold'].forEach(id => {
                document.getElementById(id).value = 0;
            });

            document.getElementById('strategy-display').innerHTML = '<p class="text-gray-500">輸入持有數量後自動顯示最佳策略</p>';
            document.getElementById('report-content').textContent = '輸入持有數量後自動生成詳細報告...';
            
            // Reset execution preview
            ['green', 'blue', 'purple', 'gold'].forEach(color => {
                document.getElementById(`preview-${color}`).textContent = '-';
                document.getElementById(`preview-${color}-status`).textContent = '-';
            });
            
            calculateRequirements();
        });

        document.getElementById('copy-report-btn').addEventListener('click', async function() {
            const reportContent = document.getElementById('report-content').textContent;
            
            try {
                await navigator.clipboard.writeText(reportContent);
                
                const originalText = this.textContent;
                this.textContent = '✅ 已複製！';
                this.classList.add('pulse-animation');
                
                setTimeout(() => {
                    this.textContent = originalText;
                    this.classList.remove('pulse-animation');
                }, 2000);
            } catch (err) {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = reportContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const originalText = this.textContent;
                this.textContent = '✅ 已複製！';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
            }
        });

        // Initialize the application
        window.currentWeaponLevel = 1;
        initializeSliders();
        calculateRequirements();
        
        // Set initial weapon button state
        const firstWeaponBtn = document.querySelector('[data-level="1"]');
        if (firstWeaponBtn) {
            firstWeaponBtn.classList.remove('bg-gray-100', 'border-gray-300');
            firstWeaponBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97145c85c72d4a9e',t:'MTc1NTU1MTA0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
